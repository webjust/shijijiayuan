<script type="text/javascript" src="__JS__base.js"></script>
<script src="__PUBLIC__/Lib/jquery/js/jquery.form.js"></script>
<script src="__PUBLIC__/Lib/thinkbox/js/jquery.ThinkBox.min.js"></script>
<link href="__PUBLIC__/Lib/thinkbox/css/style.css" rel="stylesheet">
<script src="__PUBLIC__/Lib/validate/jquery.validate.1.9.js"></script>
<script src="__PUBLIC__/Lib/validate/jquery.metadata.js"></script>
<script src="__PUBLIC__/Lib/validate/messages_cn.js"></script>
<script src="__PUBLIC__/Lib/jquery/js/jquery-webox.js"></script>
<link href="__PUBLIC__/Lib/webox/image/jquery-webox.css" rel="stylesheet">
<div class="wrap bg5ac3f0 clear">
  <div class="content">
    <div id="lgForm" class="lgBox registBox clearfix">
        <img src="{$ad_arr.reg_pic}" width="636" height="407">
      <div class="loginBoxCon">
          <div class="loginBoxMain">
            <h1>用户注册</h1>
              <form method="post" action="{:U('Home/User/doRegister')}" id="regForm"  enctype="multipart/form-data">
            <ul>
                <volist name="ary_extend_data" id="data">
                    <li>
                        <span><if condition="($data.is_need eq 1)">*</if>{$data.field_name}：</span>
                        <if condition="$data.fields_type eq 'radio'">
                            <volist name="data.fields_content" id="field_content">
                                <input  class="iptTxt w276" name="extend_field_{$data.id}" id="extend_field_{$data.id}" type="{$data.fields_type}"  value="{$field_content}" <if condition="($data.is_need eq 1)"> validate="{ required:true}"</if>/>{$field_content}&nbsp;&nbsp;
                            </volist>
                        </if>
                        <if condition="$data.fields_type eq 'checkbox'">
                            <volist name="data.fields_content" id="field_content" >
                                <input class="iptTxt w276" name="extend_field_{$data.id}[]" id="extend_field_{$data.id}[]" type="{$data.fields_type}"  value="{$field_content}" <if condition="($data.is_need eq 1)"> validate="{ required:true}"</if>/>{$field_content}&nbsp;&nbsp;
                            </volist>
                        </if>
                        <if condition="$data.fields_type eq 'select'">
                            <if condition="$data.id eq 14 ">
                                <select id="province" name="province" class="iptTxt city_region_select" style="border: 1px solid #999999;margin: 3px 3px 3px 0;padding: 3px;width: 100px;float:left;" child_id="city" val="{$region['province']}" <if condition="($data.is_need eq 1)"> validate="{ required:true}"</if>>
                                <option value="0" selected="selected">请选择省份</option>
                                </select>
                                <select id="city" name="city" child_id="region1" class="iptTxt city_region_select" style="border: 1px solid #999999;margin: 3px 3px 3px 0;padding: 3px;width: 100px;float:left;" val="{$region['city']}" <if condition="($data.is_need eq 1)"> validate="{ required:true}"</if>>
                                <option value="0" selected="selected">请选择城市</option>
                                </select>
                                <select id="region1" name="region1" child_id="" class="iptTxt city_region_select" style="border: 1px solid #999999;margin: 3px 3px 3px 0;padding: 3px;width: 100px;float:left;" val="{$region['region']}" >
                                    <option value="0" selected="selected">请选择地区</option>
                                </select>
                                <else />
                                <select class="iptTxt" name="extend_field_{$data.id}" >
                                    <volist name="data.fields_content" id="field_content" >
                                        <option value="{$field_content}" <if condition="($data.is_need eq 1)"> validate="{ required:true}"</if>> {$field_content}</option>
                                    </volist>
                                </select>
                            </if>
                        </if>
                        <if condition="$data.fields_type eq 'text'">
                            <input
                            <if condition="($data.type eq 1 )">
                                name="{$data.fields_content}" id="{$data.fields_content}"
                                <else />
                                name="extend_field_{$data.id}" id="extend_field_{$data.id}"
                            </if>
                            <if condition="($data.fields_content eq 'm_password' or $data.fields_content eq 'm_password_1')">
                                type="password"
                                <else />
                                type="text"
                            </if>class="iptTxt w276"
                            <if condition="($data.is_need eq 1)">
                                validate="{ required:true}"
                            </if>
                            <if condition="($data.fields_content eq 'm_recommended' )">
                                value="{$data.content}"
                                <if condition="($data.is_edit eq 0)">
                                    readonly="false"
                                </if>
                                <if condition="($data.is_edit eq 1)">
                                    readonly="true"
                                </if>
                            </if>
                            />
                        </if>
                        <if condition="$data.fields_type eq 'file'">
                            <input name="extend_field_{$data.id}" type="file"  value="{$data.content}" class="iptTxt" <if condition="($data.is_need eq 1)"> validate="{ required:true}"</if> />
                            <input name="extend_field_{$data.id}" type="hidden"  value="{$data.content}" class="iptTxt" />
                        </if>
                        <p class="error"></p>
                    </li>
					<if condition="$data.fields_type eq 'text'">
					<if condition="$data.fields_content eq 'm_mobile'">
					<if condition="$is_mobile_validate eq '1'">
					<li>
					
						<span>手机验证：</span>
						<input class="iptTxt yzm"  type="text" id="m_mobile_code" name="m_mobile_code">
						<input id="btnGetCode" type="button" value="获取验证码" style="width:100px;height:40px"/>
						<p class="error" style="margin-top:5px"></p>
					</li>
					</if>
					</if>
                </if>
                </volist>
				
              <li>
                <span>验证码：</span>
                <input class="iptTxt chkIpt w98"  type="text" name="verify" id="verify">
                <img class="chkImg" id="verifyImg" src="{:U('Home/User/verify')}" height="30">
                <a href="javascript:void()" onclick="changeverify();" class="blue">换一张</a>
                  <p class="error" style="margin-top: 14px;"></p>
              </li>

              <li class="chooseBtn">
                <input type="checkbox" value="1" name="reg_agreement" checked/><a href="javascript:void(0);" class="blue rega">网络注册协议</a>
              </li>

              <li class="subBtn">
                  <notempty name="m_recommended">
                      <input type="hidden" name="m_recommended" value="{$m_recommended}" >
                  </notempty>
                  <input type="hidden" name="MAX_FILE_SIZE" value="3145728">
                <input value="注册" type="submit" class="reg_btn"/>
              </li>
            </ul>
            </form>
          </div>
      </div>
    </div>
  </div>
</div>
<div id="box" style="display:none;">
    <div class="mainlist" style="overflow-x:auto;height:430px;padding:10px;">
        {$content}
    </div>
</div>
<script type="text/javascript">
    var btnGetCode_info = ($("#btnGetCode").val() == undefined)?"-1":$("#btnGetCode").val();
    var wait=90;
    if(btnGetCode_info != '-1'){
        document.getElementById("btnGetCode").disabled = false;
        function time(o) {
            if (wait == 0) {
                o.removeAttribute("disabled");
                o.value="获取验证码";
                wait = 90;
            } else {
                o.setAttribute("disabled", true);
                o.value="重新发送(" + wait + ")";
                wait--;
                setTimeout(function() {
                            time(o)
                        },
                        1000)
            }
        }
        document.getElementById("btnGetCode").onclick=function(){
            document.getElementById("btnGetCode").disabled = true;
            //调用发送验证码接口
            var formdata = $("#regForm").serialize();
            $.ajax({
                url:"{:U('Home/User/sendMobileCode')}",
                data:formdata,
                dataType:"json",
                type:"post",
                success:function(msgObj){
                    if(msgObj.status == 1){
                        time(document.getElementById("btnGetCode"));
                    }else{
                        document.getElementById("btnGetCode").removeAttribute("disabled");
                        alert(msgObj.msg);
                    }
                },
                error:function(){
                    document.getElementById("btnGetCode").removeAttribute("disabled");
                }
            });
        }
    }
</script>
<script type="text/javascript">
     function changeverify(){
        $("#verifyImg").attr("src",'{:U("Home/User/verify")}'+'?r='+Math.random());
     }

     $(document).ready(function(){
         //文档载入完成以后自动加载一级省市区
         loadChildCityRegion(1,'province',$('#province'));
         $(".city_region_select").change(function(){
             $(".city_region_select").attr({'val':''});
             var parent_id = $(this).val();
             var selectDomId = $(this).attr("child_id");
             loadChildCityRegion(parent_id,selectDomId,this);
         });
         $('.rega').click(function(){
             var box_html = $("#box").html();
             $.webox({
                 height:480,
                 width:600,
                 bgvisibel:true,
                 title:'注册协议和隐私政策',
                 html:box_html
             });
         });
         $.metadata.setType("attr", "validate");
         $("#regForm").validate({
                 errorPlacement: function(error, element) {
                     var error_td = element.siblings('p.error');
                     error_td.append(error);
                 },
             submitHandler:function(form){
                 var rand = '{$Think.session.rand}'.toString();
                 var m_password = $("#m_password").val().toString();
                 var new_password = encode64(m_password+rand);
//				$("#m_password").val(new_password);
                 var m_password_confirm = $("#m_password_1").val().toString();
                 var new_password_confirm = encode64(m_password_confirm+rand);
                 $("#m_password_1").val(new_password_confirm);
                 var formdata = $("#regForm").serialize();
                 var ischeck = $("input[type='checkbox']").is(':checked');
                 if(ischeck == true){
                     $.ajax({
                         url:"{:U('Home/User/doRegister')}",
                         dataType:"json",
                         data: formdata,
                         type:"post",
                         success:function(msgObj){
                             if(msgObj.status == 1){
                                 $.ThinkBox.success("注册成功,等待跳转……");
                                 window.location.href = "{$requset_url}";
                             }else{
                                 $("#m_password").val(m_password);
                                 $("#m_password_1").val(m_password_confirm);
                                 $.ThinkBox.error(msgObj.msg);
                                 return false;
                             }
                         },
                         error: function(msg) {
                             $("#m_password").val(m_password);
                             $("#m_password_1").val(m_password_confirm);
                             $.ThinkBox.error(msg);
                             return false;
                         }
                     });
                 }else{
                     alert("请勾选注册协议！");return false;
                 }
             },
             rules : {
                 m_name : {
                     required:true,
                     minlength:4,
                     isCheck:true,
                     remote:'/Home/User/checkName'
                 },
                 m_email : {
                     email:true,
                     remote : '/Home/User/checkEmail'
                 },
                 m_mobile : {
                     isMobile:true,
                     remote : '/Home/User/checkMobile'
                 },
				 <php>if($is_mobile_validate == 1){</php>	
					m_mobile_code : {
						required:true,
						remote : '/Home/User/checkMobileCode'
					},
				<php>}</php>
                 m_password : {
                     required : true,
                     minlength: 6,
                     maxlength: 20
                 },
                 m_password_1 : {
                     required : true,
                     equalTo  : '#m_password'
                 },
                 verify : {
                     required:true,
                     digits:true,
                     rangelength:[4,4],
                     remote:'/Home/User/checkVerify'
                 },
                 m_zipcode : {
                     isZipCode:true
                 },
                 m_telphone : {
                     isPhone:true
                 },
                 m_id_card :{
                     isIDCard:true
                 },
                 m_balance_name :{
                     creditcard: true
                 },
                 m_qq :{
                     digits: true
                 },
                 m_real_name :{
                     username :true
                 },
                 m_security_deposit :{
                     digits: true
                 }
             },
             messages : {
                 m_name : {
                     required : '用户名不能为空',
                     minlength : '用户名不能少于4位',
                     isCheck: '用户名不能包含敏感字符',
                     remote:'该用户名已经存在'
                 },
                 m_email : {
                     required : '邮箱不能为空',
                     remote : '该邮箱已被注册'
                 },
                 m_mobile : {
                     isMobile:'请输入正确的手机号格式',
                 },
				 <php>if($is_mobile_validate == 1){</php>	
					m_mobile_code : {
						required:'手机验证码不能为空'
					},
				<php>}</php>
                 m_password  : {
                     required : '密码不能为空',
                     minlength: '密码长度应在6-20个字符之间',
                     maxlength: '密码长度应在6-20个字符之间'
                 },
                 m_password_1 : {
                     required : '请再次输入您的密码',
                     equalTo  : '两次输入的密码不一致'
                 },
                 verify : {
                     required:'请输入验证码',
                     digits:'请输入正确的验证码',
                     rangelength:'验证码长度为4'
                 }
             }
         });
     });
     function openLoadingBox(){
         $(".loading-box").show();
     }
     function closeLoadingBox(){
         $(".loading-box").hide();
     }
     function loadChildCityRegion(parent_id,selectDomId,clickObj){
         //如果当前选中的行政区ID小于等于0，则表示选择的是“请选择”，将后面的行政区select清楚
         $(clickObj).nextAll("select").hide().empty();
         //如果选中了“请选择”，则不理会。
         if(parent_id <= 0 || "region" == $(clickObj).attr("id")){
             return false;
         }
         //定义异步加载行政区的url
         var load_options_url = "{:U('Home/User/cityRegionOptions')}";
         //ajax异步加载下一级行政区域数据
         $.ajax({
             url:load_options_url,
             data:{parent_id:parent_id},
             beforeSend:openLoadingBox(),
             type:'POST',
             success:function(jsonObj){
                 if(true === jsonObj.status && null !== jsonObj.data){
                     $(clickObj).next("select").show();
                     //select options 元素数据拼接
                     var html_options = '<option value="0" selected="selected">请选择</option>';
                     var next_child_parent = 0;
                     for(var index in jsonObj.data){
                         html_options += '<option value="' + index + '" ';
                         if(index == $(clickObj).attr('val')){
                             html_options += 'selected="selected" ';
                             next_child_parent = index;
                         }
                         html_options += '>' + jsonObj.data[index] + '</option>';
                     }
                     //将拼接的结果追加到DOM中
                     $("#" + selectDomId).html(html_options);
                     //递归加载数据，用于初始化的时候
                     if(next_child_parent > 0){
                         var selectChildDomId = $("#" + selectDomId).attr("child_id");
                         loadChildCityRegion(next_child_parent,selectChildDomId,$("#" + selectChildDomId));
                     }
                     //对空seletet元素进行隐藏操作
                     if($("#province").val() <= 0){
                         $("#province").nextAll("select").hide().empty();
                     }else if($("#city").val() <= 0){
                         $("#city").nextAll("select").hide().empty();
                     }
                 }else{
                     if("region" == $(clickObj).attr("id")){
                         $(clickObj).empty().hide();
                     }else{
                         $(clickObj).next("select").empty().hide();
                     }

                 }
                 closeLoadingBox();
             },
             dataType:'json'
         });
     }
 </script>
