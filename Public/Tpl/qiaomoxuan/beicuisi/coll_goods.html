{__NOLAYOUT__}
<if condition="$this_coll.gname neq ''">
<div class="freeCombination"><!--自由组合   开始-->
    <div class="tabAbp_coll"><!--tabAbp_coll  start-->
        <p><span class="onHover">自由推荐</span><a href="javascript:void(0);"  onclick="checkTeb(this,'next')" nowPage="1" class="xnext pageCollGood"></a><a href="javascript:void(0);" onclick="checkTeb(this,'prev')" nowPage="1" class="spre pageCollGood"></a></p>
    </div><!--tabAbp_coll  end-->
    
    <div class="freeComCon"><!--freeComCon  start-->
        <ul>
            <li id="onHoverCollGoods{$this_coll.gid}" class="onHoverCollGoods">
                <a href="/Home/Products/detail/gid/{$this_coll.gid}" class="proPic"><img src="<php>echo '/'.ltrim($this_coll['gpic'],'/');</php>" width="82" height="82"></a>
                <p><a href="/Home/Products/detail/gid/{$this_coll.gid}" class="proN">{$this_coll.gname}</a></p>
                <!--<p><strong id="collPrice_{$this_coll.gid}">&yen;{$this_coll.gcoll_price|sprintf='%.2f',###}</strong></p>-->
                <input type="hidden" gid="{$this_coll.gid}" name="arrayPdt" id="coll_products_{$this_coll.gid}" <if condition="$this_coll.skuNames neq ''">value=""<else/>value="{$this_coll.pdt_id}"</if> />
                <!--<a href="javascript:void(0);" <if condition="$this_coll.skuNames neq ''"> style="display:none" </if> id="saveColl_{$this_coll.gid}" class="gra onHoverSavePrice">搭配省{$this_coll.save_price|sprintf='%.2f',###}元</a>-->
                <if condition="$this_coll.skuNames neq ''">
                <a href="javascript:void(0);" id="selectColl_{$this_coll.gid}" class="blu onHoverSelectGoods" onclick="selectGoodProducts('{$this_coll.gid}','{$this_coll.authorize}');">选择商品信息</a>
                <p style="display:none" class="onHoverPdtName" id="collPdt_{$this_coll.gid}">规格规格规格规格</p>
                </if>
            </li>
        </ul>
        <ul>
            <volist name="coll_goods" id="goods">
            <switch name="key">
            <case value="0|1|2|3">
            <li>
                <span class="jia" style="margin-top:52px;"></span>
            </li>
            <li id="onHoverCollGoods{$goods.gid}" class="onHoverCollGoods foreachCollGoods" fuck="1">
                <a href="/Home/Products/detail/gid/{$goods.gid}" class="proPic"><img src="<php>echo '/'.ltrim($goods['gpic'],'/');</php>" width="82" height="82"></a>
                <p><input type="checkbox" value=""  <if condition="$goods.skuNames neq ''">onclick="collGoodsClick(this,'{$goods.gid}','{$goods.authorize}');"<else/>onclick="collProductClick(this,'{$goods.gid}','{$goods.pdt_id}','{$goods.authorize}','{$goods.gcoll_price}','{$goods.save_price}');"</if> id="coll_goods_{$goods.gid}" /> <a href="/Home/Products/detail/gid/{$goods.gid}" class="proN">{$goods.gname}</a></p>
                
                <!--<p><input type="checkbox" value=""  <if condition="$goods.skuNames neq ''">onclick="collGoodsClick(this,'{$goods.gid}','{$goods.authorize}');"<else/>onclick="collProductClick(this,'{$goods.gid}','{$goods.pdt_id}','{$goods.authorize}','{$goods.gcoll_price}','{$goods.save_price}');"</if> id="coll_goods_{$goods.gid}" /></p>-->
                <input type="hidden" gid="{$goods.gid}" name="arrayPdt" id="coll_products_{$goods.gid}" value="" />
                <!--<a href="javascript:void(0);" id="saveColl_{$goods.gid}" class="gra onHoverSavePrice">搭配省{$goods.save_price|sprintf='%.2f',###}元</a>-->
                <if condition="$goods.skuNames neq ''">
                <a href="javascript:void(0);"  id="selectColl_{$goods.gid}"  class="blu onHoverSelectGoods" onclick="selectGoodProducts('{$goods.gid}','{$goods.authorize}');">选择商品信息</a>
                <p style="display:none" class="onHoverPdtName" id="collPdt_{$goods.gid}">规格规格规格规格</p>
                </if>
            </li>
            </case>
            <case value="4|5|6|7">
            <li id="onHoverCollGoods{$goods.gid}" class="onHoverCollGoods foreachCollGoods" fuck="2" style="display:none">
                <a href="/Home/Products/detail/gid/{$goods.gid}" class="proPic"><img src="<php>echo '/'.ltrim($goods['gpic'],'/');</php>" width="82" height="82"></a>
                <a href="/Home/Products/detail/gid/{$goods.gid}" class="proN">{$goods.gname}</a>
                
                <p><input type="checkbox" value=""  <if condition="$goods.skuNames neq ''">onclick="collGoodsClick(this,'{$goods.gid}','{$goods.authorize}');"<else/>onclick="collProductClick(this,'{$goods.gid}','{$goods.pdt_id}','{$goods.authorize}','{$goods.gcoll_price}','{$goods.save_price}');"</if> id="coll_goods_{$goods.gid}" /> <strong id="collPrice_{$goods.gid}">&yen;{$goods.gcoll_price|sprintf='%.2f',###}</strong></p>
                <input type="hidden" gid="{$goods.gid}" name="arrayPdt" id="coll_products_{$goods.gid}" value="" />
                <!--<a href="javascript:void(0);" id="saveColl_{$goods.gid}" class="gra onHoverSavePrice">搭配省{$goods.save_price|sprintf='%.2f',###}元</a>-->
                <if condition="$goods.skuNames neq ''">
                <!--<a href="javascript:void(0);"  id="selectColl_{$goods.gid}"  class="blu onHoverSelectGoods" onclick="selectGoodProducts('{$goods.gid}','{$goods.authorize}');">选择商品信息</a>-->
                <p style="display:none" class="onHoverPdtName" id="collPdt_{$goods.gid}">规格规格规格规格</p>
                </if>
            </li>
            </case>
            <case value="8|9|10|11">
            <li id="onHoverCollGoods{$goods.gid}" class="onHoverCollGoods foreachCollGoods" fuck="3" style="display:none">
                <a href="/Home/Products/detail/gid/{$goods.gid}" class="proPic"><img src="<php>echo '/'.ltrim($goods['gpic'],'/');</php>" width="82" height="82"></a>
                <a href="/Home/Products/detail/gid/{$goods.gid}" class="proN">{$goods.gname}</a>
                
                <p><input type="checkbox" value=""  <if condition="$goods.skuNames neq ''">onclick="collGoodsClick(this,'{$goods.gid}','{$goods.authorize}');"<else/>onclick="collProductClick(this,'{$goods.gid}','{$goods.pdt_id}','{$goods.authorize}','{$goods.gcoll_price}','{$goods.save_price}');"</if> id="coll_goods_{$goods.gid}" /> <strong id="collPrice_{$goods.gid}">&yen;{$goods.gcoll_price|sprintf='%.2f',###}</strong></p>
                <input type="hidden" gid="{$goods.gid}" name="arrayPdt" id="coll_products_{$goods.gid}" value="" />
                <!--<a href="javascript:void(0);" id="saveColl_{$goods.gid}" class="gra onHoverSavePrice">搭配省{$goods.save_price|sprintf='%.2f',###}元</a>-->
                <if condition="$goods.skuNames neq ''">
                <!--<a href="javascript:void(0);"  id="selectColl_{$goods.gid}"  class="blu onHoverSelectGoods" onclick="selectGoodProducts('{$goods.gid}','{$goods.authorize}');">选择商品信息</a>-->
                <p style="display:none" class="onHoverPdtName" id="collPdt_{$goods.gid}">规格规格规格规格</p>
                </if>
            </li>
            </case>
            </switch>
            </volist>
        </ul>
        
        <div class="btnd" style="margin-left: 99px;">  
            <span class="deng"></span>
            <!--<a href="javascript:void(0);" onclick="addCart(1);">立即购买套餐</a>-->
            <P>套餐价：<strong id="all_coll_price"><if condition="$this_coll.skuNames neq ''">￥0.00<else/>￥{$this_coll.gcoll_price|sprintf='%.2f',###}</if></strong><span></span><input type="hidden" id="cartNums" value="1" onblur="checkNums(this);"></P>          
            <label id="all_save_price"><if condition="$this_coll.skuNames neq ''">搭配买共省0.00元<else/>搭配买共省{$this_coll.save_price|sprintf='%.2f',###}元</if></label>
            <a href="javascript:void(0);" onclick="addCart();"><image alt="" src="__IMAGES__btn01.jpg"></a>
        </div>
    </div><!--freeComCon  end-->
</div><!--自由组合   结束-->
<input type="hidden" id="fc_id" value="{$fc_id}" />
<script>
var count_teb = "<php>echo count($coll_goods);</php>";
var min_orders = parseInt(Math.ceil(count_teb/4));
function checkTeb(obj,tab){
    $(".foreachCollGoods").hide();
    var nowPage = parseInt($(obj).attr('nowPage'));

    if(tab == 'next' && nowPage != min_orders){
        nowPage = parseInt(nowPage+1);
    }else if(tab == 'next' && nowPage == min_orders){
        nowPage=1;
    }
    if(tab == 'prev' && nowPage == min_orders && nowPage!=1){
        nowPage = parseInt(nowPage-1);
    }else if(tab == 'prev' && nowPage<min_orders && nowPage!=1){
         nowPage = parseInt(nowPage-1);
    }else if(tab == 'prev' && nowPage==1){
        nowPage = min_orders;
    }
    $(".foreachCollGoods[fuck='"+nowPage+"']").slideDown();
    $(".pageCollGood").each(function(){
        $(this).attr('nowPage',nowPage);
    
    });
        
    
    
}
<if condition="$this_coll.skuNames neq ''">
var all_price = 0.00;
var save_price = 0.00;
<else/>
var all_price = "{$this_coll.gcoll_price|sprintf='%.2f',###}";
var save_price = "{$this_coll.save_price|sprintf='%.2f',###}";
</if>
function selectGoodProducts(gid,authorize){
    if(parseInt(gid) <= 0){
        $.ThinkBox.error("商品不存在或者已经被下架");
        return false;
    }
    if(authorize != '1'){
        $.ThinkBox.error("您不能购买该商品");
        return false;
    }
    $.ajax({
        url:'/Home/Products/getAddGoodsCart',
        cache:false,
        dataType:'HTML',
        data:{gid:gid},
        type:"POST",
        success:function(msgObj){
            var box = $.ThinkBox(msgObj, {'title' : '请选择您要的商品信息','width':'448px','drag' : true,'unload':true});
        }
    });

}
$(document).ready(function(){
    $('.onHoverCollGoods').mouseover(function(){
        if($(this).attr('ohgg') == 1){
            $(this).find('.onHoverSelectGoods').show();
            $(this).find('.onHoverPdtName').hide();
        }
        
    });
    $('.onHoverCollGoods').mouseout(function(){
        if($(this).attr('ohgg') == 1){
            $(this).find('.onHoverSelectGoods').hide();
            $(this).find('.onHoverPdtName').show();
        }
    });
});
function collGoodsClick(obj,gid,authorize){
    if($(obj).attr('checked') == 'checked'){
        $(obj).attr('checked',false);
        selectGoodProducts(gid,authorize);
    }else{
        var nums = $('#cartNums').val();
        $(obj).parent().parent().removeAttr('ohgg');
        var gcoll_price = $(obj).attr('price');
        var save = $(obj).attr('save');
        all_price = (parseFloat(all_price)-parseFloat(gcoll_price)).toFixed(2);
        save_price = (nums*(parseFloat(save_price)-parseFloat(save))).toFixed(2);
        $("#coll_products_"+gid).val('');
        $("#all_coll_price").html("￥"+all_price);
        $("#all_save_price").html("搭配买共省"+save_price+"元");
    }
}
function collProductClick(obj,gid,pdt_id,authorize,gcoll_price,save){
    var nums = parseInt($('#cartNums').val());
    if(parseInt(pdt_id) <= 0){
        $.ThinkBox.error("商品不存在或者已经被下架");
        return false;
    }
    if(authorize != '1'){
        $.ThinkBox.error("您不能购买该商品");
        return false;
    }
    if($(obj).attr('checked') == 'checked'){
        $("#onHoverCollGoods"+gid).attr('ohgg',1);
        $("#coll_products_"+gid).val(pdt_id);
    }else{
        $("#onHoverCollGoods"+gid).removeAttr('ohgg');
        $("#coll_products_"+gid).val('');
    }
    if($("#onHoverCollGoods"+gid).attr('ohgg') != 1){
        all_price = (parseFloat(all_price)-parseFloat(gcoll_price)).toFixed(2);
        save_price = (nums*(parseFloat(save_price)-parseFloat(save))).toFixed(2);
    }else{
        all_price = (parseFloat(gcoll_price)+parseFloat(all_price)).toFixed(2);
        save_price = (nums*(parseFloat(save)+parseFloat(save_price))).toFixed(2);
    }
    
    $("#all_coll_price").html("￥"+all_price);
    
    $("#all_save_price").html("搭配买共省"+save_price+"元");
}

function addCart(skip){
    var data = new Object();
    var pdt_id = '';
    var nums = '';
    var gid = '';
    data['fc_id'] = $("#fc_id").val();
    var i = 0;
    var j =0;
    $("input[name='arrayPdt']").each(function(){
        if($(this).val() != ''){
            pdt_id += this.value+',';
            nums += $("#cartNums").val()+',';
            gid += $(this).attr('gid')+',';
            if(parseInt($(this).attr('gid')) == parseInt($("#gid").val())){
                j=1;
            }
            i++;
        }
    });
    if(j!=1){
    
        $.ThinkBox.error("请选择自由搭配第一件商品");return false;
    }
    if(j == 1 && i==1){
        $.ThinkBox.error("请选择自由搭配商品");return false;
    }
    if(skip == '1'){
        data['skip'] = 1;
    }
    data['pdt_id'] = pdt_id.substring(0,pdt_id.length-1);
    data['num'] = nums.substring(0,nums.length-1);
    data['g_id'] = gid.substring(0,gid.length-1);
    $.post('/Home/Cart/doAddFreeCollocation',data,function(dataMsg){
        if(skip == '1' && '{$Think.session.Members.m_name}'!='' && dataMsg.url!=''){
            location.href = dataMsg.url;
        }else{
            ajaxLoadShoppingCart(1);
            $.ThinkBox.success("加入购物车成功");
        }  
    },'json');
    
}
function checkNums(obj){
    var ereg_rule= /[^0-9]+/;
    var nums = obj.value;
    if(nums == ''){return false;}
    if(ereg_rule.test(nums)){
        $(obj).val(1);
        $("#all_coll_price").html('￥'+all_price);
    }else{
        $("#all_save_price").html("搭配买共省"+(parseInt(nums)*parseFloat(save_price)).toFixed(2)+"元");
    }   
}

</script>
</if>