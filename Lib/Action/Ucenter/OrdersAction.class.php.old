<?php

/**
 * 订单相关Action
 *
 * @package Action
 * @subpackage Ucenter
 * @stage 1.0
 * @author Joe
 * @date 2012-12-12
 * @license MIT
 * @copyright Copyright (C) 2012, Shanghai GuanYiSoft Co., Ltd.
 */
class OrdersAction extends CommonAction {

    /**
     * 订单对象
     * 
     * @author Joe <qianyijun@guanyisoft.com>
     * @date 2012-12-17
     */
    private $orders;

    /**
     * 地址对象
     * 
     * @author Joe <qianyijun@guanyisoft.com>
     * @date 2012-12-17
     */
    private $cityRegion;

    /**
     * 订单控制器初始化
     * 
     * @author zuo <zuojianghua@guanyisoft.com>
     * @date 2012-12-13
     */
    public function _initialize() {
        parent::_initialize();
        $this->orders = D('Orders');
        $this->cityRegion = D('CityRegion');
        $this->logistic = D('Logistic');
        $this->cart = D('Cart');
    }

    /**
     * 订单控制器默认页
     * 
     * @author zuo <zuojianghua@guanyisoft.com>
     * @date 2012-12-13
     * @todo 此处需要跳转到快速选货页面
     */
    public function index() {
        $this->getSubNav(2, 0, 40);
        $this->display();
        $this->redirect(U('Ucenter/Orders/pageList'));
    }

    /**
     * 订单数据验证
     *
     * @author zhangjiasuo <zhangjiasuo@guanyisoft.com>
     * @date 2013-04-28
     */
    public function checkOrder($ary_tmp_cart) {
        $ary_member = session("Members");
        $date = date('Y-m-d H:i:s');
        if (!empty($ary_member ['m_id'])) {
            if($ary_tmp_cart){
                $ary_cart = $ary_tmp_cart;
            }else{
                $ary_cart = D('Cart')->GetData();
            }
            // 自由组合商品搭配分开
            $ary_product_ids = array();
            foreach ($ary_cart as $k => $ary_sub) {
                if ($ary_sub ['type'] == '4') {
                    $fc_id = $ary_sub ['fc_id'];
                    // 判断自由组合商品是否存在或是否在有效期
                    $fc_data = M('free_collocation', C('DB_PREFIX'), 'DB_CUSTOM')->where(array(
                                'fc_id' => $fc_id,
                                'fc_status' => 1
                            ))->find();
                    if (empty($fc_data)) {
                        $ary_db_carts = D('Cart')->GetData();
                        unset($ary_db_carts [$k]);
                        D('Cart')->WriteMycart($ary_db_carts);
                        $this->error(L('自由推荐组合已不存在'));
                        return false;
                    }
                    if ($fc_data ['fc_start_time'] != '0000-00-00 00:00:00' && $date < $fc_data ['fc_start_time']) {
                        $this->error(L($value ['g_sn'] . '自由推荐组合活动还没有开始'));
                        return false;
                    }
                    if ($date > $fc_data ['fc_end_time']) {
                        $this->error(L($value ['g_sn'] . '自由推荐组合活动已结束'));
                        return false;
                    }
                    // 判断自由组合商品
                    foreach ($ary_sub ['pdt_id'] as $pid) {
                        $ary_product_ids [] = $pid;
                    }
                } else {
                    $ary_product_ids [] = $k;
                }
            }
            $ary_product_ids = array_unique($ary_product_ids);
            $field = array(
                'fx_goods_products.pdt_stock',
                'fx_goods_products.pdt_id',
                'fx_goods.g_on_sale',
                'fx_goods.g_sn',
                'fx_goods.g_gifts',
                'fx_goods.g_is_combination_goods',
                'fx_goods.g_pre_sale_status',
                'fx_goods_info.is_exchange',
                'fx_goods_info.g_name',
                'fx_goods_info.g_id',
                'fx_goods_products.pdt_sale_price',
                'fx_goods_products.pdt_max_num',
                'fx_goods.g_on_sale_time',
                'fx_goods.g_off_sale_time'
            );
            $where = array(
                'fx_goods_products.pdt_id' => array(
                    'IN',
                    $ary_product_ids
                )
            );
            $data = D("GoodsProducts")->GetProductList($where, $field, $group, $limit);
            foreach ($data as $key => $value) {
                if ($value ['g_on_sale'] != 1) { // 上架
                    $this->error(L($value ['g_sn'] . '下架商品'));
                    exit();
                    return false;
                }
				if($value['g_gifts'] == 1){
					$this->error(L($value ['g_sn'] . '为非销售赠品'));
                    exit();
                    return false;
				}
                if ($ary_cart [$value ['pdt_id']] ['num'] > $value ['pdt_stock'] && !$value ['g_is_combination_goods'] && !$value ['g_pre_sale_status']) { // 购买数量
                    $this->error(L($value ['g_sn'] . '商品库存不足'));
                    return false;
                }
                if ($value ['g_is_combination_goods']) {
                    $tmp_stock = D("GoodsStock")->getProductStockByPdtid($value ['pdt_id']);
                    if ($ary_cart [$value ['pdt_id']] ['num'] > $tmp_stock) {
                        $this->error(L($value ['g_sn'] . '组合商品库存不足'));
                        return false;
                    }
                    if ($ary_cart [$value ['pdt_id']] ['num'] > $value ['pdt_max_num'] && $value ['pdt_max_num'] > 0) {
                        // edit by Joe 组合商品数量超出最大下单数时，当前组合商品购物车情空
                        $ary_db_carts = D('Cart')->GetData();
                        unset($ary_db_carts [$value ['pdt_id']]);
                        D('Cart')->WriteMycart($ary_db_carts);
                        $this->error(L($value ['g_sn'] . '组合商品购买数不能最大于最大下单数'));
                        return false;
                    }
                    if ($value ['g_on_sale_time'] != '0000-00-00 00:00:00' && $date < $value ['g_on_sale_time']) {
                        $this->error(L($value ['g_sn'] . '组合商品活动还没有开始'));
                        return false;
                    }
                    if ($value ['g_off_sale_time'] != '0000-00-00 00:00:00' && $date > $value ['g_off_sale_time']) {
                        $this->error(L($value ['g_sn'] . '组合商品活动结束'));
                        return false;
                    }
                }
                if ($value ['pdt_sale_price'] <= 0 && $ary_cart [$value ['pdt_id']] ['type'] != 1 && $value ['g_gifts'] != 1) { // 价格
                    $this->error(L($value ['g_sn'] . '商品价格不正确'));
                    return false;
                }
                if ($value ['pdt_sale_price'] < 0 && $ary_cart [$value ['pdt_id']] ['type'] == 1 && $value ['g_gifts'] == 1) {
                    $this->error(L($value ['g_sn'] . '商品价格不正确'));
                    return false;
                }
                $is_authorize = D('AuthorizeLine')->isAuthorize($ary_member ['m_id'], $value ['g_id']);
                if (empty($is_authorize)) {
                    $this->error(L($value ['g_name'] . '已不允许购买,请先删除'));
                    return false;
                }
            }
        } else {
            $ary_cart = (session("?Cart")) ? session("Cart") : array();
        }
        if (count($ary_cart) > 50) {
            $this->success(L('CART_MAX_NUM'));
            exit();
        }
        if (empty($ary_cart)) {
            $this->redirect(U('Ucenter/Products/pageList'));
            exit();
        }
        return $ary_cart;
    }

    /**
     * 订单数据验证
     *
     * @author wangguibin <wangguibin@guanyisoft.com>
     * @date 2013-08-16
     */
    public function ajaxCheckOrder() {
        $result = $this->checkOrder();
        if (!empty($result)) {
            $this->success(L('订单数据验证成功'));
            return true;
        } else {
            $this->error(L('订单数据验证失败'));
            return false;
        }
    }

    /**
     * 确认订单页面
     *
     * @author Joe <qianyijun@guanyisoft.com>
     * @date 2012-12-12
     */
    public function pageOrderAdd() {
        $this->getSubNav(2, 0, 30);
        $combo_all_price = 0;
        $free_all_price = 0;
        $fla_pmn_price = 0;
        $ary_member = session("Members");
        $ary_cart = $this->checkOrder();
        $ary_data = array();
        // 获取常用收货地址
        $ary_addr = $this->cityRegion->getReceivingAddress($_SESSION ['Members'] ['m_id']);
        if (count($ary_addr) > 0) {
            $ary_data ['default_addr'] = $ary_addr [0];
            unset($ary_addr [0]);
        }
        $ary_data ['ary_addr'] = $ary_addr;
        // 获取支付方式
        $payment = D('PaymentCfg');
        $payment_cfg = $payment->getPayCfg();
        $ary_data ['payment_cfg'] = $payment_cfg;
        // 获取最后一次支付方式
        // 获取配送公司表
        if (!empty($ary_data ['default_addr']) && is_array($ary_data ['default_addr'])) {
            $ra_is_default = $ary_data ['default_addr'] ['ra_is_default'];
            if ($ra_is_default == 1) {
                $cr_id = $ary_data ['default_addr'] ['cr_id'];
                // dump($cr_id);die();
                $ary_logistic = $this->logistic->getLogistic($cr_id);
            }
        }
        // 获取订单商品列表
        // 货品信息
        if (isset($ary_cart ['gifts'])) {
            $ary_gifts = $ary_cart ['gifts'];
            $cart_gifts_data = $this->cart->getProductInfo($ary_gifts);
            unset($ary_cart ['gifts']);
        }
        $ary_data ['ary_product_data'] = $this->cart->getProductInfo($ary_cart);
        // 商品总重
        $ary_price_data ['all_weight'] = sprintf("%0.2f", D('Orders')->getGoodsAllWeight($ary_cart));
        // 赠品商品总重
        if (!empty($ary_gifts)) {
            $all_gifts_weight = sprintf("%0.2f", D('Orders')->getGoodsAllWeight($ary_gifts));
            $ary_price_data ['all_weight'] += $all_gifts_weight;
        }
        // 购买货品的总价
        $ary_price_data ['all_pdt_price'] = sprintf("%0.2f", $this->cart->getAllPrice($ary_cart));

        if (!empty($ary_data ['ary_product_data']) && is_array($ary_data ['ary_product_data'])) {
            foreach ($ary_data ['ary_product_data'] as $k => $v) {
                // 自由组合商品价格
                if ($v [0] ['type'] == '4') {
                    foreach ($v as $key => $item_info) {
                        $ary_price_data ['all_price'] += $item_info ['pdt_momery'];
                        $free_all_price += $item_info ['pdt_momery'];
                    }
                } else {
                    // 应付的价格（不包括运费）
                    if ($v ['type'] == 0) {
                        $ary_price_data ['all_price'] += sprintf("%0.2f", $v ['pdt_momery']);
                    } elseif ($v ['type'] == 1) {
                        $ary_price_data ['consume_point'] += intval($v ['pdt_momery']); // 消耗总积分
                    } elseif ($v ['type'] == 3) {
                        $ary_price_data ['all_price'] += sprintf("%0.2f", $v ['pdt_momery']);
                        $combo_all_price += sprintf("%0.2f", $v ['pdt_momery']);
                    }
                }
            }
            $ary_price_data ['pre_price'] = sprintf("%0.2f", $ary_price_data ['all_pdt_price'] - $ary_price_data ['all_price']);
        }

        // 订单促销规则
        $ary_promotion = array();

        foreach ($ary_data ['ary_product_data'] as $key => &$info) {
            // 过滤掉自由组合
            if (!isset($info [0] ['pdt_id'])) {
                if (!empty($info ['rule_info'] ['pmn_id']) && empty($ary_pdt_info ['rule_info'] ['pmn_id'])) {
                    $ary_pdt_info ['rule_info'] = $info ['rule_info'];
                }
                if ($info ['type'] != 3) {
                    $info ['pdt_rule_name'] = $info ['rule_info'] ['name'];
                    $ary_pdt_info [$info ['pdt_id']] = array(
                        'pdt_id' => $info ['pdt_id'],
                        'num' => $info ['pdt_nums'],
                        'type' => $info ['type'],
                        'price' => $info ['f_price']
                    );
                }
            }
        }
        $ary_param = array(
            'action' => 'order',
            'mid' => $ary_member ['m_id'],
            'all_price' => $ary_price_data ['all_price'] - $combo_all_price - $free_all_price,
            'ary_pdt' => $ary_pdt_info
        );
        $orders_discount = D('Price')->getOrderPrice($ary_param);
        if ($orders_discount ['all_price'] > 0 && !empty($orders_discount ['code'])) {
            $promition_rule_name = $orders_discount ['name'];
            // 促销优惠价格
            if (!empty($ary_price_data ['pre_price'])) { // 组合商品优惠金额
                $fla_pmn_price = $ary_price_data ['pre_price'];
            }
            if ($orders_discount ['code'] == 'MBAOYOU') {
                $ary_price_data ['total_price'] = $ary_price_data ['all_price'];
            } elseif ($orders_discount ['code'] == 'MZENPIN' || $orders_discount ['code'] == 'MQUAN') {
                $fla_pmn_price += $orders_discount ['price'];
                $ary_price_data ['total_price'] = $ary_price_data ['all_pdt_price'] - $fla_pmn_price;
            } else {
                $fla_pmn_price += $orders_discount ['all_price'] - $orders_discount ['price'];
                $ary_price_data ['total_price'] = sprintf("%0.2f", $ary_price_data ['all_pdt_price'] - $fla_pmn_price);
            }
        } else {
            $fla_pmn_price += $ary_price_data ['all_pdt_price'] - $ary_price_data ['all_price'];
            $ary_price_data ['total_price'] = $ary_price_data ['all_price'];
        }
        // 发票信息
        $p_invoice = D('Invoice')->get();
        $invoice_type = explode(",", $p_invoice ['invoice_type']);
        $invoice_head = explode(",", $p_invoice ['invoice_head']);
        $invoice_content = explode(",", $p_invoice ['invoice_content']);

        $invoice_info ['invoice_comom'] = $invoice_type [0];
        $invoice_info ['invoice_special'] = $invoice_type [1];

        $invoice_info ['invoice_personal'] = $invoice_head [0];
        $invoice_info ['invoice_unit'] = $invoice_head [1];
        $invoice_info ['is_invoice'] = $p_invoice ['is_invoice'];
        $invoice_info ['is_auto_verify'] = $p_invoice ['is_auto_verify'];
        // 发票收藏列表
        $invoice_list = D('InvoiceCollect')->get($ary_member ['m_id']);

        // 优惠的价格
        $ary_price_data ['pre_price'] = sprintf("%0.2f", $ary_price_data ['all_pdt_price'] - $ary_price_data ['all_price']);
        // 获得赠送积分
        $ary_price_data ['reward_point'] = D('PointConfig')->getrRewardPoint($ary_price_data ['all_pdt_price']);
        // 添加产品是否允许购买
        $is_authorize = true;

        foreach ($ary_data ['ary_product_data'] as &$prod) {
            if ($prod [0] ['type'] == '4') {
                foreach ($prod as &$item_info) {
                    $item_info ['authorize'] = D('AuthorizeLine')->isAuthorize($ary_member ['m_id'], $item_info ['g_id']);
                    if ($item_info ['authorize'] == false) {
                        $is_authorize = false;
                    }
                }
            } else {
                $prod ['authorize'] = D('AuthorizeLine')->isAuthorize($ary_member ['m_id'], $prod ['g_id']);
                if ($prod ['authorize'] == false) {
                    $is_authorize = false;
                }
            }
        }
        $this->assign("is_authorize", $is_authorize);
        $this->assign("ary_product", $ary_data ['ary_product_data']);
        // 赠品
        $this->assign("gifts_data", $cart_gifts_data);

        $this->assign("price_data", $ary_price_data);
        // 页面输出
        $this->assign('ary_addr', $ary_data ['ary_addr']);
        $this->assign('default_addr', $ary_data ['default_addr']);
        // echo "<pre>";print_r($ary_logistic);exit;
        // 配送公司
        $this->assign('ary_logistic', $ary_logistic);
        // 支付方式
        $this->assign('ary_paymentcfg', $ary_data ['payment_cfg']);
        // 订单实付金额
        // 发票信息
        $this->assign('invoice_info', $invoice_info);
        $this->assign('invoice_content', $invoice_content);

        // 发票收藏列表
        $this->assign('invoice_list', $invoice_list);
        // 促销优惠价
        $this->assign('fla_pmn_price', $fla_pmn_price);
        // 订单锁定
        $ary_erp = D('SysConfig')->getCfgByModule('GY_ERP_API');
        $this->assign('order_lock', $ary_erp ['ORDER_LOCK']);
        $ary_order_time = D('SysConfig')->getCfgByModule('ORDERS_TIME');
        $this->assign('order_time', $ary_order_time ['ORDERS_TIME']);
        // 订单促销规则名称
        $this->assign("promition_rule_name", $promition_rule_name);
        $this->display();
    }

    /**
     * 确认订单页面
     *
     * @author wangguibin <Wangguibin@guanyisoft.com>
     * @date 2013-10-09
     * @modify by wanghaoyu //添加是否显示发货选择
     */
    public function pageAdd() {
    
        $this->getSubNav(1, 0, 30);
        $combo_all_price = 0;
        $free_all_price = 0;
        $fla_pmn_price = 0;
        $ary_member = session("Members");
        $ary_tmp_cart = D('Cart')->GetData();
        $pids = $this->_post('pid');
        if(empty($pids) && !isset($pids)){
            $this->error('请选择购物车商品！');
        }else{
            foreach ($ary_tmp_cart as $key=>$cd){
                foreach ($pids as $pid){
                    if($pid == $key){
                        $checkOrder[$pid] = $ary_tmp_cart[$key];
                    }
                }
            }
        }
        $ary_cart = $this->checkOrder($checkOrder);
        $ary_tmp_cart = $ary_cart;
        $ary_data = array();
        // 获取常用收货地址
        $ary_addr = $this->cityRegion->getReceivingAddress($_SESSION ['Members'] ['m_id']);
        if (count($ary_addr) > 0) {
            $ary_data ['default_addr'] = $ary_addr [0];
            unset($ary_addr [0]);
        }
        $ary_data ['ary_addr'] = $ary_addr;
        // 获取支付方式
        $payment = D('PaymentCfg');
        $payment_cfg = $payment->getPayCfg();
        $ary_data ['payment_cfg'] = $payment_cfg;
        // 获取最后一次支付方式
        // 获取配送公司表
        
        //echo "<pre>";print_r($ary_logistic);exit;
        // 获取订单商品列表
        // 货品信息
        if (isset($ary_cart ['gifts'])) {
            $ary_gifts = $ary_cart ['gifts'];
            $cart_gifts_data = $this->cart->getProductInfo($ary_gifts);
            unset($ary_cart ['gifts']);
        }
        if (!empty($ary_cart) && is_array($ary_cart)) {
            foreach ($ary_cart as &$val) {
                if ($val['type'] == '0') {
                    $ary_gid = M("goods_products", C('DB_PREFIX'), 'DB_CUSTOM')->field('g_id')->where(array('pdt_id' => $val['pdt_id']))->find();
                    $val['g_id'] = $ary_gid['g_id'];
                }
            }
        }
        $pro_datas = D('Promotion')->calShopCartPro($ary_member ['m_id'], $ary_cart);
        $subtotal = $pro_datas['subtotal']; //促销金额
        //剔除商品价格信息
        unset($pro_datas['subtotal']);
        // 商品总重
        $ary_price_data ['all_weight'] = sprintf("%0.2f", D('Orders')->getGoodsAllWeight($ary_cart));
        
        // 购买货品的总价
        $ary_price_data ['all_pdt_price'] = sprintf("%0.2f", $subtotal['goods_total_sale_price']);
        $ary_data ['ary_product_data'] = $this->cart->getProductInfo($ary_cart, $ary_price_data['all_pdt_price']);
        // 订单促销规则
        $ary_promotion = array();
        //$promition_rule_name
        // 发票信息
        $p_invoice = D('Invoice')->get();
        $invoice_type = explode(",", $p_invoice ['invoice_type']);
        $invoice_head = explode(",", $p_invoice ['invoice_head']);
        $invoice_content = explode(",", $p_invoice ['invoice_content']);

        $invoice_info ['invoice_comom'] = $invoice_type [0];
        $invoice_info ['invoice_special'] = $invoice_type [1];

        $invoice_info ['invoice_personal'] = $invoice_head [0];
        $invoice_info ['invoice_unit'] = $invoice_head [1];
        $invoice_info ['is_invoice'] = $p_invoice ['is_invoice'];
        $invoice_info ['is_auto_verify'] = $p_invoice ['is_auto_verify'];
        // 发票收藏列表
        $invoice_list = D('InvoiceCollect')->get($ary_member ['m_id']);
        // 获得赠送积分
        $ary_price_data ['reward_point'] = D('PointConfig')->getrRewardPoint($ary_price_data ['all_pdt_price']);
        // 添加产品是否允许购买
        $is_authorize = true;

        foreach ($ary_data ['ary_product_data'] as &$prod) {
            if ($prod [0] ['type'] == '4') {
                foreach ($prod as &$item_info) {
                    $item_info ['authorize'] = D('AuthorizeLine')->isAuthorize($ary_member ['m_id'], $item_info ['g_id']);
                    if ($item_info ['authorize'] == false) {
                        $is_authorize = false;
                    }
                }
            } else {
                $prod ['authorize'] = D('AuthorizeLine')->isAuthorize($ary_member ['m_id'], $prod ['g_id']);
                if ($prod ['authorize'] == false) {
                    $is_authorize = false;
                }
            }
        }
        $ary_cart = array();
        foreach ($ary_data ['ary_product_data'] as $key => $info) {
            if (isset($info['pdt_id'])) {
                $ary_cart[$info['pdt_id']] = $info;
                //添加产品是否允许购买
                $ary_cart[$info['pdt_id']]['authorize'] = D('AuthorizeLine')->isAuthorize($ary_member['m_id'], $info['g_id']);
            } else {
                //自由组合权限判断
                if ($info[0]['type'] == 4 || $info[0]['type'] == 6) {
                    foreach ($info as $subkey => $sub_info) {
                        $ary_cart[$key][$sub_info['pdt_id']] = $sub_info;
                        //添加产品是否允许购买
                        $ary_cart[$key][$sub_info['pdt_id']]['authorize'] = D('AuthorizeLine')->isAuthorize($ary_member['m_id'], $sub_info['g_id']);
                    }
                }
            }
        }
        $promotion_total_price = '0';
        $promotion_price = '0';
        //赠品数组
        $cart_gifts = array();
        foreach ($pro_datas as $keys => $vals) {
            foreach ($vals ['products'] as $key => $val) {
                $arr_products = $this->cart->getProductInfo(array(
                    $key => $val
                        ));
                if ($arr_products [0] [0] ['type'] == '4' || $arr_products [0] [0] ['type'] == '6') {
                    foreach ($arr_products [0] as &$provals) {
                        $provals ['authorize'] = D('AuthorizeLine')->isAuthorize($ary_member ['m_id'], $provals ['g_id']);
                    }
                }
                $pro_datas [$keys] ['products'] [$key] = $arr_products [0];
                $pro_data [$key] = $val;
                $pro_data [$key] ['pmn_name'] = $vals ['pmn_name'];
            }
            //赠品数组
            if (!empty($vals['gifts'])) {
                foreach ($vals['gifts'] as $gifts) {
                    //随机取一个pdt_id
                    $pdt_id = D("GoodsProducts")->Search(array('g_id' => $gifts['g_id'], 'pdt_stock' => array('GT', 0)), 'pdt_id');
                    $cart_gifts[$pdt_id['pdt_id']] = array('pdt_id' => $pdt_id['pdt_id'], 'num' => 1, 'type' => 2);
                }
            }
            $promotion_total_price += $vals ['goods_total_price']; // 商品总价
            if ($keys != '0') {
                $promotion_price += $vals ['pro_goods_discount'];
            }
        }
        
        //获取赠品信息
        if (!empty($cart_gifts)) {
            $cart_gifts_data = array();
            $cart_gifts_data = $this->cart->getProductInfo($cart_gifts);
            $ary_tmp_cart = array_merge($ary_tmp_cart,$cart_gifts);
            foreach($ary_tmp_cart as $atck=>$atcv){
                $ary_tmp_cart[$atcv['pdt_id']] = $atcv;
                unset($ary_tmp_cart[$atck]);
            }
            $all_gifts_weight = sprintf("%0.2f", D('Orders')->getGoodsAllWeight(array('gifts'=>$cart_gifts)));
            $ary_price_data ['all_weight'] += $all_gifts_weight;
        }
        // 满足满包邮条件
        foreach ($pro_datas as $pro_data) {
            if ($pro_data ['pmn_class'] == 'MBAOYOU') {
                foreach($pro_data['products'] as $proDatK=>$proDatV){
                    unset($ary_tmp_cart[$proDatK]);
                }
            }
        }
        if (!empty($ary_data ['default_addr']) && is_array($ary_data ['default_addr'])) {
            $ra_is_default = $ary_data ['default_addr'] ['ra_is_default'];
            if ($ra_is_default == 1) {
                $cr_id = $ary_data ['default_addr'] ['cr_id'];
                $ary_logistic = $this->logistic->getLogistic($cr_id,$ary_tmp_cart);
            }
        }//echo "<pre>";print_r($ary_logistic);die();
        //更新会员等级
        D("MembersLevel")->autoUpgrade($ary_member ['m_id']);
        $ary_price_data['all_pdt_price'] = sprintf("%0.2f", $promotion_total_price);
        $ary_price_data ['pre_price'] = sprintf("%0.2f", $promotion_price);
        $ary_price_data ['total_price'] = sprintf("%0.2f", $promotion_total_price - $promotion_price) > 0 ? sprintf("%0.2f", $promotion_total_price - $promotion_price) : '0.00';
        //需消耗总积分
        $ary_price_data['consume_point'] = intval($subtotal['goods_all_point']);
        $this->assign("is_authorize", $is_authorize);
        $this->assign("cart_data", $ary_cart);
        $this->assign("promotion", $pro_datas);
        // 赠品
        $this->assign("gifts_data", $cart_gifts_data);
        $this->assign("price_data", $ary_price_data);
        
        //dump($ary_price_data);die();
        // 页面输出
        $this->assign('ary_addr', $ary_data ['ary_addr']);
        $this->assign('default_addr', $ary_data ['default_addr']);
        // 配送公司
        $this->assign('ary_logistic', $ary_logistic);
        // 支付方式
        $this->assign('ary_paymentcfg', $ary_data ['payment_cfg']);
        // 发票信息
        $this->assign('invoice_info', $invoice_info);
        $this->assign('invoice_content', $invoice_content);
        // 发票收藏列表
        $this->assign('invoice_list', $invoice_list);
        // 促销优惠价
        $this->assign('fla_pmn_price', $ary_price_data['pre_price']);
        // 订单锁定
        $ary_erp = D('SysConfig')->getCfgByModule('GY_ERP_API');
        $this->assign('order_lock', $ary_erp ['ORDER_LOCK']);
        $ary_order_time = D('SysConfig')->getCfgByModule('ORDERS_TIME');
        $this->assign('order_time', $ary_order_time ['ORDERS_TIME']);
        $ary_is_show = D('SysConfig')->getCfgByModule('IS_SHOW');
        $this->assign('is_show', $ary_is_show['IS_SHOW']);
       
        
        $str_pids = '';
        foreach ($this->_post('pid') as $pid){
            $str_pids .= $pid.',';
        }
        $str_pids = trim($str_pids,',');
        $this->assign('pids',$str_pids);
        // 订单促销规则名称
        $this->assign("promition_rule_name", $promition_rule_name);
        $this->display('pageAdd');
    }

    /**
	 * 团购订单确认页
	 */
	public function pageBulkAdd() {
		
		$param_bulk = $_SESSION ['bulk_cart'];
		
		if (empty ( $param_bulk )) {
			$this->error ( '请选择团购商品！' );
		} // print_r($param_bulk);exit;
		  // unset($_SESSION['bulk_cart']);
		$groupbuy = M ( 'groupbuy', C ( 'DB_PREFIX' ), 'DB_CUSTOM' );
		$gp_price = M ( 'related_groupbuy_price', C ( 'DB_PREFIX' ), 'DB_CUSTOM' );
		$gp_city = M ( 'related_groupbuy_area', C ( 'DB_PREFIX' ), 'DB_CUSTOM' );
		$ary_data = array ();
		// 获取常用收货地址
		$ary_addr = $this->cityRegion->getReceivingAddress ( $_SESSION ['Members'] ['m_id'] );
		if (count ( $ary_addr ) > 0) {
			$ary_data ['default_addr'] = $ary_addr [0];
			unset ( $ary_addr [0] );
		}
		$ary_data ['ary_addr'] = $ary_addr;
		// 获取支付方式
		$payment = D ( 'PaymentCfg' );
		$payment_cfg = $payment->getPayCfg ();
		$ary_data ['payment_cfg'] = $payment_cfg;
		// 发票信息
		$p_invoice = D ( 'Invoice' )->get ();
		
		$invoice_type = explode ( ",", $p_invoice ['invoice_type'] );
		$invoice_head = explode ( ",", $p_invoice ['invoice_head'] );
		$invoice_content = explode ( ",", $p_invoice ['invoice_content'] );
		
		$invoice_info ['invoice_comom'] = $invoice_type [0];
		$invoice_info ['invoice_special'] = $invoice_type [1];
		
		$invoice_info ['invoice_personal'] = $invoice_head [0];
		$invoice_info ['invoice_unit'] = $invoice_head [1];
		$invoice_info ['is_invoice'] = $p_invoice ['is_invoice'];
		$invoice_info ['is_auto_verify'] = $p_invoice ['is_auto_verify'];
		// 发票收藏列表
		$invoice_list = D ( 'InvoiceCollect' )->get ( $_SESSION ['Members'] ['m_id'] );
		
		// 获取最后一次支付方式
            
		
		$array_where = array (
				'is_active' => 1,
				'gp_id' => $param_bulk ['gp_id'] 
		);
		$data = $groupbuy->where ( $array_where )->find ();
		if (empty ( $data )) {
			$this->error ( '团购商品不存在！' );
		}
		$data['cust_price'] = M('goods_info')->where(array('g_id'=>$data['g_id']))->getField('g_price');
		// 取出价格阶级
		$rel_bulk_price = $gp_price->where(array('gp_id'=>$data['gp_id']))->select();
		$buy_nums = $data['gp_pre_number'] + $data['gp_now_number'];
		$array_f = array ();
		foreach ( $rel_bulk_price as $rbp_k => $rbp_v ) {
			if ($buy_nums >= $rbp_v ['rgp_num']) {
				$array_f[$rbp_v ['related_price_id']] = $rbp_v ['rgp_num'];
			}
		}
       
		if (! empty ( $array_f )) {
			$array_max = new ArrayMax ($array_f);
			$rgp_num = $array_max->arrayMax ();
			$data['gp_price'] = $gp_price->where(array('gp_id'=>$data['gp_id'],'rgp_num'=>$rgp_num))->getField('rgp_price');
		}//echo "<pre>";print_r($data);die();
		// 获取商品基本信息
		$field = 'g_id as gid,g_name as gname,g_price as gprice,g_stock as gstock,g_picture as gpic';
		$goods_info = D('GoodsInfo')->field($field)->where (array('g_id' => $data ['g_id']))->find();
		$goods_info ['gpic'] = '/'.ltrim($goods_info['gpic'],'/');
		$goods_info ['save_price'] = $goods_info ['gprice'] - $data ['gp_price'];
		// 授权线判断是否允许购买
		$goods_info ['authorize'] = true;
		if (! empty ( $goods_info ) && is_array ( $goods_info )) {
			$ary_product_feild = array (
					'pdt_sn',
					'pdt_weight',
					'pdt_stock',
					'pdt_memo',
					'pdt_id',
					'pdt_sale_price',
					'pdt_market_price',
					'pdt_on_way_stock' 
			);
			$where = array ();
			$where ['g_id'] = $data ['g_id'];
			$where ['pdt_status'] = '1';
			$ary_pdt = M ( 'goods_products ', C ( 'DB_PREFIX' ), 'DB_CUSTOM' )->field ( $ary_product_feild )->where ( $where )->limit ()->select ();
			if (! empty ( $ary_pdt ) && is_array ( $ary_pdt )) {
				$skus = array ();
				$ary_zhgoods = array ();
				foreach ( $ary_pdt as $kypdt => $valpdt ) {
					$specInfo = D ( 'GoodsSpec' )->getProductsSpecs ( $valpdt ['pdt_id'] );
					
					$ary_pdt [$kypdt] ['specName'] = $specInfo ['spec_name'];
					
					$ary_pdt [$kypdt] ['pdt_sale_price'] = sprintf ( '%.2f', $valpdt ['pdt_sale_price'] );
					$ary_pdt [$kypdt] ['pdt_market_price'] = sprintf ( '%.2f', $valpdt ['pdt_market_price'] );
					if ($param_bulk ['pdt_id'] == $valpdt ['pdt_id']) {
						$data ['sku'] = $ary_pdt [$kypdt];
					}
				
				}
				foreach ( $skus as $key => &$sku ) {
					$skus [$key] = array_unique ( $sku );
				}
			
			}
			if (! empty ( $skus )) {
				$goods_info ['skuNames'] = $skus;
			} else {
				$goods_info ['pdt_id'] = $ary_pdt [0] ['pdt_id'];
			}
		}
		$goods_info ['skus'] = $ary_pdt;
		
		$data ['sku'] ['num'] = $param_bulk ['num'];
		$data ['sku'] ['coupon_price'] = $data ['sku'] ['pdt_sale_price'] - $data ['gp_price'];
		$data ['sku'] ['all_cprice'] = $data ['sku'] ['coupon_price'] * $param_bulk ['num'];
		$data ['sku'] ['all_price'] = $data ['gp_price'] * $param_bulk ['num'];
		$data ['sku'] ['all_sale_price'] = $data ['sku'] ['pdt_sale_price'] * $param_bulk ['num'];
		
		$data ['sku'] ['all_weight'] = $data ['sku'] ['pdt_weight'] * $param_bulk ['num'];
		
		$data ['good_info'] = $goods_info;
		if ($data ['is_deposit'] == 1) {
			$data ['gp_deposit_price'] = sprintf ( '%.2f', $data ['gp_deposit_price'] * $data ['sku'] ['num'] );
		}
		
		$i = 0;
		foreach ( $ary_logistic as $logustic_key => $logustic_val ) {
			if ($i == 0) {
				$ary_cart [$data ['sku'] ['pdt_id']] = array (
						'pdt_id' => $data ['sku'] ['pdt_id'],
						'num' => $data ['sku'] ['num'],
						'type' => 0 
				);
				$logistic_price = D ( 'Logistic' )->getLogisticPrice ( $logustic_val ['lt_id'], $ary_cart );
			}
			$i ++;
		}
        
        $ary_cart [$data ['sku'] ['pdt_id']] = array(
                    'pdt_id' => $data ['sku'] ['pdt_id'],
                    'num' => $data ['sku'] ['num'],
                    'type' => 0,
                    'g_id'=>$data['g_id'],
                );
        // 获取配送公司表
        if (!empty($ary_data ['default_addr']) && is_array($ary_data ['default_addr'])) {
            $ra_is_default = $ary_data ['default_addr'] ['ra_is_default'];
            if ($ra_is_default == 1) {
                $cr_id = $ary_data ['default_addr'] ['cr_id'];
                $ary_logistic = $this->logistic->getLogistic($cr_id,$ary_cart);
            }
        }
        
        
		$data ['sku'] ['bulk_price'] = $data ['sku'] ['all_price'];
		$data ['sku'] ['all_price'] += $logistic_price;
		// echo "<pre>";print_r($data);exit;
		$this->assign ( 'product_data', $data );
		$this->assign ( 'ary_addr', $ary_data ['ary_addr'] );
		$this->assign ( 'default_addr', $ary_data ['default_addr'] );
		// 支付方式
		$this->assign ( 'ary_paymentcfg', $ary_data ['payment_cfg'] );
		// 配送公司
		$this->assign ( 'ary_logistic', $ary_logistic );
		// 发票收藏列表
		$this->assign ( 'invoice_list', $invoice_list );
		// 发票信息
		$this->assign ( 'invoice_info', $invoice_info );
		$this->assign ( 'invoice_content', $invoice_content );
        /*标明这个是团购订单确认页*/
        $this->assign ( 'web_type', 'Bulk' );
		$this->display ();
	}

   
    
   
    /**
     * 显示常用地址页面
     * 删除，添加 地址页面 这里显示
     */
    public function getAddressPage() {
        $bool_return = false;
        $ary_post_data = $this->_post();
        $m_id = $_SESSION ['Members'] ['m_id'];
        if (isset($ary_post_data ['del']) || $ary_post_data ['del'] == 'del') {
            // 删除
            $int_ra_id = $ary_post_data ['ra_id'];
            $bool_return = $this->cityRegion->doDelDeliver($int_ra_id);
        } else {
            // 添加
            if ($ary_post_data ['cr_id'] == 0) {
                if(empty($ary_post_data['region'])){
                   $ary_post_data['region']=$ary_post_data['city'];
                }
                $ary_post_data ['cr_id'] = $ary_post_data ['region'];
            }
            $ary_post_data ['ra_phone'] = $ary_post_data ['ra_phone_area'] . '-' . $ary_post_data ['ra_phone'] . '-' . $ary_post_data ['ra_phone_ext'];
            $bool_return = $this->cityRegion->addReceiveAddr($ary_post_data, $m_id);
            $int_ra_id = $bool_return ['data'] ['ra_id'];
        }

        if ($bool_return) {
            $ary_return ['status'] = 1;
            $ary_addr = $this->cityRegion->getReceivingAddress($_SESSION ['Members'] ['m_id']);
            if (!empty($ary_addr)) {
                if (isset($ary_post_data ['del']) || $ary_post_data ['del'] == 'del') {
                    $ary_return ['data'] = $ary_addr [0];
                    $ary_return ['msg'] = '删除成功';
                    $ary_return ['num'] = count($ary_addr);
                } else {
                    foreach ($ary_addr as $val) {
                        if ($val ['ra_id'] == $int_ra_id) {
                            $ary_return ['data'] = $val;
                            $ary_return ['msg'] = '添加成功';
                            $ary_return ['num'] = count($ary_addr);
                            break;
                        }
                    }
                }
            }
            $this->ajaxReturn($ary_return);
        }
    }
    /**
     * 配送方式页面
     */
    public function getLogisticType() {
        $cr_id = $this->_post('cr_id');
        $goods_pids = $this->_post('pids');
        $ary_member = session("Members");
        if (!empty($ary_member ['m_id'])) {
            $cart_data = D('Cart')->GetData();
            $ary_pid = explode(',',$goods_pids);
            foreach ($cart_data as $key=>$cd){
                foreach ($ary_pid as $pid){
                    if($pid == $key){
                        $ary_cart[$pid] = $cart_data[$key];
                    }
                }
            }
        } else {
            $ary_cart = (session("?Cart")) ? session("Cart") : array();
        }
        $ary_tmp_cart = $ary_cart;
        if (!empty($ary_cart) && is_array($ary_cart)) {
            foreach ($ary_cart as $key => $val) {
                if ($val['type'] == '0') {
                    $ary_gid = M("goods_products", C('DB_PREFIX'), 'DB_CUSTOM')->field('g_id')->where(array('pdt_id' => $val['pdt_id']))->find();
                    $ary_cart[$key]['g_id'] = $ary_gid['g_id'];
                }
            }
        }
        $pro_datas = D('Promotion')->calShopCartPro($ary_member ['m_id'], $ary_cart);
        //赠品数组
        $gifts_cart = array();
        foreach ($pro_datas as $keys => $vals) {
            //赠品数组
            if (!empty($vals['gifts'])) {
                foreach ($vals['gifts'] as $gifts) {
                    //随机取一个pdt_id
                    $pdt_id = D("GoodsProducts")->Search(array('g_id' => $gifts['g_id'], 'pdt_stock' => array('GT', 0)), 'pdt_id');
                    $gifts_cart[$pdt_id['pdt_id']] = array('pdt_id' => $pdt_id['pdt_id'], 'num' => 1, 'type' => 2,'g_id' => $gifts['g_id']);
                }
            }
        }
        if(!empty($gifts_cart)){
            $ary_tmp_cart = array_merge($ary_cart,$gifts_cart);
            foreach($ary_tmp_cart as $atck=>$atcv){
                $ary_tmp_cart[$atcv['pdt_id']] = $atcv;
                unset($ary_tmp_cart[$atck]);
            }
        }
        foreach ($pro_datas as $pro_data) {
            if ($pro_data ['pmn_class'] == 'MBAOYOU') {
                foreach($pro_data['products'] as $proDatK=>$proDatV){
                    unset($ary_tmp_cart[$proDatK]);
                }
            }
        }
        $ary_logistic = $this->logistic->getLogistic($cr_id,$ary_tmp_cart);
        $this->assign('ary_logistic', $ary_logistic);
        $this->display();
    }

    /**
     * 订单确认信息提交
     */
    public function doOrderAdd() {
        $return_orders = false;
        $combo_all_price = 0;
        $free_all_price = 0;
        $ary_orders = $this->_post();
        $ary_member = session("Members");
        if (!empty($ary_member ['m_id'])) {
            if (isset($ary_orders ['gp_id'])) {
                // 团购商品
                $ary_cart [$ary_orders ['pdt_id']] = array(
                    'pdt_id' => $ary_orders ['pdt_id'],
                    'num' => $ary_orders ['num'],
                    'gp_id' => $ary_orders ['gp_id'],
                    'type' => 5
                );
            } else {
                $ary_cart = D('Cart')->GetData();
            }
        } else {
            $ary_cart = (session("?Cart")) ? session("Cart") : array();
        }
        foreach ($ary_cart as $ary) {
            // 自由推荐商品
            if ($ary ['type'] == 4) {
                foreach ($ary ['pdt_id'] as $pdtId) {
                    $g_id = D("GoodsProducts")->where(array(
                                'pdt_id' => $pdtId
                            ))->getField('g_id');
                    $is_authorize = D('AuthorizeLine')->isAuthorize($ary_member ['m_id'], $g_id);
                    if (empty($is_authorize)) {
                        $this->error('部分商品已不允许购买,请先在购物车里删除这些商品', array(
                            '返回购物车' => U('Ucenter/Cart/pageList')
                        ));
                        exit();
                    }
                }
            } else {
                $g_id = D("GoodsProducts")->where(array(
                            'pdt_id' => $ary ['pdt_id']
                        ))->getField('g_id');
                $is_authorize = D('AuthorizeLine')->isAuthorize($ary_member ['m_id'], $g_id);
                if (empty($is_authorize)) {
                    $this->error('部分商品已不允许购买,请先在购物车里删除这些商品', array(
                        '返回购物车' => U('Ucenter/Cart/pageList')
                    ));
                    exit();
                }
            }
        }
        $orders = M('orders', C('DB_PREFIX'), 'DB_CUSTOM');
        // echo "<pre>";print_r($ary_orders['no_invoices']);exit;
        $orders->startTrans();
        if (!empty($ary_orders) && is_array($ary_orders)) {
            if (!empty($ary_orders ['invoices_val']) && $ary_orders ['invoices_val'] == "1") {
                if (isset($ary_orders ['invoice_type']) && isset($ary_orders ['invoice_head'])) {
                    $ary_orders ['is_invoice'] = 1;
                    if ($ary_orders ['invoice_type'] == 2) {
                        // 如果为增值税发票，发票抬头默认为单位
                        $ary_orders ['invoice_head'] = 2;
                    } else {
                        if ($ary_orders ['invoice_head'] == 2) {
                            // 如果发票类型为普通发票，并且发票抬头为单位，将个人姓名删除
                            unset($ary_orders ['invoice_people']);
                        }
                        if ($ary_orders ['invoice_head'] == 1) {
                            // 如果发票类型为普通发票，并且发票抬头为个人，将单位删除
                            unset($ary_orders ['invoice_name']);
                        }
                    }
                    if (empty($ary_orders ['invoice_name'])) {
                        $ary_orders ['invoice_name'] = '个人';
                    } else {
                        $ary_orders ['invoice_name'] = $ary_orders ['invoice_name'];
                    }
                    if (isset($ary_orders ['invoice_content'])) {
                        $ary_orders ['invoice_content'] = $ary_orders ['invoice_content'];
                    }
                } else {

                    if (isset($ary_orders ['is_default']) && !empty($ary_orders ['is_default'])) {

                        $res_invoice = D('InvoiceCollect')->getid($ary_orders ['is_default']);

                        if (!empty($res_invoice)) {
                            $ary_orders ['is_invoice'] = 1;
                            $ary_orders ['invoice_type'] = $res_invoice ['invoice_type'];
                            $ary_orders ['invoice_head'] = $res_invoice ['invoice_head'];
                            $ary_orders ['invoice_people'] = $res_invoice ['invoice_people'];
                            if (empty($res_invoice ['invoice_name'])) {
                                $ary_orders ['invoice_name'] = '个人';
                            } else {
                                $ary_orders ['invoice_name'] = $res_invoice ['invoice_name'];
                            }
                            $ary_orders ['invoice_content'] = $res_invoice ['invoice_content'];
                            // 如果是增值税发票，添加增值税发票信息

                            if ($ary_orders ['invoice_type'] == 2) {
                                // 纳税人识别号
                                $ary_orders ['invoice_identification_number'] = $res_invoice ['invoice_identification_number'];
                                // 注册地址
                                $ary_orders ['invoice_address'] = $res_invoice ['invoice_address'];
                                // 注册电话
                                $ary_orders ['invoice_phone'] = $res_invoice ['invoice_phone'];
                                // 开户银行
                                $ary_orders ['invoice_bank'] = $res_invoice ['invoice_bank'];
                                // 银行帐户
                                $ary_orders ['invoice_account'] = $res_invoice ['invoice_account'];
                            }
                        }
                    }
                    // 添加增值税发票
                    if (!empty($ary_orders ['in_id'])) {

                        $ary_res = M('InvoiceCollect', C('DB_PREFIX'), 'DB_CUSTOM')->where(array(
                                    "id" => $ary_orders ['in_id']
                                ))->find();
                        $ary_orders ['invoice_type'] = $ary_res ['invoice_type'];
                        $ary_orders ['invoice_head'] = $ary_res ['invoice_head'];
                        // echo "<pre>";print_r($ary_res);exit;
                        $ary_orders ['is_invoice'] = 1;
                        if (empty($ary_res ['invoice_name'])) {
                            $ary_orders ['invoice_name'] = '个人';
                        } else {
                            $ary_orders ['invoice_name'] = $ary_orders ['invoice_name'];
                        }
                        // 个人姓名
                        $ary_orders ['invoice_people'] = $ary_orders ['invoice_people'];
                        // 纳税人识别号
                        $ary_orders ['invoice_identification_number'] = $ary_orders ['invoice_identification_number'];
                        // 注册地址
                        $ary_orders ['invoice_address'] = $ary_orders ['invoice_address'];
                        // 注册电话
                        $ary_orders ['invoice_phone'] = $ary_orders ['invoice_phone'];
                        // 开户银行
                        $ary_orders ['invoice_bank'] = $ary_orders ['invoice_bank'];
                        // 银行帐户
                        $ary_orders ['invoice_account'] = $ary_orders ['invoice_account'];
                        $ary_orders ['invoice_content'] = $ary_res ['invoice_content'];
                    }
                }
            } else {
                unset($ary_orders ['invoice_type']);
                unset($ary_orders ['invoice_head']);
                unset($ary_orders ['invoice_people']);
                unset($ary_orders ['invoice_name']);
                unset($ary_orders ['invoice_content']);
                unset($ary_orders ['invoices_val']);
            }
            // echo "<pre>";print_r($ary_orders);exit;
            $ary_receive_address = $this->cityRegion->getReceivingAddress($ary_member ['m_id']);
            foreach ($ary_receive_address as $ara_k=>$ara_v){
                if($ara_v['ra_id'] == $ary_orders['ra_id']){
                    $default_address ['default_addr'] = $ara_v;
                }
            }
            if (isset($default_address ['default_addr'] ['ra_id'])) {
                // 收货人
                $ary_orders ['o_receiver_name'] = $default_address ['default_addr'] ['ra_name'];
                // 收货人电话
                $ary_orders ['o_receiver_telphone'] = trim($default_address ['default_addr'] ['ra_phone']);
                // 收货人手机
                $ary_orders ['o_receiver_mobile'] = $default_address ['default_addr'] ['ra_mobile_phone'];
                // 收货人邮编
                $ary_orders ['o_receiver_zipcode'] = $default_address ['default_addr'] ['ra_post_code'];
                // 收货人地址
                $ary_orders ['o_receiver_address'] = $default_address ['default_addr'] ['ra_detail'];
                $ary_city_data = $this->cityRegion->getFullAddressId($default_address ['default_addr'] ['cr_id']);

                // 收货人省份
                $ary_orders ['o_receiver_state'] = $this->cityRegion->getAddressName($ary_city_data [1]);

                // 收货人城市
                $ary_orders ['o_receiver_city'] = $this->cityRegion->getAddressName($ary_city_data [2]);

                // 收货人地区
                $ary_orders ['o_receiver_county'] = $this->cityRegion->getAddressName($ary_city_data [3]);
            }

            // 会员id
            $ary_orders ['m_id'] = $ary_member ['m_id'];
            // 订单id
            $ary_orders ['o_id'] = $order_id = date('YmdHis') . rand(1000, 9999);
            // 物流费用
            if (!empty($default_address ['default_addr']) && is_array($default_address ['default_addr'])) {
                $ra_is_default = $default_address ['default_addr'] ['ra_is_default'];
                if ($ra_is_default == 1) {
                    $cr_id = $default_address ['default_addr'] ['cr_id'];
                    $ary_logistic = $this->logistic->getLogistic($cr_id);
                    foreach ($ary_logistic as $logistic) {
                        $logistic_price = 0;
                        if ($logistic ['lt_id'] == $ary_orders ['lt_id']) {
                            $logistic_price = $logistic ['logistic_price'];
                            break;
                        }
                    }
                }
            }
            $ary_orders ['o_cost_freight'] = $logistic_price;
            if (empty($ary_orders ['lt_id'])) {
                $this->success(L('SELECT_LOGISTIC'));
                exit();
            }

            // 商品总价
            $ary_orders ['o_goods_all_price'] = 0;
            $m_id = $_SESSION ['Members'] ['m_id'];
            $price = new PriceModel($m_id);
            if (!empty($ary_cart) && is_array($ary_cart)) {
                foreach ($ary_cart as $k => $v) {
                    // 自由组合
                    if ($v ['type'] == 4) {
                        foreach ($v ['pdt_id'] as $key => $pdt_id) {
                            // 自由推荐价格
                            $ary_orders ['o_goods_all_price'] += sprintf("%0.3f", $v ['num'] [$key] * $price->getItemPrice($pdt_id, 0, 4));
                            $free_all_price += sprintf("%0.3f", $v ['num'] [$key] * $price->getItemPrice($pdt_id, 0, 4));
                        }
                    } else if ($v ['type'] == 5) {
                        // 获取团购价与商品原价
                        $array_all_price = $price->getItemPrice($ary_orders ['pdt_id'], 0, 5, $ary_orders ['gp_id']);
                        $ary_orders ['o_goods_all_price'] = sprintf("%0.3f", $v ['num'] [$key] * $array_all_price ['pdt_price']);
                        $o_all_price = sprintf("%0.3f", $v ['num'] [$key] * $array_all_price ['discount_price']);
                        $ary_orders ['o_discount'] = sprintf("%0.3f", $ary_orders ['o_goods_all_price'] - $o_all_price);
                    } else {
                        if ($k == 'gifts') {
                            $ary_orders ['o_goods_all_price'] += 0;
                            $gifts_cart = $v;
                            unset($ary_cart [$k]);
                        } elseif ($v ['type'] == 3) {
                            $ary_orders ['o_goods_all_price'] += sprintf("%0.3f", $v ['num'] * $price->getItemPrice($k));
                            $combo_all_price += sprintf("%0.3f", $v ['num'] * $price->getItemPrice($k));
                        } else {
                            if (!isset($v ['type']) || $v ['type'] == 0) {
                                $ary_orders ['o_goods_all_price'] += sprintf("%0.3f", $v ['num'] * $price->getItemPrice($k));
                            }
                        }
                    }
                }
            }
            $ary_data ['ary_product_data'] = $this->cart->getProductInfo($ary_cart);
            // 优惠券金额
            if (isset($ary_orders ['coupon_input'])) {
                $str_csn = $ary_orders ['coupon_input'];
                $ary_coupon = D('Coupon')->CheckCoupon($str_csn, $ary_data ['ary_product_data']);
                if (!empty($ary_coupon) && is_array($ary_coupon)) {
                    $ary_orders ['o_coupon_menoy'] = $ary_coupon ['c_money'];
                    $all_goods_price = $ary_orders ['o_goods_all_price'] + $ary_coupon ['c_money'];
                }
            }
            // 整单促销规则
            foreach ($ary_data ['ary_product_data'] as $info) {
                if ($info [0] ['type'] != '4') {
                    if (!empty($info ['rule_info'] ['pmn_id']) && empty($ary_pdt_info ['rule_info'] ['pmn_id'])) {
                        $ary_pdt_info ['rule_info'] = $info ['rule_info'];
                    }
                    if ($info ['type'] != 3) {
                        $ary_pdt_info [$info ['pdt_id']] = array(
                            'pdt_id' => $info ['pdt_id'],
                            'rule_info' => $info ['rule_info'],
                            'num' => $info ['pdt_nums'],
                            'type' => $info ['type'],
                            'price' => $info ['f_price']
                        );
                    }
                }
            }

            $ary_param = array(
                'action' => 'order',
                'mid' => $ary_member ['m_id'],
                'all_price' => $ary_orders ['o_goods_all_price'] - $combo_all_price - $free_all_price,
                'ary_pdt' => $ary_pdt_info
            );
            $orders_discount = D('Price')->getOrderPrice($ary_param);

            $promotion_price = 0;
            if ($orders_discount ['all_price'] > 0 && !empty($orders_discount ['code'])) {
                // 促销优惠价格
                if ($orders_discount ['code'] == 'MBAOYOU' || $orders_discount ['code'] == 'MZENPIN' || $orders_discount ['code'] == 'MQUAN') {
                    if ($orders_discount ['code'] == 'MBAOYOU' && $logistic_price < $orders_discount ['price']) {
                        $fla_pmn_price = sprintf("%0.2f", $logistic_price);
                    } else {
                        $fla_pmn_price = sprintf("%0.2f", $orders_discount ['price']);
                    }
                } else {
                    $fla_pmn_price = sprintf("%0.2f", $orders_discount ['all_price'] - $orders_discount ['price']);
                    // 获取满减后优惠金额
                    if ($orders_discount ['code'] == 'MJIAN') {
                        $ary_orders ['o_promotion_price'] = sprintf("%0.2f", $fla_pmn_price - $logistic_price);
                    }
                }
                $ary_orders ['o_goods_all_price'] = sprintf("%0.2f", $orders_discount ['all_price'] - $fla_pmn_price);
            } else {
                // $ary_orders['o_goods_all_price'] =
                // sprintf("%0.2f",$orders_discount['all_price']) ;
            }
            // 订单总价 商品会员折扣价-优惠券金额
            if (!isset($ary_orders ['gp_id'])) {
                $all_price = $ary_orders ['o_goods_all_price'] - $ary_orders ['o_coupon_menoy'] - $promotion_price;
            } else {
                $all_price = $ary_orders ['o_goods_all_price'] - $ary_orders ['o_discount'] - $promotion_price;
            }

            if ($all_price <= 0) {
                $all_price = 0;
            }
            // 订单应付总价 订单总价+运费
            $all_price += $ary_orders ['o_cost_freight'];

            $ary_orders ['o_all_price'] = sprintf("%0.3f", $all_price);

            $ary_orders ['o_buyer_comments'] = $ary_orders ['o_buyer_comments'];
            // 是否预售单
            if (isset($ary_orders ['g_pre_sale_status']) && $ary_orders ['g_pre_sale_status'] == 1) {
                $ary_orders ['o_pre_sale'] = 1;
            }
            if (empty($ary_orders ['o_receiver_county'])) { // 没有区时
                unset($ary_orders ['o_receiver_county']);
            }
            if (!isset($ary_orders ['gp_id'])) {
                $ary_orders ['o_discount'] = sprintf("%0.3f", $ary_orders ['goods_all_price'] - $ary_orders ['o_goods_all_price']);
            }
            // 发货备注
            if (!empty($ary_orders ['shipping_remarks'])) {
                $ary_orders ['o_shipping_remarks'] = $ary_orders ['shipping_remarks'];
                unset($ary_orders ['shipping_remarks']);
            }
            $ary_orders_goods = $this->cart->getProductInfo($ary_cart);
            // print_r($ary_orders);exit;
            // 管理员操作者ID
            if ($ary_member ['admin_id']) {
                $ary_orders ['o_addorder_id'] = $ary_member ['admin_id'];
            }
            $bool_orders = D('Orders')->doInsert($ary_orders);
            // $bool_orders = true;
            if (!$bool_orders) {
                $orders->rollback();
                $this->error('失败', array(
                    '失败' => U('Ucenter/Orders/OrderFail')
                ));
                exit();
            } else {
                if (isset($ary_coupon ['c_sn'])) {
                    // 更新优惠券使用
                    $ary_data = array(
                        'c_is_use' => 1,
                        'c_used_id' => $_SESSION ['Members'] ['m_id'],
                        'c_order_id' => $ary_orders ['o_id']
                    );
                    $res_coupon = D('Coupon')->doCouponUpdate($ary_coupon ['c_sn'], $ary_data);

                    if (!$res_coupon) {
                        $this->error('失败', array(
                            '失败' => U('Ucenter/Orders/OrderFail')
                        ));
                        exit();
                    }
                } // exit;
                $ary_orders_items = array();

                $ary_orders_goods = $this->cart->getProductInfo($ary_cart);
                // print_r($ary_orders_goods);exit;
                if (!empty($gifts_cart)) {
                    $ary_gifts_goods = $this->cart->getProductInfo($gifts_cart);
                    if (!empty($ary_gifts_goods)) {
                        foreach ($ary_gifts_goods as $gift) {
                            array_push($ary_orders_goods, $gift);
                        }
                    }
                }
                if (!empty($ary_orders_goods) && is_array($ary_orders_goods)) {
                    $total_consume_point = 0; // 消耗积分
                    $int_pdt_sale_price = 0; // 货品销售原价总和
                    foreach ($ary_orders_goods as $k => $v) {
                        $ary_orders_items = array();
                        if ($v ['type'] == 3) {
                            $combo_list = D('ReletedCombinationGoods')->getComboList($v ['pdt_id']);
                            if (!empty($combo_list)) {
                                foreach ($combo_list as $combo) {
                                    // 订单id
                                    $ary_orders_items ['o_id'] = $ary_orders ['o_id'];
                                    // 商品id
                                    $combo_item_data = D('GoodsProducts')->Search(array(
                                        'pdt_id' => $combo ['releted_pdt_id']
                                            ), array(
                                        'g_sn',
                                        'g_id'
                                            ));
                                    $ary_orders_items ['g_id'] = $combo_item_data ['g_id'];
                                    // 组合商品ID
                                    $ary_orders_items ['fc_id'] = $v ['pdt_id'];
                                    // 货品id
                                    $ary_orders_items ['pdt_id'] = $combo ['releted_pdt_id'];
                                    // 类型id
                                    $ary_orders_items ['gt_id'] = $combo ['gt_id'];
                                    // 商品sn
                                    $ary_orders_items ['g_sn'] = $combo_item_data ['g_sn'];
                                    // 货品sn
                                    $ary_orders_items ['pdt_sn'] = $combo ['pdt_sn'];
                                    // 商品名字
                                    $combo_good_data = D('GoodsInfo')->Search(array(
                                        'g_id' => $combo_item_data ['g_id']
                                            ), array(
                                        'g_name'
                                            ));
                                    $ary_orders_items ['oi_g_name'] = $combo_good_data ['g_name'];
                                    // 成本价
                                    $ary_orders_items ['oi_cost_price'] = $combo ['pdt_cost_price'];
                                    // 货品销售原价
                                    $ary_orders_items ['pdt_sale_price'] = $combo ['pdt_sale_price'];
                                    // 购买单价
                                    $ary_orders_items ['oi_price'] = $combo ['com_price'];
                                    // 组合商品
                                    $ary_orders_items ['oi_type'] = 3;

                                    $int_pdt_sale_price += $combo ['com_price'] * $combo ['com_nums'];

                                    // 商品数量
                                    $ary_orders_items ['oi_nums'] = $combo ['com_nums'] * $v ['pdt_nums'];
                                    $bool_orders_items = D('Orders')->doInsertOrdersItems($ary_orders_items);
                                    if (!$bool_orders_items) {
                                        $orders->rollback();
                                        $this->error('失败', array(
                                            '失败' => U('Ucenter/Orders/OrderFail')
                                        ));
                                        exit();
                                    }
                                    // 商品库存扣除
                                    $ary_payment_where = array(
                                        'pc_id' => $ary_orders ['o_payment']
                                    );
                                    $ary_payment = D('PaymentCfg')->getPayCfgId($ary_payment_where);
                                    if ($ary_payment ['pc_abbreviation'] == 'DELIVERY' || $ary_payment ['pc_abbreviation'] == 'OFFLINE') {
                                        // by Mithern 扣除可下单库存生成库存调整单
                                        $good_sale_status = D('Goods')->field(array(
                                                    'g_pre_sale_status'
                                                ))->where(array(
                                                    'g_id' => $ary_orders_items ['g_id']
                                                ))->find();
                                        if ($good_sale_status ['g_pre_sale_status'] != 1) { // 如果是预售商品不扣库存
                                            $array_result = D('GoodsProducts')->UpdateStock($combo ['releted_pdt_id'], $ary_orders_items ['oi_nums']);
                                            if (false == $array_result ["status"]) {
                                                D('GoodsProducts')->rollback();
                                                $this->error($array_result ['msg'] . ',CODE:' . $array_result ["code"]);
                                            }
                                        }
                                    }
                                }
                            }
                        } else {

                            // 自由推荐商品
                            if ($v [0] ['type'] == '4') {
                                foreach ($v as $key => $item_info) {

                                    // 订单id
                                    $ary_orders_items ['o_id'] = $ary_orders ['o_id'];
                                    // 商品id
                                    $ary_orders_items ['g_id'] = $item_info ['g_id'];
                                    // 货品id
                                    $ary_orders_items ['pdt_id'] = $item_info ['pdt_id'];
                                    // 类型id
                                    $ary_orders_items ['gt_id'] = $item_info ['gt_id'];
                                    // 商品sn
                                    $ary_orders_items ['g_sn'] = $item_info ['g_sn'];
                                    // o_sn
                                    // $ary_orders_items['g_id'] = $v['g_id'];
                                    // 货品sn
                                    $ary_orders_items ['pdt_sn'] = $item_info ['pdt_sn'];
                                    // 商品名字
                                    $ary_orders_items ['oi_g_name'] = $item_info ['g_name'];
                                    // 成本价
                                    $ary_orders_items ['oi_cost_price'] = $item_info ['pdt_cost_price'];
                                    // 货品销售原价
                                    $ary_orders_items ['pdt_sale_price'] = $item_info ['pdt_sale_price'];
                                    // 购买单价
                                    $ary_orders_items ['oi_price'] = $item_info ['pdt_momery'];
                                    // 自由组合ID
                                    $ary_orders_items ['fc_id'] = $item_info ['fc_id'];
                                    // 商品积分
                                    if (isset($v [0] ['type']) && $v [0] ['type'] == 4) {
                                        $ary_orders_items ['oi_type'] = 4;
                                        $int_pdt_sale_price += $item_info ['pdt_sale_price'] * $item_info ['pdt_nums'];
                                    }
                                    // 商品数量
                                    $ary_orders_items ['oi_nums'] = $item_info ['pdt_nums'];
                                    $bool_orders_items = D('Orders')->doInsertOrdersItems($ary_orders_items);
                                    if (!$bool_orders_items) {
                                        $orders->rollback();
                                        $this->error('失败', array(
                                            '失败' => U('Ucenter/Orders/OrderFail')
                                        ));
                                        exit();
                                    }
                                    // 商品库存扣除
                                    $ary_payment_where = array(
                                        'pc_id' => $ary_orders ['o_payment']
                                    );
                                    $ary_payment = D('PaymentCfg')->getPayCfgId($ary_payment_where);
                                    if ($ary_payment ['pc_abbreviation'] == 'DELIVERY' || $ary_payment ['pc_abbreviation'] == 'OFFLINE') {
                                        // by Mithern 扣除可下单库存生成库存调整单
                                        $good_sale_status = D('Goods')->field(array(
                                                    'g_pre_sale_status'
                                                ))->where(array(
                                                    'g_id' => $item_info ['g_id']
                                                ))->find();
                                        if ($good_sale_status ['g_pre_sale_status'] != 1) { // 如果是预售商品不扣库存
                                            $array_result = D('GoodsProducts')->UpdateStock($ary_orders_items ['pdt_id'], $item_info ['pdt_nums']);
                                            if (false == $array_result ["status"]) {
                                                D('GoodsProducts')->rollback();
                                                $this->error($array_result ['msg'] . ',CODE:' . $array_result ["code"]);
                                            }
                                        }
                                    }
                                }
                            } elseif ($v ['type'] == '5') { // 团购商品
                                // 订单id
                                $ary_orders_items ['o_id'] = $ary_orders ['o_id'];
                                // 商品id
                                $ary_orders_items ['g_id'] = $v ['g_id'];
                                // 团购商品ID,取一下
                                $fc_id = M('groupbuy', C('DB_PREFIX'), 'DB_CUSTOM')->where(array(
                                            'g_id' => $v ['g_id'],
                                            'deleted' => '0',
                                            'is_active' => '1'
                                        ))->getField('gp_id');
                                $ary_orders_items ['fc_id'] = $fc_id;
                                // 货品id
                                $ary_orders_items ['pdt_id'] = $v ['pdt_id'];
                                // 类型id
                                $ary_orders_items ['gt_id'] = $v ['gt_id'];
                                // 商品sn
                                $ary_orders_items ['g_sn'] = $v ['g_sn'];
                                // 货品sn
                                $ary_orders_items ['pdt_sn'] = $v ['pdt_sn'];
                                // 商品名字
                                $ary_orders_items ['oi_g_name'] = $v ['g_name'];
                                // 成本价
                                $ary_orders_items ['oi_cost_price'] = $v ['pdt_cost_price'];
                                // 货品销售原价
                                $ary_orders_items ['pdt_sale_price'] = $v ['pdt_sale_price'];
                                // 团购商品
                                $ary_orders_items ['oi_type'] = $v ['type'];
                                // 购买单价
                                $ary_orders_items ['oi_price'] = $int_pdt_sale_price = $array_all_price ['discount_price'];
                                // 商品数量
                                $ary_orders_items ['oi_nums'] = $ary_orders ['num'];
                                $bool_orders_items = D('Orders')->doInsertOrdersItems($ary_orders_items);
                                if (!$bool_orders_items) {
                                    $orders->rollback();
                                    $this->error('失败', array(
                                        '失败' => U('Ucenter/Orders/OrderFail')
                                    ));
                                    exit();
                                }

                                // 生成团购日志
                                $ary_gb_log ['o_id'] = $ary_orders ['o_id'];
                                $ary_gb_log ['gp_id'] = $ary_orders ['gp_id'];
                                $ary_gb_log ['m_id'] = $_SESSION ['Members'] ['m_id'];
                                $ary_gb_log ['g_id'] = $v ['g_id'];
                                $ary_gb_log ['num'] = $ary_orders ['num'];
                                if (false === M('groupbuy_log', C('DB_PREFIX'), 'DB_CUSTOM')->add($ary_gb_log)) {
                                    $orders->rollback();
                                    $this->error('失败', array(
                                        '失败' => U('Ucenter/Orders/OrderFail')
                                    ));
                                    exit();
                                }

                                // 商品库存扣除
                                $ary_payment_where = array(
                                    'pc_id' => $ary_orders ['o_payment']
                                );
                                $ary_payment = D('PaymentCfg')->getPayCfgId($ary_payment_where);
                                if ($ary_payment ['pc_abbreviation'] == 'DELIVERY' || $ary_payment ['pc_abbreviation'] == 'OFFLINE') {
                                    // by Mithern 扣除可下单库存生成库存调整单
                                    $good_sale_status = D('Goods')->field(array(
                                                'g_pre_sale_status'
                                            ))->where(array(
                                                'g_id' => $v ['g_id']
                                            ))->find();
                                    if ($good_sale_status ['g_pre_sale_status'] != 1) { // 如果是预售商品不扣库存
                                        $array_result = D('GoodsProducts')->UpdateStock($ary_orders_items ['pdt_id'], $ary_orders ['num']);
                                        if (false == $array_result ["status"]) {
                                            D('GoodsProducts')->rollback();
                                            $this->error($array_result ['msg'] . ',CODE:' . $array_result ["code"]);
                                        }
                                    }
                                }
                            } else {
                                // 订单id
                                $ary_orders_items ['o_id'] = $ary_orders ['o_id'];
                                // 商品id
                                $ary_orders_items ['g_id'] = $v ['g_id'];
                                // 货品id
                                $ary_orders_items ['pdt_id'] = $v ['pdt_id'];
                                // 类型id
                                $ary_orders_items ['gt_id'] = $v ['gt_id'];
                                // 商品sn
                                $ary_orders_items ['g_sn'] = $v ['g_sn'];
                                // o_sn
                                // $ary_orders_items['g_id'] = $v['g_id'];
                                // 货品sn
                                $ary_orders_items ['pdt_sn'] = $v ['pdt_sn'];
                                // 商品名字
                                $ary_orders_items ['oi_g_name'] = $v ['g_name'];
                                // 成本价
                                $ary_orders_items ['oi_cost_price'] = $v ['pdt_cost_price'];
                                // 货品销售原价
                                $ary_orders_items ['pdt_sale_price'] = $v ['pdt_sale_price'];
                                // 购买单价
                                $ary_orders_items ['oi_price'] = $v ['pdt_price'];
                                // 商品积分
                                if (isset($v ['type']) && $v ['type'] == 1) {
                                    $ary_orders_items ['oi_score'] = $v ['pdt_sale_price'];
                                    $total_consume_point += $v ['pdt_sale_price'] * $v ['pdt_nums'];
                                    $ary_orders_items ['oi_type'] = 1;
                                } else {
                                    if (isset($v ['type']) && $v ['type'] == 2) {
                                        $ary_orders_items ['oi_type'] = 2;
                                    }
                                    $int_pdt_sale_price += $v ['pdt_sale_price'] * $v ['pdt_nums'];
                                }
                                // 商品数量
                                $ary_orders_items ['oi_nums'] = $v ['pdt_nums'];
                                $bool_orders_items = D('Orders')->doInsertOrdersItems($ary_orders_items);
                                if (!$bool_orders_items) {
                                    $orders->rollback();
                                    $this->error('失败', array(
                                        '失败' => U('Ucenter/Orders/OrderFail')
                                    ));
                                    exit();
                                }
                                // 商品库存扣除
                                $ary_payment_where = array(
                                    'pc_id' => $ary_orders ['o_payment']
                                );
                                $ary_payment = D('PaymentCfg')->getPayCfgId($ary_payment_where);
                                if ($ary_payment ['pc_abbreviation'] == 'DELIVERY' || $ary_payment ['pc_abbreviation'] == 'OFFLINE') {
                                    // by Mithern 扣除可下单库存生成库存调整单
                                    $good_sale_status = D('Goods')->field(array(
                                                'g_pre_sale_status'
                                            ))->where(array(
                                                'g_id' => $v ['g_id']
                                            ))->find();
                                    if ($good_sale_status ['g_pre_sale_status'] != 1) { // 如果是预售商品不扣库存
                                        $array_result = D('GoodsProducts')->UpdateStock($ary_orders_items ['pdt_id'], $v ['pdt_nums']);
                                        if (false == $array_result ["status"]) {
                                            D('GoodsProducts')->rollback();
                                            $this->error($array_result ['msg'] . ',CODE:' . $array_result ["code"]);
                                        }
                                    }
                                }
                            }
                        }
                        // 产品销量
                        if ($v [0] ['type'] == '4') {
                            foreach ($v as $good) {
                                $ary_goods_num = M("goods_info")->where(array(
                                            'g_id' => $good ['g_id']
                                        ))->data(array(
                                            'g_salenum' => array(
                                                'exp',
                                                'g_salenum + 1'
                                            )
                                        ))->save();
                                if (!$ary_goods_num) {
                                    $orders->rollback();
                                    $this->error('失败', array(
                                        '失败' => U('Ucenter/Orders/OrderFail')
                                    ));
                                    exit();
                                }
                            }
                        } else {
                            $ary_goods_num = M("goods_info")->where(array(
                                        'g_id' => $v ['g_id']
                                    ))->data(array(
                                        'g_salenum' => array(
                                            'exp',
                                            'g_salenum + 1'
                                        )
                                    ))->save();
                            if (!$ary_goods_num) {
                                $orders->rollback();
                                $this->error('失败', array(
                                    '失败' => U('Ucenter/Orders/OrderFail')
                                ));
                                exit();
                            }
                        }
                    }

                    // 商品下单获得总积分
                    $total_reward_point = D('PointConfig')->getrRewardPoint($int_pdt_sale_price);

                    // 有消耗积分或者获得积分，消耗积分插入订单表进行冻结操作
                    if ($total_consume_point > 0 || $total_reward_point > 0) {
                        $ary_freeze_point = array(
                            'o_id' => $ary_orders ['o_id'],
                            'm_id' => $_SESSION ['Members'] ['m_id'],
                            'freeze_point' => $total_consume_point,
                            'reward_point' => $total_reward_point
                        );
                        $res_point = D('Orders')->updateFreezePoint($ary_freeze_point);
                        if (!$res_point) {
                            $this->error('更新冻结积分失败', array(
                                '失败' => U('Ucenter/Orders/OrderFail')
                            ));
                            exit();
                        }
                    }
                }
            }
            // 订单日志记录
            $ary_orders_log = array(
                'o_id' => $ary_orders ['o_id'],
                'ol_behavior' => '创建',
                'ol_uname' => $_SESSION ['Members'] ['m_name'],
                'ol_create' => date('Y-m-d H:i:s')
            );
            $res_orders_log = D('OrdersLog')->add($ary_orders_log);
            if (!$res_orders_log) {
                $this->error('订单日志记录失败', array(
                    '失败' => U('Ucenter/Orders/OrderFail')
                ));
                exit();
            }
            $orders->commit();
            if (!empty($_SESSION ['Members'] ['m_id'])) {
                $Cart = D('Cart')->DelMycart();
            } else {
                unset($_SESSION ['Cart']);
            }
            $this->success('订单提交成功，请您尽快付款！', array(
                '付款' => U("Ucenter/Orders/OrderSuccess", array(
                    'oid' => $order_id
                ))
            ));
            exit();
        }
    }
    /**
     * 订单确认信息提交
     * @author wangguibin@guanyisoft.com
     * @date 2013-10-09 10:50:00
     */
    public function doAdd() {
        $return_orders = false;
        $combo_all_price = 0;
        $free_all_price = 0;
        $ary_orders = $this->_post();
        //print_r($ary_orders);exit;
        $ary_member = session("Members");
        if (!empty($ary_member ['m_id'])) {
            if (isset($ary_orders ['gp_id'])) {
                // 团购商品
                $ary_cart [$ary_orders ['pdt_id']] = array(
                    'pdt_id' => $ary_orders ['pdt_id'],
                    'num' => $ary_orders ['num'],
                    'gp_id' => $ary_orders ['gp_id'],
                    'type' => 5
                );
            } else if(isset($ary_orders ['sp_id'])){
                // 秒杀商品
                $ary_cart [$ary_orders ['pdt_id']] = array(
                    'pdt_id' => $ary_orders ['pdt_id'],
                    'num' => $ary_orders ['num'],
                    'sp_id' => $ary_orders ['sp_id'],
                    'type' => 7
                );
            } else if(isset($ary_orders ['p_id'])){
                //预售商品
                $ary_cart [$ary_orders ['pdt_id']] = array(
                    'pdt_id'=>$ary_orders['pdt_id'],
                    'num'=>$ary_orders['num'],
                    'p_id'=>$ary_orders['p_id'],
                    'type'=> 8
                );
            }else {
                $goods_pids = $ary_orders['goods_pids'];
                if(empty($goods_pids) && !isset($goods_pids)){
                    $this->error('没有要购买的商品，请重新选择商品', array(
                        '返回购物车' => U('Ucenter/Cart/pageList')
                    ));
                }else{
                    $cart_data = D('Cart')->GetData();
                    $ary_pid = explode(',',$goods_pids);
                    foreach ($cart_data as $key=>$cd){
                        foreach ($ary_pid as $pid){
                            if($pid == $key){
                                $ary_cart[$pid] = $cart_data[$key];
                            }
                        }
                    }
                }
                
            }
        } else {
            $ary_cart = (session("?Cart")) ? session("Cart") : array();
        }
        foreach ($ary_cart as $ary) {
            // 自由推荐商品
            if ($ary ['type'] == 4 || $ary ['type'] == 6) {
                foreach ($ary ['pdt_id'] as $pdtId) {
                    $g_id = D("GoodsProducts")->where(array(
                                'pdt_id' => $pdtId
                            ))->getField('g_id');
                    $is_authorize = D('AuthorizeLine')->isAuthorize($ary_member ['m_id'], $g_id);
                    if (empty($is_authorize)) {
                        $this->error('部分商品已不允许购买,请先在购物车里删除这些商品', array(
                            '返回购物车' => U('Ucenter/Cart/pageList')
                        ));
                        exit();
                    }
                    //是否开启区域限售
                    if(GLOBAL_STOCK == TRUE){
                        //临时收货地址
                        
	                    $return_stock = D('GoodsStock')->getProductsWarehouseStock($cr_id, $pdtId);
	                    if(intval($return_stock['pdt_total_stock'])<=2){
	                    	if(!$return_stock['pdt_sn']){
	                    		$pdt_sn = D("GoodsProducts")->where(array(
	                                'pdt_id' => $pdtId
	                            ))->getField('pdt_sn');
	                    	}else{
	                    		$pdt_sn = $return_stock['pdt_sn'];
	                    	}
	                    	$this->error('货品编码为'.$pdt_sn.'的商品库存已不足,请先在购物车里删除这些商品', array(
	                            '返回购物车' => U('Ucenter/Cart/pageList')
	                        ));
	                        exit();
	                    }                    	
                    }
                }
            } else {
                $g_id = D("GoodsProducts")->where(array(
                            'pdt_id' => $ary ['pdt_id']
                        ))->getField('g_id');
                $is_authorize = D('AuthorizeLine')->isAuthorize($ary_member ['m_id'], $g_id);
                if (empty($is_authorize)) {
                    $this->error('部分商品已不允许购买,请先在购物车里删除这些商品', array(
                        '返回购物车' => U('Ucenter/Cart/pageList')
                    ));
                    exit();
                }
                //是否开启区域限售
                if(GLOBAL_STOCK == TRUE){
                    if($ary_orders['ra_id'] != 'other') {
					   $ary_receive_address = $this->cityRegion->getReceivingAddress($ary_member ['m_id']);
					   foreach ($ary_receive_address as $ara_k=>$ara_v){
						  if($ara_v['ra_id'] == $ary_orders['ra_id']){
							 $cr_id= $ara_v['cr_id'];
						  }
					   }
                    }
                    else{
                        if(isset($ary_orders['region']) && !empty($ary_orders['region'])){$cr_id = $ary_orders['region'];}
                        elseif(isset($ary_orders['city']) && !empty($ary_orders['city'])){ $cr_id = $ary_orders['city'];}
                        elseif(isset($ary_orders['province']) && !empty($ary_orders['province'])){ $cr_id = $ary_orders['province'];}
                    }
                    
                    $return_stock = D('GoodsStock')->getProductsWarehouseStock($cr_id, $ary ['pdt_id']);
					if(0 == $return_stock){
						$pdt_sn = D("GoodsProducts")->where(array(
                                'pdt_id' => $ary ['pdt_id']
                            ))->getField('pdt_sn');
						$this->error('货品编码为'.$pdt_sn.'的商品不在限购区域内,请先重新选择所在区域！', array(
                            '返回购物车' => U('Ucenter/Cart/pageList')
                        ));
					}
					if(!$return_stock['pdt_sn']){
						$pdt_sn = D("GoodsProducts")->where(array(
							'pdt_id' => $ary ['pdt_id']
						))->getField('pdt_sn');
					}else{
						$pdt_sn = $return_stock['pdt_sn'];
					}
                    if(intval($return_stock['pdt_total_stock'])<=2){
                    	$this->error('货品编码为'.$pdt_sn.'的商品库存已不足,请先在购物车里删除这件商品', array(
                            '返回购物车' => U('Ucenter/Cart/pageList')
                        ));
                        exit();
                    }                    	
                }
            }
        }
        $User_Grade = D('MembersLevel')->getMembersLevels($ary_member['ml_id']); //会员等级信息
        $orders = M('orders', C('DB_PREFIX'), 'DB_CUSTOM');
        $orders->startTrans();
        if (!empty($ary_orders) && is_array($ary_orders)) {
            if (!empty($ary_orders ['invoices_val']) && $ary_orders ['invoices_val'] == "1") {
                if (isset($ary_orders ['invoice_type']) && isset($ary_orders ['invoice_head'])) {
                    $ary_orders ['is_invoice'] = 1;
                    if ($ary_orders ['invoice_type'] == 2) {
                        // 如果为增值税发票，发票抬头默认为单位
                        $ary_orders ['invoice_head'] = 2;
                    } else {
                        if ($ary_orders ['invoice_head'] == 2) {
                            // 如果发票类型为普通发票，并且发票抬头为单位，将个人姓名删除
                            unset($ary_orders ['invoice_people']);
                        }
                        if ($ary_orders ['invoice_head'] == 1) {
                            // 如果发票类型为普通发票，并且发票抬头为个人，将单位删除
                            unset($ary_orders ['invoice_name']);
                        }
                    }
                    if (empty($ary_orders ['invoice_name'])) {
                        $ary_orders ['invoice_name'] = '个人';
                    } else {
                        $ary_orders ['invoice_name'] = $ary_orders ['invoice_name'];
                    }
                    if (isset($ary_orders ['invoice_content'])) {
                        $ary_orders ['invoice_content'] = $ary_orders ['invoice_content'];
                    }
                } else {
                    if (isset($ary_orders ['is_default']) && !empty($ary_orders ['is_default']) && !isset($ary_orders ['in_id'])) {
                        $res_invoice = D('InvoiceCollect')->getid($ary_orders ['is_default']);

                        if (!empty($res_invoice)) {
                            $ary_orders ['is_invoice'] = 1;
                            $ary_orders ['invoice_type'] = $res_invoice ['invoice_type'];
                            $ary_orders ['invoice_head'] = $res_invoice ['invoice_head'];
                            $ary_orders ['invoice_people'] = $res_invoice ['invoice_people'];
                            if (empty($res_invoice ['invoice_name'])) {
                                $ary_orders ['invoice_name'] = '个人';
                            } else {
                                $ary_orders ['invoice_name'] = $res_invoice ['invoice_name'];
                            }
                            $ary_orders ['invoice_content'] = $res_invoice ['invoice_content'];
                            // 如果是增值税发票，添加增值税发票信息

                            if ($ary_orders ['invoice_type'] == 2) {
                                // 纳税人识别号
                                $ary_orders ['invoice_identification_number'] = $res_invoice ['invoice_identification_number'];
                                // 注册地址
                                $ary_orders ['invoice_address'] = $res_invoice ['invoice_address'];
                                // 注册电话
                                $ary_orders ['invoice_phone'] = $res_invoice ['invoice_phone'];
                                // 开户银行
                                $ary_orders ['invoice_bank'] = $res_invoice ['invoice_bank'];
                                // 银行帐户
                                $ary_orders ['invoice_account'] = $res_invoice ['invoice_account'];
                            }
                        }
                    }
                    // 添加增值税发票
                    if (!empty($ary_orders ['in_id'])) {
                        $ary_res = M('InvoiceCollect', C('DB_PREFIX'), 'DB_CUSTOM')->where(array(
                                    "id" => $ary_orders ['in_id']
                                ))->find();
                        $ary_orders ['invoice_type'] = $ary_res ['invoice_type'];
                        $ary_orders ['invoice_head'] = $ary_res ['invoice_head'];
                        // echo "<pre>";print_r($ary_res);exit;
                        $ary_orders ['is_invoice'] = 1;
                        if (empty($ary_res ['invoice_name'])) {
                            $ary_orders ['invoice_name'] = '个人';
                        } else {
                            $ary_orders ['invoice_name'] = $ary_orders ['invoice_name'];
                        }
                        // 个人姓名
                        $ary_orders ['invoice_people'] = $ary_orders ['invoice_people'];
                        // 纳税人识别号
                        $ary_orders ['invoice_identification_number'] = $ary_orders ['invoice_identification_number'];
                        // 注册地址
                        $ary_orders ['invoice_address'] = $ary_orders ['invoice_address'];
                        // 注册电话
                        $ary_orders ['invoice_phone'] = $ary_orders ['invoice_phone'];
                        // 开户银行
                        $ary_orders ['invoice_bank'] = $ary_orders ['invoice_bank'];
                        // 银行帐户
                        $ary_orders ['invoice_account'] = $ary_orders ['invoice_account'];
                        $ary_orders ['invoice_content'] = $ary_res ['invoice_content'];
                    }
                }
            } else {
                unset($ary_orders ['invoice_type']);
                unset($ary_orders ['invoice_head']);
                unset($ary_orders ['invoice_people']);
                unset($ary_orders ['invoice_name']);
                unset($ary_orders ['invoice_content']);
                unset($ary_orders ['invoices_val']);
            }
            $ary_receive_address = $this->cityRegion->getReceivingAddress($ary_member ['m_id']);
            foreach ($ary_receive_address as $ara_k=>$ara_v){
                if($ara_v['ra_id'] == $ary_orders['ra_id']){
                    $default_address ['default_addr'] = $ara_v;
                }
            }
            if (isset($default_address ['default_addr'] ['ra_id'])) {
                // 收货人
                $ary_orders ['o_receiver_name'] = $default_address ['default_addr'] ['ra_name'];
                
                
                // 收货人电话
                $ary_orders ['o_receiver_telphone'] = trim($default_address ['default_addr'] ['ra_phone']);
                // 收货人手机
                $ary_orders ['o_receiver_mobile'] = $default_address ['default_addr'] ['ra_mobile_phone'];
                // 收货人邮编
                $ary_orders ['o_receiver_zipcode'] = $default_address ['default_addr'] ['ra_post_code'];
                // 收货人地址
                $ary_orders ['o_receiver_address'] = $default_address ['default_addr'] ['ra_detail'];
                $ary_city_data = $this->cityRegion->getFullAddressId($default_address ['default_addr'] ['cr_id']);

                // 收货人省份
                $ary_orders ['o_receiver_state'] = $this->cityRegion->getAddressName($ary_city_data [1]);

                // 收货人城市
                $ary_orders ['o_receiver_city'] = $this->cityRegion->getAddressName($ary_city_data [2]);

                // 收货人地区
                $ary_orders ['o_receiver_county'] = $this->cityRegion->getAddressName($ary_city_data [3]);
            }
            elseif(!isset($default_address ['default_addr'] ['ra_id']) && $ary_orders['ra_id'] == 'other') {
                //使用临时收货地址
                 // 收货人
                $ary_orders ['o_receiver_name'] = $ary_orders['ra_name'];
                // 收货人电话
               // $ary_orders ['o_receiver_telphone'] = trim($default_address ['default_addr'] ['ra_phone']);
               $ary_receiver_telphone = array();
               if(!empty($ary_orders['ra_phone_area'])) array_push($ary_receiver_telphone,$ary_orders['ra_phone_area']);
               if(!empty($ary_orders['ra_phone'])) array_push($ary_receiver_telphone,$ary_orders['ra_phone']);
               if(!empty($ary_orders['ra_phone_ext'])) array_push($ary_receiver_telphone,$ary_orders['ra_phone_ext']);
               $ary_orders ['ra_id'] = 0;
               $ary_orders ['o_receiver_telphone'] = !empty($ary_receiver_telphone) ? implode('-',$ary_receiver_telphone): '';
                // 收货人手机
                $ary_orders ['o_receiver_mobile'] = trim($ary_orders['ra_mobile_phone']);
                // 收货人邮编
               
               $ary_orders ['o_receiver_zipcode'] = trim($ary_orders['ra_post_code']);
               
                // 收货人地址
                
                $ary_orders ['o_receiver_address'] = trim($ary_orders['ra_detail']);
               

                // 收货人省份
                $ary_orders ['o_receiver_state'] = $this->cityRegion->getAddressName($ary_orders['province']);

                // 收货人城市
                $ary_orders ['o_receiver_city'] = $this->cityRegion->getAddressName($ary_orders['city']);

                // 收货人地区
                $ary_orders ['o_receiver_county'] = $this->cityRegion->getAddressName($ary_orders['region']);
                
            }
          //  print_r($ary_orders);exit;
            // 会员id
            $ary_orders ['m_id'] = $ary_member ['m_id'];
            // 订单id
            $ary_orders ['o_id'] = $order_id = date('YmdHis') . rand(1000, 9999);
            // 物流费用
            
            //if (!empty($default_address ['default_addr']) && is_array($default_address ['default_addr'])) {
               // $ra_is_default = $default_address ['default_addr'] ['ra_is_default'];
                //if ($ra_is_default == 1) {
                   // $cr_id = $default_address ['default_addr'] ['cr_id'];
                    $ary_goods = array();
                    if(isset($ary_orders ['p_id'])) {
                        //预售订单计算物流费用
                        $ary_goods[$_SESSION['presale_cart']['pdt_id']] = $_SESSION['presale_cart'];
                    } else if(isset($ary_orders ['sp_id'])) {
                        //秒杀物流费用
                        $ary_goods[$_SESSION['spike_cart']['pdt_id']] = $_SESSION['spike_cart'];
                    } else if(isset($ary_orders ['gp_id'])) {
                        //团购商品物流费用
                        $ary_goods[$_SESSION['bulk_cart']['pdt_id']] = $_SESSION['bulk_cart'];
                    } else {
                        //普通订单商品
                        $ary_goods = $ary_cart;
                    }
                    //$ary_orders ['sp_id']$ary_orders ['gp_id']
                    
                    /*原有方法没有传入商品信息因此所有物流费用都是首重价格 by zhanghao
                    foreach ($ary_logistic as $logistic) {
                        $logistic_price = 0;
                        if ($logistic ['lt_id'] == $ary_orders ['lt_id']) {
                            $logistic_price = $logistic ['logistic_price'];
                            break;
                        }
                    }
                    */
               // }
           // }
            if (empty($ary_orders ['lt_id'])) {
                $this->success(L('SELECT_LOGISTIC'));
                exit();
            }
            //获取团购商品金额方式和普通商品不同
            $ary_orders ['o_goods_all_price'] = 0;
            $m_id = $_SESSION ['Members'] ['m_id'];
            //团购商品
            if (isset($ary_orders ['gp_id'])) {
                $price = new PriceModel($m_id);
                if (!empty($ary_cart) && is_array($ary_cart)) {

                    foreach ($ary_cart as $k => $v) {
                        if ($v ['type'] == 5) {
                            // 获取团购价与商品原价
                            $array_all_price = $price->getItemPrice($ary_orders ['pdt_id'], 0, 5, $ary_orders ['gp_id']);
                           $o_all_price = sprintf("%0.3f", $v ['num'] * $array_all_price ['discount_price']);
                          
                            //商品销售总价
                            $ary_orders ['o_goods_all_saleprice'] = sprintf("%0.3f", $v ['num'] * $array_all_price ['pdt_price']);
                            $ary_orders ['o_discount'] = sprintf("%0.3f", $ary_orders ['o_goods_all_saleprice'] - $o_all_price);
                            $ary_orders ['o_goods_all_price'] = $o_all_price;
                        }
                    }
                }
            } else if(isset($ary_orders ['sp_id'])){
                $price = new PriceModel($m_id);
                if (!empty($ary_cart) && is_array($ary_cart)) {

                    foreach ($ary_cart as $k => $v) {
                        if ($v ['type'] == 7) {
                            // 获取秒杀价与商品原价
                            $array_all_price = $price->getItemPrice($ary_orders ['pdt_id'], 0, 7, $ary_orders ['sp_id']);
//                            echo "<pre>";print_r($array_all_price);exit;
                            $o_all_price = sprintf("%0.3f", $v ['num'] * $array_all_price ['discount_price']);
                            //商品销售总价
                            $ary_orders ['o_goods_all_saleprice'] = sprintf("%0.3f", $v ['num'] * $array_all_price ['pdt_price']);
                            $ary_orders ['o_discount'] = sprintf("%0.3f", $ary_orders ['o_goods_all_saleprice'] - $o_all_price);
                            $ary_orders ['o_goods_all_price'] = $o_all_price;
                        }
                    }
                }
            }else if(isset($ary_orders ['p_id'])){
                $price = new PriceModel($m_id);
                if (!empty($ary_cart) && is_array($ary_cart)) {

                    foreach ($ary_cart as $k => $v) {
                        if ($v ['type'] == 8) {
                            // 获取预售价与商品原价
                            $array_all_price = $price->getItemPrice($ary_orders ['pdt_id'], 0, 8, $ary_orders ['p_id']);
//                            echo "<pre>";print_r($array_all_price);exit;
                            $o_all_price = sprintf("%0.3f", $v ['num'] * $array_all_price ['discount_price']);
                            //商品销售总价
                            $ary_orders ['o_goods_all_saleprice'] = sprintf("%0.3f", $v ['num'] * $array_all_price ['pdt_price']);
                            $ary_orders ['o_discount'] = sprintf("%0.3f", $ary_orders ['o_goods_all_saleprice'] - $o_all_price);
                            $ary_orders ['o_goods_all_price'] = $o_all_price;
//                            echo "<pre>";print_r($ary_orders);exit;
                        }
                    }
                }
            }else {
                if (!empty($ary_cart) && is_array($ary_cart)) {
                    foreach ($ary_cart as $key => $val) {
                        if ($val['type'] == '0') {
                            $ary_gid = M("goods_products", C('DB_PREFIX'), 'DB_CUSTOM')->field('g_id')->where(array('pdt_id' => $val['pdt_id']))->find();
                            $ary_cart[$key]['g_id'] = $ary_gid['g_id'];
                        }
                    }
                }
                $pro_datas = D('Promotion')->calShopCartPro($ary_member ['m_id'], $ary_cart);
                $subtotal = $pro_datas ['subtotal'];
                unset($pro_datas ['subtotal']);
                
                // 商品总价
                $promotion_total_price = '0';
                $promotion_price = '0';
                //赠品数组
                $gifts_cart = array();
                foreach ($pro_datas as $keys => $vals) {
                    foreach ($vals['products'] as $key => $val) {
                        $arr_products = $this->cart->getProductInfo(array($key => $val));

                        if ($arr_products[0][0]['type'] == '4' || $arr_products[0][0]['type'] == '6') {
                            foreach ($arr_products[0] as &$provals) {
                                $provals['authorize'] = D('AuthorizeLine')->isAuthorize($ary_member['m_id'], $provals['g_id']);
                            }
                        }
                        $pro_datas[$keys]['products'][$key] = $arr_products[0];
                        $pro_data[$key] = $val;
                        $pro_data[$key]['pmn_name'] = $vals['pmn_name'];
                    }
                    //赠品数组
                    if (!empty($vals['gifts'])) {
                        foreach ($vals['gifts'] as $gifts) {
                            //随机取一个pdt_id
                            $pdt_id = D("GoodsProducts")->Search(array('g_id' => $gifts['g_id'], 'pdt_stock' => array('GT', 0)), 'pdt_id');
                            $gifts_cart[$pdt_id['pdt_id']] = array('pdt_id' => $pdt_id['pdt_id'], 'num' => 1, 'type' => 2);
                        }
                    }
                    $promotion_total_price += $vals['goods_total_price'];     //商品总价
                    if ($keys != '0') {
                        $promotion_price += $vals['pro_goods_discount'];
                    }
                }
                if(!empty($gifts_cart)){
                    $ary_tmp_cart = array_merge($ary_goods,$gifts_cart);
                    foreach($ary_tmp_cart as $atck=>$atcv){
                        $ary_tmp_cart[$atcv['pdt_id']] = $atcv;
                        unset($ary_tmp_cart[$atck]);
                    }
                }else{
                    $ary_tmp_cart = $ary_goods;
                }
                foreach ($pro_datas as $pro_data) {
                    if ($pro_data ['pmn_class'] == 'MBAOYOU') {
                        foreach($pro_data['products'] as $proDatK=>$proDatV){
                            unset($ary_tmp_cart[$proDatK]);
                        }
                    }
                    if (!empty($pro_data ['pmn_class'])) {//订单只要包含一个促销商品，整个订单为促销，不返点
                        $User_Grade['ml_rebate'] = 0;
                    }
                }
                $logistic_price = $this->logistic->getLogisticPrice($this->_request('lt_id'), $ary_tmp_cart);
                //订单商品总价（销售价格带促销）
                $ary_orders ['o_goods_all_price'] = sprintf("%0.2f", $promotion_total_price - $promotion_price);
                //商品销售总价
                $ary_orders ['o_goods_all_saleprice'] = sprintf("%0.2f", $promotion_total_price);
                $ary_data ['ary_product_data'] = $this->cart->getProductInfo($ary_cart);
            }
            
            //判断会员等级是否包邮
            if(isset($User_Grade['ml_free_shipping']) && $User_Grade['ml_free_shipping'] == 1){
                $logistic_price = 0;
            }
            
			//物流费用
            $ary_orders ['o_cost_freight'] = $logistic_price;
            // 优惠券金额
            if (isset($ary_orders ['coupon_input'])) {
                $str_csn = $ary_orders ['coupon_input'];
                $ary_coupon = D('Coupon')->CheckCoupon($str_csn, $ary_data ['ary_product_data']);
                if (!empty($ary_coupon) && is_array($ary_coupon)) {
                    $ary_orders ['o_coupon_menoy'] = $ary_coupon ['c_money'];
                }
            }
            // 订单总价 商品会员折扣价-优惠券金额
            if (!isset($ary_orders ['gp_id']) && !isset($ary_orders['p_id']) && !isset($ary_orders['sp_id'])) {
                $all_price = $ary_orders ['o_goods_all_price'] - $ary_orders ['o_coupon_menoy'];
            }else{
                $all_price = $o_all_price;
            }
            if ($all_price <= 0) {
                $all_price = 0;
            }
            // 订单应付总价 订单总价+运费
            $all_price += $ary_orders ['o_cost_freight'];
            $ary_orders ['o_all_price'] = sprintf("%0.3f", $all_price);
            $ary_orders ['o_buyer_comments'] = $ary_orders ['o_buyer_comments'];
            // 是否预售单
            if (isset($ary_orders ['g_pre_sale_status']) && $ary_orders ['g_pre_sale_status'] == 1) {
                $ary_orders ['o_pre_sale'] = 1;
            }
            if (empty($ary_orders ['o_receiver_county'])) { // 没有区时
                unset($ary_orders ['o_receiver_county']);
            }
            if (!isset($ary_orders ['gp_id'])) {
                //订单优惠金额
                $ary_orders ['o_discount'] = sprintf("%0.2f", $promotion_price);
            }
            // 发货备注
            if (!empty($ary_orders ['shipping_remarks'])) {
                $ary_orders ['o_shipping_remarks'] = $ary_orders ['shipping_remarks'];
                unset($ary_orders ['shipping_remarks']);
            }
            $ary_orders_goods = $this->cart->getProductInfo($ary_cart);
            // 管理员操作者ID
            if ($ary_member ['admin_id']) {
                $ary_orders ['o_addorder_id'] = $ary_member ['admin_id'];
            }
            //促销信息存起来
            $ary_orders['promotion'] = serialize($pro_datas);
            $bool_orders = D('Orders')->doInsert($ary_orders);
            
            // $bool_orders = true;
            if (!$bool_orders) {
                $orders->rollback();
                $this->error('失败', array(
                    '失败' => U('Ucenter/Orders/OrderFail')
                ));
                exit();
            } else {
                if (isset($ary_coupon ['c_sn'])) {
                    // 更新优惠券使用
                    $ary_data = array(
                        'c_is_use' => 1,
                        'c_used_id' => $_SESSION ['Members'] ['m_id'],
                        'c_order_id' => $ary_orders ['o_id']
                    );
                    $res_coupon = D('Coupon')->doCouponUpdate($ary_coupon ['c_sn'], $ary_data);
                    if (!$res_coupon) {
                        $this->error('失败', array(
                            '失败' => U('Ucenter/Orders/OrderFail')
                        ));
                        exit();
                    }
                } // exit;
                $ary_orders_items = array();
                $ary_orders_goods = $this->cart->getProductInfo($ary_cart);
                if (!empty($gifts_cart)) {
                    $ary_gifts_goods = $this->cart->getProductInfo($gifts_cart);
                    if (!empty($ary_gifts_goods)) {
                        foreach ($ary_gifts_goods as $gift) {
                            array_push($ary_orders_goods, $gift);
                        }
                    }
                }
                if (!empty($ary_orders_goods) && is_array($ary_orders_goods)) {
                    $total_consume_point = 0; // 消耗积分
                    $int_pdt_sale_price = 0; // 货品销售原价总和
                    foreach ($ary_orders_goods as $k => $v) {
                        $ary_orders_items = array();
                        
                        if ($v ['type'] == 3) {
                            $combo_list = D('ReletedCombinationGoods')->getComboList($v ['pdt_id']);
                            if (!empty($combo_list)) {
                                foreach ($combo_list as $combo) {
                                    // 订单id
                                    $ary_orders_items ['o_id'] = $ary_orders ['o_id'];
                                    // 商品id
                                    $combo_item_data = D('GoodsProducts')->Search(array(
                                        'pdt_id' => $combo ['releted_pdt_id']
                                            ), array(
                                        'g_sn',
                                        'g_id'
                                            ));
                                    $ary_orders_items ['g_id'] = $combo_item_data ['g_id'];
                                    // 组合商品ID
                                    $ary_orders_items ['fc_id'] = $v ['pdt_id'];
                                    // 货品id
                                    $ary_orders_items ['pdt_id'] = $combo ['releted_pdt_id'];
                                    // 类型id
                                    $ary_orders_items ['gt_id'] = $combo ['gt_id'];
                                    // 商品sn
                                    $ary_orders_items ['g_sn'] = $combo_item_data ['g_sn'];
                                    // 货品sn
                                    $ary_orders_items ['pdt_sn'] = $combo ['pdt_sn'];
                                    // 商品名字
                                    $combo_good_data = D('GoodsInfo')->Search(array(
                                        'g_id' => $combo_item_data ['g_id']
                                            ), array(
                                        'g_name'
                                            ));
                                    $ary_orders_items ['oi_g_name'] = $combo_good_data ['g_name'];
                                    // 成本价
                                    $ary_orders_items ['oi_cost_price'] = $combo ['pdt_cost_price'];
                                    // 货品销售原价
                                    $ary_orders_items ['pdt_sale_price'] = $combo ['pdt_sale_price'];
                                    // 购买单价
                                    $ary_orders_items ['oi_price'] = $combo ['com_price'];
                                    // 组合商品
                                    $ary_orders_items ['oi_type'] = 3;

                                    $int_pdt_sale_price += $combo ['com_price'] * $combo ['com_nums'];

                                    // 商品数量
                                    $ary_orders_items ['oi_nums'] = $combo ['com_nums'] * $v ['pdt_nums'];
                                    //返点比例
                                    if (!empty($User_Grade['ml_rebate'])) {
                                        $ary_orders_items['ml_rebate'] = $User_Grade['ml_rebate'];
                                    }
                                    //等级折扣
                                    if (!empty($User_Grade['ml_discount'])) {
                                        $ary_orders_items['ml_discount'] = $User_Grade['ml_discount'];
                                    }
                                    $bool_orders_items = D('Orders')->doInsertOrdersItems($ary_orders_items);
                                    if (!$bool_orders_items) {
                                        $orders->rollback();
                                        $this->error('失败', array(
                                            '失败' => U('Ucenter/Orders/OrderFail')
                                        ));
                                        exit();
                                    }
                                    // 商品库存扣除
                                    $ary_payment_where = array(
                                        'pc_id' => $ary_orders ['o_payment']
                                    );
                                    $ary_payment = D('PaymentCfg')->getPayCfgId($ary_payment_where);
                                    if ($ary_payment ['pc_abbreviation'] == 'DELIVERY' || $ary_payment ['pc_abbreviation'] == 'OFFLINE') {
                                        // by Mithern 扣除可下单库存生成库存调整单
                                        $good_sale_status = D('Goods')->field(array(
                                                    'g_pre_sale_status'
                                                ))->where(array(
                                                    'g_id' => $ary_orders_items ['g_id']
                                                ))->find();
                                        if ($good_sale_status ['g_pre_sale_status'] != 1) { // 如果是预售商品不扣库存
                                            //查询库存,如果库存数为负数则不再扣除库存
                                            $int_pdt_stock = M('orders_items',C('DB_PREFIX'),'DB_CUSTOM')
                                                                           ->field('pdt_stock')
                                                                           ->where(array('o_id'=>$ary_orders['o_id']))
                                                                           ->join(C('DB_PREFIX').'goods_products as gp on gp.pdt_id = '.C('DB_PREFIX').'orders_items.pdt_id')
                                                                           ->find();
                                            if(0 >= $int_pdt_stock['pdt_stock']){
                                                $this->error('该货品已售完！');
                                            }
                                            $array_result = D('GoodsProducts')->UpdateStock($combo ['releted_pdt_id'], $ary_orders_items ['oi_nums']);
                                            if (false == $array_result ["status"]) {
                                                D('GoodsProducts')->rollback();
                                                $this->error($array_result ['msg'] . ',CODE:' . $array_result ["code"]);
                                            }
                                        }
                                    }
                                }
                            }
                        } else {
            
                            // 自由推荐商品
                            if ($v [0] ['type'] == '4' || $v [0] ['type'] == '6') {

                                foreach ($v as $key => $item_info) {
                                    // 订单id
                                    $ary_orders_items ['o_id'] = $ary_orders ['o_id'];
                                    // 商品id
                                    $ary_orders_items ['g_id'] = $item_info ['g_id'];
                                    // 货品id
                                    $ary_orders_items ['pdt_id'] = $item_info ['pdt_id'];
                                    // 类型id
                                    $ary_orders_items ['gt_id'] = $item_info ['gt_id'];
                                    // 商品sn
                                    $ary_orders_items ['g_sn'] = $item_info ['g_sn'];
                                    // o_sn
                                    // $ary_orders_items['g_id'] = $v['g_id'];
                                    // 货品sn
                                    $ary_orders_items ['pdt_sn'] = $item_info ['pdt_sn'];
                                    // 商品名字
                                    $ary_orders_items ['oi_g_name'] = $item_info ['g_name'];
                                    // 成本价
                                    $ary_orders_items ['oi_cost_price'] = $item_info ['pdt_cost_price'];
                                    // 货品销售原价
                                    $ary_orders_items ['pdt_sale_price'] = $item_info ['pdt_sale_price'];
                                    // 购买单价
                                    $ary_orders_items ['oi_price'] = $item_info ['pdt_momery'];
                                    $ary_orders_items['promotion'] = $item_info['pdt_rule_name'];
                                    // 自由组合ID
                                    $ary_orders_items ['fc_id'] = isset($item_info ['fc_id']) ? $item_info ['fc_id'] : $item_info ['fr_id'];
                                    // 商品积分
                                    if (isset($v [0] ['type']) && $v [0] ['type'] == 4 && $item_info['fc_id'] != '') {
                                        $ary_orders_items ['oi_type'] = 4;
                                        $int_pdt_sale_price += $item_info ['pdt_sale_price'] * $item_info ['pdt_nums'];
                                    } elseif (isset($v [0] ['type']) && $v [0] ['type'] == 6 && $item_info['fr_id'] != '') {
                                        $ary_orders_items ['oi_type'] = 6;
                                        $int_pdt_sale_price += $item_info ['pdt_sale_price'] * $item_info ['pdt_nums'];
                                    } else {
                                        unset($ary_orders_items['fc_id']);
                                        unset($ary_orders_items['promotion']);
                                        $ary_orders_items ['oi_type'] = 0;
                                    }
                                    // 商品数量
                                    $ary_orders_items ['oi_nums'] = $item_info ['pdt_nums'];
                                    //返点比例
                                    if (!empty($User_Grade['ml_rebate'])) {
                                        $ary_orders_items['ml_rebate'] = $User_Grade['ml_rebate'];
                                    }
                                    //等级折扣
                                    if (!empty($User_Grade['ml_discount'])) {
                                        $ary_orders_items['ml_discount'] = $User_Grade['ml_discount'];
                                    }
                                    $bool_orders_items = D('Orders')->doInsertOrdersItems($ary_orders_items);
                                    if (!$bool_orders_items) {
                                        $orders->rollback();
                                        echo D('Orders')->getLastSql();
                                        exit;
                                        $this->error('失败', array(
                                            '失败' => U('Ucenter/Orders/OrderFail')
                                        ));
                                        exit();
                                    }
                                    // 商品库存扣除
                                    $ary_payment_where = array(
                                        'pc_id' => $ary_orders ['o_payment']
                                    );
                                    $ary_payment = D('PaymentCfg')->getPayCfgId($ary_payment_where);
                                    if ($ary_payment ['pc_abbreviation'] == 'DELIVERY' || $ary_payment ['pc_abbreviation'] == 'OFFLINE') {
                                        // by Mithern 扣除可下单库存生成库存调整单
                                        $good_sale_status = D('Goods')->field(array(
                                                    'g_pre_sale_status'
                                                ))->where(array(
                                                    'g_id' => $item_info ['g_id']
                                                ))->find();
                                        if ($good_sale_status ['g_pre_sale_status'] != 1) { // 如果是预售商品不扣库存
                                            //查询库存,如果库存数为负数则不再扣除库存
                                            $int_pdt_stock = M('orders_items',C('DB_PREFIX'),'DB_CUSTOM')
                                                                           ->field('pdt_stock')
                                                                           ->where(array('o_id'=>$ary_orders['o_id']))
                                                                           ->join(C('DB_PREFIX').'goods_products as gp on gp.pdt_id = '.C('DB_PREFIX').'orders_items.pdt_id')
                                                                           ->find();
                                            if(0 >= $int_pdt_stock['pdt_stock']){
                                                $this->error('该货品已售完！');
                                            }
                                            $array_result = D('GoodsProducts')->UpdateStock($ary_orders_items ['pdt_id'], $item_info ['pdt_nums']);
                                            if (false == $array_result ["status"]) {
                                                D('GoodsProducts')->rollback();
                                                $this->error($array_result ['msg'] . ',CODE:' . $array_result ["code"]);
                                            }
                                        }
                                    }
                                }
                            }elseif($v ['type'] == '7'){
                                // 订单id
                                $ary_orders_items ['o_id'] = $ary_orders ['o_id'];
                                // 商品id
                                $ary_orders_items ['g_id'] = $v ['g_id'];
                                // 秒杀商品ID,取一下
                                $fc_id = M('spike', C('DB_PREFIX'), 'DB_CUSTOM')->where(array(
                                            'g_id' => $v ['g_id'],
                                            'sp_status' => '1'
                                        ))->getField('sp_id');
                                $ary_orders_items ['fc_id'] = $fc_id;
                                // 货品id
                                $ary_orders_items ['pdt_id'] = $v ['pdt_id'];
                                // 类型id
                                $ary_orders_items ['gt_id'] = $v ['gt_id'];
                                // 商品sn
                                $ary_orders_items ['g_sn'] = $v ['g_sn'];
                                // 货品sn
                                $ary_orders_items ['pdt_sn'] = $v ['pdt_sn'];
                                // 商品名字
                                $ary_orders_items ['oi_g_name'] = $v ['g_name'];
                                // 成本价
                                $ary_orders_items ['oi_cost_price'] = $v ['pdt_cost_price'];
                                // 货品销售原价
                                $ary_orders_items ['pdt_sale_price'] = $v ['pdt_sale_price'];
                                // 秒杀商品
                                $ary_orders_items ['oi_type'] = $v ['type'];
                                // 购买单价
                                $ary_orders_items ['oi_price'] =  $array_all_price ['discount_price'];
                                // 商品数量
                                $ary_orders_items ['oi_nums'] = $ary_orders ['num'];
                                //返点比例
                                if (!empty($User_Grade['ml_rebate'])) {
                                    $ary_orders_items['ml_rebate'] = $User_Grade['ml_rebate'];
                                }
//                                echo "<pre>";print_R($v);exit;
                                //等级折扣
                                if (!empty($User_Grade['ml_discount'])) {
                                    $ary_orders_items['ml_discount'] = $User_Grade['ml_discount'];
                                }
                                $bool_orders_items = D('Orders')->doInsertOrdersItems($ary_orders_items);
                                if (!$bool_orders_items) {
                                    $orders->rollback();
                                    $this->error('失败', array(
                                        '失败' => U('Ucenter/Orders/OrderFail')
                                    ));
                                    exit();
                                }
                            } elseif ($v ['type'] == '5') { // 团购商品
                                // 订单id
                                $ary_orders_items ['o_id'] = $ary_orders ['o_id'];
                                // 商品id
                                $ary_orders_items ['g_id'] = $v ['g_id'];
                                // 团购商品ID,取一下
                                $fc_id = M('groupbuy', C('DB_PREFIX'), 'DB_CUSTOM')->where(array(
                                            'g_id' => $v ['g_id'],
                                            'deleted' => '0',
                                            'is_active' => '1'
                                        ))->getField('gp_id');
                                $ary_orders_items ['fc_id'] = $fc_id;
                                // 货品id
                                $ary_orders_items ['pdt_id'] = $v ['pdt_id'];
                                // 类型id
                                $ary_orders_items ['gt_id'] = $v ['gt_id'];
                                // 商品sn
                                $ary_orders_items ['g_sn'] = $v ['g_sn'];
                                // 货品sn
                                $ary_orders_items ['pdt_sn'] = $v ['pdt_sn'];
                                // 商品名字
                                $ary_orders_items ['oi_g_name'] = $v ['g_name'];
                                // 成本价
                                $ary_orders_items ['oi_cost_price'] = $v ['pdt_cost_price'];
                                // 货品销售原价
                                $ary_orders_items ['pdt_sale_price'] = $v ['pdt_sale_price'];
                                // 团购商品
                                $ary_orders_items ['oi_type'] = $v ['type'];
                                // 购买单价
                                $ary_orders_items ['oi_price'] = $int_pdt_sale_price = $array_all_price ['discount_price'];
                                // 商品数量
                                $ary_orders_items ['oi_nums'] = $ary_orders ['num'];
                                //返点比例
                                if (!empty($User_Grade['ml_rebate'])) {
                                    $ary_orders_items['ml_rebate'] = $User_Grade['ml_rebate'];
                                }
                                //等级折扣
                                if (!empty($User_Grade['ml_discount'])) {
                                    $ary_orders_items['ml_discount'] = $User_Grade['ml_discount'];
                                }
                                $bool_orders_items = D('Orders')->doInsertOrdersItems($ary_orders_items);
                                if (!$bool_orders_items) {
                                    $orders->rollback();
                                    $this->error('失败', array(
                                        '失败' => U('Ucenter/Orders/OrderFail')
                                    ));
                                    exit();
                                }

                                // 生成团购日志
                                $ary_gb_log ['o_id'] = $ary_orders ['o_id'];
                                $ary_gb_log ['gp_id'] = $ary_orders ['gp_id'];
                                $ary_gb_log ['m_id'] = $_SESSION ['Members'] ['m_id'];
                                $ary_gb_log ['g_id'] = $v ['g_id'];
                                $ary_gb_log ['num'] = $ary_orders ['num'];
                                if (false === M('groupbuy_log', C('DB_PREFIX'), 'DB_CUSTOM')->add($ary_gb_log)) {
                                    $orders->rollback();
                                    $this->error('失败', array(
                                        '失败' => U('Ucenter/Orders/OrderFail')
                                    ));
                                    exit();
                                }

                                // 商品库存扣除
                                $ary_payment_where = array(
                                    'pc_id' => $ary_orders ['o_payment']
                                );
                                $ary_payment = D('PaymentCfg')->getPayCfgId($ary_payment_where);
                                if ($ary_payment ['pc_abbreviation'] == 'DELIVERY' || $ary_payment ['pc_abbreviation'] == 'OFFLINE') {
                                    // by Mithern 扣除可下单库存生成库存调整单
                                    $good_sale_status = D('Goods')->field(array(
                                                'g_pre_sale_status'
                                            ))->where(array(
                                                'g_id' => $v ['g_id']
                                            ))->find();
                                    if ($good_sale_status ['g_pre_sale_status'] != 1) { // 如果是预售商品不扣库存
                                        //查询库存,如果库存数为负数则不再扣除库存
                                        $int_pdt_stock = M('orders_items',C('DB_PREFIX'),'DB_CUSTOM')
                                                                       ->field('pdt_stock')
                                                                       ->where(array('o_id'=>$ary_orders['o_id']))
                                                                       ->join(C('DB_PREFIX').'goods_products as gp on gp.pdt_id = '.C('DB_PREFIX').'orders_items.pdt_id')
                                                                       ->find();
                                        if(0 >= $int_pdt_stock['pdt_stock']){
                                            $this->error('该货品已售完！');
                                        }
                                        $array_result = D('GoodsProducts')->UpdateStock($ary_orders_items ['pdt_id'], $ary_orders ['num']);
                                        if (false == $array_result ["status"]) {
                                            D('GoodsProducts')->rollback();
                                            $this->error($array_result ['msg'] . ',CODE:' . $array_result ["code"]);
                                        }
                                    }
                                }
                            }elseif($v ['type'] == '8'){
                                // 订单id
                                $ary_orders_items ['o_id'] = $ary_orders ['o_id'];
                                // 商品id
                                $ary_orders_items ['g_id'] = $v ['g_id'];
                                // 预售商品ID
                                $fc_id = M('presale', C('DB_PREFIX'), 'DB_CUSTOM')->where(array(
                                            'g_id' => $v ['g_id'],
                                            'deleted' => '0',
                                            'is_active' => '1'
                                        ))->getField('p_id');
                                $ary_orders_items ['fc_id'] = $fc_id;
                                // 货品id
                                $ary_orders_items ['pdt_id'] = $v ['pdt_id'];
                                // 类型id
                                $ary_orders_items ['gt_id'] = $v ['gt_id'];
                                // 商品sn
                                $ary_orders_items ['g_sn'] = $v ['g_sn'];
                                // 货品sn
                                $ary_orders_items ['pdt_sn'] = $v ['pdt_sn'];
                                // 商品名字
                                $ary_orders_items ['oi_g_name'] = $v ['g_name'];
                                // 成本价
                                $ary_orders_items ['oi_cost_price'] = $v ['pdt_cost_price'];
                                // 货品销售原价
                                $ary_orders_items ['pdt_sale_price'] = $v ['pdt_sale_price'];
                                // 预售商品
                                $ary_orders_items ['oi_type'] = $v ['type'];
                                // 购买单价
                                $ary_orders_items ['oi_price'] = $int_pdt_sale_price = $array_all_price ['discount_price'];
                                // 商品数量
                                $ary_orders_items ['oi_nums'] = $ary_orders ['num'];
                                //返点比例
                                if (!empty($User_Grade['ml_rebate'])) {
                                    $ary_orders_items['ml_rebate'] = $User_Grade['ml_rebate'];
                                }
                                //等级折扣
                                if (!empty($User_Grade['ml_discount'])) {
                                    $ary_orders_items['ml_discount'] = $User_Grade['ml_discount'];
                                }
                                $bool_orders_items = D('Orders')->doInsertOrdersItems($ary_orders_items);
                                if (!$bool_orders_items) {
                                    $orders->rollback();
                                    $this->error('失败', array(
                                        '失败' => U('Ucenter/Orders/OrderFail')
                                    ));
                                    exit();
                                }
                                // 生成预售日志
                                $ary_gb_log ['o_id'] = $ary_orders ['o_id'];
                                $ary_gb_log ['p_id'] = $ary_orders ['p_id'];
                                $ary_gb_log ['m_id'] = $_SESSION ['Members'] ['m_id'];
                                $ary_gb_log ['g_id'] = $v ['g_id'];
                                $ary_gb_log ['num'] = $ary_orders ['num'];
                                if (false === M('presale_log', C('DB_PREFIX'), 'DB_CUSTOM')->add($ary_gb_log)) {
                                    $orders->rollback();
                                    $this->error('失败', array(
                                        '失败' => U('Ucenter/Orders/OrderFail')
                                    ));
                                    exit();
                                }

                                // 商品库存扣除
                                $ary_payment_where = array(
                                    'pc_id' => $ary_orders ['o_payment']
                                );
                                $ary_payment = D('PaymentCfg')->getPayCfgId($ary_payment_where);
                                if ($ary_payment ['pc_abbreviation'] == 'DELIVERY' || $ary_payment ['pc_abbreviation'] == 'OFFLINE') {
                                    // by Mithern 扣除可下单库存生成库存调整单
                                    $good_sale_status = D('Goods')->field(array(
                                                'g_pre_sale_status'
                                            ))->where(array(
                                                'g_id' => $v ['g_id']
                                            ))->find();
                                    if ($good_sale_status ['g_pre_sale_status'] != 1) { // 如果是预售商品不扣库存
                                        //查询库存,如果库存数为负数则不再扣除库存
                                        $int_pdt_stock = M('orders_items',C('DB_PREFIX'),'DB_CUSTOM')
                                                                       ->field('pdt_stock')
                                                                       ->where(array('o_id'=>$ary_orders['o_id']))
                                                                       ->join(C('DB_PREFIX').'goods_products as gp on gp.pdt_id = '.C('DB_PREFIX').'orders_items.pdt_id')
                                                                       ->find();
                                        if(0 >= $int_pdt_stock['pdt_stock']){
                                            $this->error('该货品已售完！');
                                        }
                                        $array_result = D('GoodsProducts')->UpdateStock($ary_orders_items ['pdt_id'], $ary_orders ['num']);
                                        if (false == $array_result ["status"]) {
                                            D('GoodsProducts')->rollback();
                                            $this->error($array_result ['msg'] . ',CODE:' . $array_result ["code"]);
                                        }
                                    }
                                }
                            } else {
                                if (!empty($v['rule_info']['name'])) {
                                    $v['pmn_name'] = $v['rule_info']['name'];
                                }
                                //促销信息
                                foreach ($pro_datas as $vals) {
                                    foreach ($vals['products'] as $key => $val) {
                                        if (($val['type'] == $v['type']) && ($val['pdt_id'] == $v['pdt_id'])) {
                                            if (!empty($vals['pmn_name'])) {
                                                $v['pmn_name'] .= ' ' . $vals['pmn_name'];
                                            }
                                        }
                                    }
                                }
                                // 订单id
                                $ary_orders_items ['o_id'] = $ary_orders ['o_id'];
                                // 商品id
                                $ary_orders_items ['g_id'] = $v ['g_id'];
                                // 货品id
                                $ary_orders_items ['pdt_id'] = $v ['pdt_id'];
                                // 类型id
                                $ary_orders_items ['gt_id'] = $v ['gt_id'];
                                // 商品sn
                                $ary_orders_items ['g_sn'] = $v ['g_sn'];
                                // o_sn
                                // $ary_orders_items['g_id'] = $v['g_id'];
                                // 货品sn
                                $ary_orders_items ['pdt_sn'] = $v ['pdt_sn'];
                                // 商品名字
                                $ary_orders_items ['oi_g_name'] = $v ['g_name'];
                                // 成本价
                                $ary_orders_items ['oi_cost_price'] = $v ['pdt_cost_price'];
                                // 货品销售原价
                                $ary_orders_items ['pdt_sale_price'] = $v ['pdt_sale_price'];
                                // 购买单价
                                $ary_orders_items ['oi_price'] = $v ['pdt_price'];
                                //返点比例
                                if (!empty($User_Grade['ml_rebate'])) {
                                    $ary_orders_items['ml_rebate'] = $User_Grade['ml_rebate'];
                                }
                                //等级折扣
                                if (!empty($User_Grade['ml_discount'])) {
                                    $ary_orders_items['ml_discount'] = $User_Grade['ml_discount'];
                                }
                                // 商品积分
                                if (isset($v ['type']) && $v ['type'] == 1) {
                                    $ary_orders_items ['oi_score'] = $v ['pdt_sale_price'];
                                    $total_consume_point += $v ['pdt_sale_price'] * $v ['pdt_nums'];
                                    $ary_orders_items ['oi_type'] = 1;
                                } else {
                                    if (isset($v ['type']) && $v ['type'] == 2) {
                                        $ary_orders_items ['oi_type'] = 2;
                                    }
                                    $int_pdt_sale_price += $v ['pdt_sale_price'] * $v ['pdt_nums'];
                                }
                                if (isset($v['pmn_name'])) {
                                    $ary_orders_items['promotion'] = $v['pmn_name'];
                                }
                                // 商品数量
                                $ary_orders_items ['oi_nums'] = $v ['pdt_nums'];
                                $bool_orders_items = D('Orders')->doInsertOrdersItems($ary_orders_items);
                                if (!$bool_orders_items) {
                                    $orders->rollback();
                                    $this->error('失败', array(
                                        '失败' => U('Ucenter/Orders/OrderFail')
                                    ));
                                    exit();
                                }
                                // 商品库存扣除
                                $ary_payment_where = array(
                                    'pc_id' => $ary_orders ['o_payment']
                                );
                                $ary_payment = D('PaymentCfg')->getPayCfgId($ary_payment_where);
                                if ($ary_payment ['pc_abbreviation'] == 'DELIVERY' || $ary_payment ['pc_abbreviation'] == 'OFFLINE') {
                                    // by Mithern 扣除可下单库存生成库存调整单
                                    $good_sale_status = D('Goods')->field(array(
                                                'g_pre_sale_status'
                                            ))->where(array(
                                                'g_id' => $v ['g_id']
                                            ))->find();
                                    if ($good_sale_status ['g_pre_sale_status'] != 1) { // 如果是预售商品不扣库存
                                        //查询库存,如果库存数为负数则不再扣除库存
                                        $int_pdt_stock = M('orders_items',C('DB_PREFIX'),'DB_CUSTOM')
                                                                       ->field('pdt_stock')
                                                                       ->where(array('o_id'=>$ary_orders['o_id']))
                                                                       ->join(C('DB_PREFIX').'goods_products as gp on gp.pdt_id = '.C('DB_PREFIX').'orders_items.pdt_id')
                                                                       ->find();
                                        if(0 >= $int_pdt_stock['pdt_stock']){
                                            $this->error('该货品已售完！');
                                        }
                                        $array_result = D('GoodsProducts')->UpdateStock($ary_orders_items ['pdt_id'], $v ['pdt_nums']);
                                        if (false == $array_result ["status"]) {
                                            D('GoodsProducts')->rollback();
                                            $this->error($array_result ['msg'] . ',CODE:' . $array_result ["code"]);
                                        }
                                    }
                                }
                            }
                        }
                        // 产品销量
                        if ($v [0] ['type'] == '4' || $v [0] ['type'] == '6') {
                            foreach ($v as $good) {
                                $ary_goods_num = M("goods_info")->where(array(
                                            'g_id' => $good ['g_id']
                                        ))->data(array(
                                            'g_salenum' => array(
                                                'exp',
                                                'g_salenum + 1'
                                            )
                                        ))->save();
                                if (!$ary_goods_num) {
                                    $orders->rollback();
                                    $this->error('失败', array(
                                        '失败' => U('Ucenter/Orders/OrderFail')
                                    ));
                                    exit();
                                }
                            }
                        } else {
                            $ary_goods_num = M("goods_info")->where(array(
                                        'g_id' => $v ['g_id']
                                    ))->data(array(
                                        'g_salenum' => array(
                                            'exp',
                                            'g_salenum + 1'
                                        )
                                    ))->save();
                            if (!$ary_goods_num) {
                                $orders->rollback();
                                $this->error('失败', array(
                                    '失败' => U('Ucenter/Orders/OrderFail')
                                ));
                                exit();
                            }
                        }
                    }

                    // 商品下单获得总积分
                    $total_reward_point = D('PointConfig')->getrRewardPoint($int_pdt_sale_price);

                    // 有消耗积分或者获得积分，消耗积分插入订单表进行冻结操作
                    if ($total_consume_point > 0 || $total_reward_point > 0) {
                        $ary_freeze_point = array(
                            'o_id' => $ary_orders ['o_id'],
                            'm_id' => $_SESSION ['Members'] ['m_id'],
                            'freeze_point' => $total_consume_point,
                            'reward_point' => $total_reward_point
                        );
                        $res_point = D('Orders')->updateFreezePoint($ary_freeze_point);
                        if (!$res_point) {
                            $this->error('更新冻结积分失败', array(
                                '失败' => U('Ucenter/Orders/OrderFail')
                            ));
                            exit();
                        }
                    }
                }
            }
            // 订单日志记录
            $ary_orders_log = array(
                'o_id' => $ary_orders ['o_id'],
                'ol_behavior' => '创建',
                'ol_uname' => $_SESSION ['Members'] ['m_name'],
                'ol_create' => date('Y-m-d H:i:s')
            );
            
            $res_orders_log = D('OrdersLog')->add($ary_orders_log);
            if (!$res_orders_log) {
                $this->error('订单日志记录失败', array(
                    '失败' => U('Ucenter/Orders/OrderFail')
                ));
                exit();
            }
            $orders->commit();
            if (!empty($_SESSION ['Members'] ['m_id'])) {
                $mix_pdt_id = array();
                $mix_pdt_type = array();
                foreach ($ary_cart as $key=>$val){
                    $mix_pdt_id[] = $key;
                    $mix_pdt_type[] = $val['type'];
                }
                D('Cart')->doUpadteOrdersCart($mix_pdt_id,$mix_pdt_type);
                //$Cart = D('Cart')->DelMycart();
            } else {
                unset($_SESSION ['Cart']);
            }
            $this->success('订单提交成功，请您尽快付款！', U("Ucenter/Orders/OrderSuccess", array('oid' => $order_id)));
            exit();
        }
    }

    /**
     * 订单显示页面
     */
	 
    public function pageShow() {
        $this->getSubNav(1, 0, 40);
        $int_o_id = $this->_get('oid');
        $field = array(
            'fx_orders.o_id',
            'fx_orders_items.oi_id',
            'fx_orders.o_status',
            'fx_orders.o_all_price',
            'fx_orders.o_pay',
            'fx_orders.o_create_time',
            'fx_orders.o_goods_all_price',
            'fx_orders.o_goods_all_saleprice',
            'fx_orders.o_pay_status',
            'fx_orders.o_receiver_name',
            'fx_orders.o_receiver_state',
            'fx_orders.o_receiver_city',
            'fx_orders.o_receiver_county',
            'fx_orders.o_discount',
            'fx_orders.o_shipping_remarks',
            'fx_orders.o_receiver_address',
            'fx_orders.o_receiver_telphone',
            'fx_orders.o_receiver_mobile',
            'fx_orders.o_receiver_email',
            'fx_orders.o_coupon_menoy',
            'fx_orders.o_buyer_comments',
			'fx_orders.o_source_id',
			'fx_orders.o_payment',
            'fx_orders.lt_id',
            'fx_orders.ra_id',
            'fx_orders.o_reward_point',
            'fx_orders.o_freeze_point',
            'fx_orders.o_cost_freight',
            'fx_orders.o_receiver_time',
            'fx_orders_items.pdt_id',
            'fx_orders_items.g_id',
            'fx_orders_items.oi_ship_status',
            'fx_orders_items.g_sn',
            'fx_orders_items.oi_g_name',
            'fx_orders_items.oi_score',
            'fx_orders_items.oi_nums',
            'fx_orders_items.oi_type',
            'fx_orders_items.oi_price',
            'fx_orders_items.pdt_sale_price',
            'fx_orders_items.pdt_sn',
            'fx_orders_items.promotion',
            'fx_members.m_balance'
        );
        $where = array(
            'fx_orders.o_id' => $int_o_id,
            'fx_members.m_id' => $_SESSION ['Members'] ['m_id']
        );
        $ary_orders_info = D('Orders')->getOrdersData($where, $field);
        $ary_orders = $ary_orders_info[0];
      
        // 订单作废状态
        $ary_status = array(
            'o_status' => $ary_orders ['o_status']
        );
        $str_status = $this->orders->getOrderItmesStauts('o_status', $ary_status);
         
        $ary_orders ['str_status'] = $str_status;

        // 订单状态
        $ary_orders_status = $this->orders->getOrdersStatus($int_o_id);
        $ary_afersale = M('orders_refunds', C('DB_PREFIX'), 'DB_CUSTOM')->where(array(
                    'o_id' => $int_o_id
                ))->order('or_update_time desc')->select();
        if (!empty($ary_afersale) && is_array($ary_afersale)) {
            foreach ($ary_afersale as $keyaf => $valaf) {
                if ($valaf ['or_service_verify'] == '1' && $valaf ['or_finance_verify'] == '1') {
                    M('orders_refunds', C('DB_PREFIX'), 'DB_CUSTOM')->where(array(
                        'o_id' => $int_o_id,
                        'or_id'=>$valaf['or_id'],
                    ))->save(array(
                        'or_processing_status' => 1
                    ));
                }
                // 退款
                if ($valaf ['or_refund_type'] == 1) {
                    switch ($valaf ['or_processing_status']) {
                        case 0 :
                            $ary_orders ['refund_status'] = '退款中';
                            break;
                        case 1 :
                            $ary_orders ['refund_status'] = '退款成功';
                            break;
                        case 2 :
                            $ary_orders ['refund_status'] = '退款驳回';
                            break;
                        default :
                            $ary_orders ['refund_status'] = ''; // 没有退款
                    }
                } elseif ($valaf ['or_refund_type'] == 2) { // 退货
                    switch ($valaf ['or_processing_status']) {
                        case 0 :
                            $ary_orders ['refund_goods_status'] = '退货中';
                            break;
                        case 1 :
                            $ary_orders ['refund_goods_status'] = '退货成功';
                            break;
                        case 2 :
                            $ary_orders ['refund_goods_status'] = '退货驳回';
                            break;
                        default :
                            $ary_orders ['refund_goods_status'] = ''; // 没有退款
                    }
                }
            }
        }
        if ($ary_orders ['refund_goods_status'] == '') {
            $ary_orders ['deliver_status'] = $ary_orders_status ['deliver_status'];
        }
        if ($ary_orders ['refund_status'] == '') {
            // 订单支付状态
            $ary_pay_status = array(
                'o_pay_status' => $ary_orders ['o_pay_status']
            );
            $str_pay_status = $this->orders->getOrderItmesStauts('o_pay_status', $ary_pay_status);
            $ary_orders ['str_pay_status'] = $str_pay_status;
        }

        // 退款、退货类型
        $ary_orders ['refund_type'] = $ary_orders_status ['refund_type'];
        // 支付方式
        $ary_payment_where = array(
            'pc_id' => $ary_orders ['o_payment']
        );
        $ary_payment = D('PaymentCfg')->getPayCfgId($ary_payment_where);
        $ary_orders ['payment_name'] = $ary_payment ['pc_custom_name'];
        $ary_orders ['pc_id'] = $ary_payment ['pc_id'];
        // 配送方式
        $ary_logistic_where = array(
            'lt_id' => $ary_orders ['lt_id']
        );
        $ary_field = array(
            'lc_name'
        );
        $ary_logistic_info = $this->logistic->getLogisticInfo($ary_logistic_where, $ary_field);
        $ary_orders ['str_logistic'] = $ary_logistic_info [0] ['lc_name'];
        // 订单详情商品
        if (!empty($ary_orders_info) && is_array($ary_orders_info)) {
            $combo_price_total = 0;
            foreach ($ary_orders_info as $k => $v) {

                //处理使用的促销问题
                $ary_orders_info[$k]['promotions'] = array();
                if (strlen($v['promotion']) > 0) {
                    $ary_orders_info[$k]['promotions'] = explode(' ', $v['promotion']);
                }

                $ary_orders_info [$k] ['pdt_spec'] = D("GoodsSpec")->getProductsSpec($v ['pdt_id']);

                $ary_goods_pic = M('goods_info', C('DB_PREFIX'), 'DB_CUSTOM')->where(array(
                            'g_id' => $v ['g_id']
                        ))->field('g_picture')->find();

                $ary_orders_info [$k] ['g_picture'] = getFullPictureWebPath($ary_goods_pic ['g_picture']);
                // 订单商品退款、退货状态
                $ary_orders_info [$k] ['str_refund_status'] = $this->orders->getOrderItmesStauts('oi_refund_status', $v);
                // 订单商品发货
//                 echo "<pre>";print_r($ary_orders_info);exit;
                $ary_orders_info [$k] ['str_ship_status'] = $this->orders->getOrderItmesStauts('oi_ship_status', $v);
                // 分销系统商品小计 和  从第三下单的商品小计
                $ary_orders_info [$k] ['subtotal'] = empty($v['o_source_id']) ? $v ['oi_nums'] * $v ['oi_price'] : $v['oi_price'];
//                echo "<pre>";print_r($v);die;
                if ($v ['oi_type'] == 3) {
                    $combo_sn = $v ['pdt_sn'];
                    $tmp_ary = array(
                        'g_sn' => $ary_orders_info [$k] ['g_sn'],
                        'pdt_spec' => $ary_orders_info [$k] ['pdt_spec'],
                        'g_picture' => $ary_orders_info [$k] ['g_picture'],
                        'oi_g_name' => $ary_orders_info [$k] ['oi_g_name'],
                        'pdt_id' => $ary_orders_info [$k] ['pdt_id']
                    );

                    $combo_pdt_gid = D('GoodsProducts')->Search(array(
                        'pdt_sn' => $v ['pdt_sn']
                            ), array(
                        'g_id'
                            ));
                    $combo_where = array(
                        'g_id' => $combo_pdt_gid ['g_id'],
                        'releted_pdt_id' => $ary_orders_info [$k] ['pdt_id']
                    );
                    $combo_field = array(
                        'com_nums',
                        'com_price'
                    );
                    $combo_res = D('ReletedCombinationGoods')->getComboReletedList($combo_where, $combo_field);
                    
                    $combo_num = $combo_res [0] ['com_nums'];
                    $combo_price_total += sprintf("%0.3f", $combo_res [0] ['com_nums'] * $combo_res [0] ['com_price']);

                    $ary_combo [$combo_sn] ['item'] [$k] = $tmp_ary;
                    $ary_combo [$combo_sn] ['num'] = $ary_orders_info [$k] ['oi_nums'] / $combo_num;
                    $ary_combo [$combo_sn] ['pdt_sale_price'] = $ary_orders_info [$k] ['pdt_sale_price'];
                    $ary_combo [$combo_sn] ['o_all_price'] = sprintf("%0.3f", $combo_price_total * $ary_combo [$combo_sn] ['num']);
                    $ary_combo [$combo_sn] ['str_ship_status'] = $ary_orders_info [$k] ['str_ship_status'];
                    $ary_combo [$combo_sn] ['str_refund_status'] = $ary_orders_info [$k] ['str_refund_status'];
                    unset($ary_orders_info [$k]);
                }
            }
        }
        
        // 物流信息
        $ary_delivery = D('Orders')->ordersLogistic($int_o_id);
        // 商品总价=商品折扣后价格+折扣价
        $ary_orders ['o_goods_all_price'] = sprintf("%0.3f", $ary_orders['o_goods_all_price']);
//        echo "<pre>";print_r($ary_orders);exit;
        // 判断是否已生成退款/退货单
        if ($ary_orders ['refund_type'] == '1') {
            $where = array();
            $where ['o_id'] = $ary_orders ['o_id'];
            $where ['or_refund_type'] = 1;
            $where ['or_processing_status'] = array(
                'neq',
                2
            );
            $num_refund = D('OrdersRefunds')->where($where)->count();
        }

        // 判断淘宝担保交易
        $arr_payment = M('payment_cfg', C('DB_PREFIX'), 'DB_CUSTOM')->where(array(
                    'ps_id' => $ary_orders ['o_payment']
                ))->find();
        $payment = M('payment_serial', C('DB_PREFIX'), 'DB_CUSTOM')->where(array(
                    'ps_code' => $arr_payment ['pc_abbreviation'],
                    "ps_status_sn" => 'WAIT_SELLER_SEND_GOODS'
                ))->find();
        if (!empty($payment) && is_array($payment)) {
            $ary_orders ['is_pay'] = true;
        } else {
            $ary_orders ['is_pay'] = false;
        } // echo "<pre>";print_r($ary_orders);exit;
        // 还应支付金额
        $ary_orders ['o_order_amount'] = sprintf("%0.3f", $ary_orders ['o_all_price'] - $ary_orders ['o_pay']);
        if(in_array(C('CUSTOMER_TYPE'),array(1,3)) && !empty($ary_orders['o_source_id'])){
            $this->assign('o_source_id', $ary_orders['o_source_id']);
        }
        
        $this->assign('refund_num', $num_refund);
//        echo "<pre>";print_r($ary_orders_info);die;
        

        $this->assign('orders_goods_info', $ary_orders_info);
        $this->assign('ary_combo', $ary_combo);
        $this->assign('ary_orders', $ary_orders);
        $this->assign('ary_delivery', $ary_delivery);
//echo "<pre>";print_r($ary_orders);die;
        $this->display();
    }

    /**
     * 下单成功显示页面
     * 
     * @author zhangjiasuo <zhangjiasuo@guanyisoft.com>
     * @date 2013-04-24
     */
    public function OrderSuccess() {
        $this->getSubNav(1, 0, 30);
        $int_o_id = $this->_get('oid');
        $where = array(
            'o_id' => $int_o_id,
            'm_id' => $_SESSION ['Members'] ['m_id']
        );
        $ary_orders_info = D('Orders')->getOrdersInfo($where);	
        $ary_orders = $ary_orders_info [0];
        //echo "<pre>";print_r($ary_orders);exit;
        // 订单作废状态
        $ary_status = array(
            'o_status' => $ary_orders ['o_status']
        );
        $str_status = $this->orders->getOrderItmesStauts('o_status', $ary_status);
        $ary_orders ['str_status'] = $str_status;

        // 订单支付状态
        $ary_pay_status = array(
            'o_pay_status' => $ary_orders ['o_pay_status']
        );
        $str_pay_status = $this->orders->getOrderItmesStauts('o_pay_status', $ary_pay_status);
        $ary_orders ['str_pay_status'] = $str_pay_status;
        // 订单状态
        $ary_orders_status = $this->orders->getOrdersStatus($int_o_id);
        // 退款
        $ary_orders ['refund_status'] = $ary_orders_status ['refund_status'];
        // 退货
        $ary_orders ['refund_goods_status'] = $ary_orders_status ['refund_goods_status'];
        // 发货
        $ary_orders ['deliver_status'] = $ary_orders_status ['deliver_status'];
        // 退款、退货类型
        $ary_orders ['refund_type'] = $ary_orders_status ['refund_type'];
        // 支付方式
        $ary_payment_where = array(
            'pc_id' => $ary_orders ['o_payment']
        );
        $ary_payment = D('PaymentCfg')->getPayCfgId($ary_payment_where);
        // 获取支付方式列表
        $payment = D('PaymentCfg');
        $payment_list = $payment->getPayCfg();
        //下单成功页面，过滤货到付款的支付方式
        foreach($payment_list as $key=>$val){
            if(strtoupper($val['pc_abbreviation']) == 'DELIVERY') unset($payment_list[$key]);
        }

        $ary_orders ['payment_name'] = $ary_payment ['pc_custom_name'];
        $ary_orders ['pc_abbreviation'] = $ary_payment ['pc_abbreviation'];
        $ary_orders ['pc_id'] = $ary_payment ['pc_id'];

        // 当前订单类型 8:预售商品 5:团购商品，4:自由组合商品,3组合商品，2赠品， 1积分商品，0普通商品
        $oi_type = M('orders_items')->where(array(
                    'o_id' => $ary_orders ['o_id']
                ))->getField('oi_type');
        switch ($oi_type) {
            case '5' : // 团购商品
                // 1，判断团购商品是否开启定金支付
                $groupbuy_info = M('groupbuy')->field(array('gp_id,gp_overdue_start_time,gp_overdue_end_time,gp_deposit_price,is_deposit'))
                                              ->where(array('g_id' => $ary_orders ['g_id'],'deleted' => 0))
                                              ->find();
                // 2,当前订单是否已经支付过定金
                if ($groupbuy_info ['is_deposit'] == 1) {
                    $pay_type_count = M('payment_serial')->where(array('o_id' => $ary_orders ['o_id'],'ps_status' => array('neq',0)))->count();
                    // echo $pay_type_count;exit;
                    if (empty($pay_type_count)) {
                        $pay_status = 0; // 还未支付过，适用于定金支付和全额支付
                        // 获取定金
                        $ary_orders ['gp_deposit_price'] = sprintf("%0.3f", $groupbuy_info ['gp_deposit_price'] * $ary_orders ['oi_nums']);
                    } else {
                        $pay_status = 1; // 已经支付过定金支付，还需支付尾款金额
                    }
                } else {
                    $pay_status = 3; // 未开启定金支付
                }
                $this->assign('pay_status', $pay_status);
                break;
            case '8'://预售商品
                $presale_info = M('presale',C('DB_PREFIX'),'DB_CUSTOM')->field('p_id,p_overdue_start_time,p_overdue_end_time,p_deposit_price,is_deposit')
                                ->where(array('g_id'=>$ary_orders['g_id'],'deleted'=>0))
                                ->find();
                //判断预售商品是否开启定金支付
                if($presale_info['is_deposit'] == 1){
                    //判读当前订单是否已经支付过定金
                    $pay_type_count = M('payment_serial',C('DB_PREFIX'),'DB_CUSTOM')->where(array('o_id'=>$ary_orders['o_id'],'ps_status'=>array('neq',0)))->count();
                    if(empty($pay_type_count)){
                        $pay_status = 0;//还未支付过，适用于定金支付和全额支付
                        //获取定金
                        $ary_orders['gp_deposit_price'] = sprintf('%.2f',$presale_info['p_deposit_price'] * $ary_orders['oi_nums']); 
                    }else{
                        $pay_status = 1;//已经支付过定金支付，还需支付尾款金额
                    }
                }else{
                    $pay_status = 3; //未开启定金支付
                }
                $this->assign('pay_status',$pay_status);
                break;
        }
        // 支付金额为：订单总金额-已支付金额
        //$ary_orders ['o_all_price'] = sprintf("%0.3f", $ary_orders ['o_all_price'] - $ary_orders ['o_pay']);
        $this->assign('orders_goods_info', $ary_orders_info);
        $this->assign('ary_orders', $ary_orders);
        $this->assign('payment_list', $payment_list);
        $this->display();
    }

    /**
     * 下单成功显示页面
     * 
     * @author zhangjiasuo <zhangjiasuo@guanyisoft.com>
     * @date 2013-04-24
     */
    public function OrderFail() {
        $this->getSubNav(1, 1, 30);
        $this->display();
    }

    /**
     * 订单列表
     * 
     * @author listen
     *         @date 2013-01-08
     */
    public function pageList() {
        $this->getSubNav(2, 0, 40);
        $ary_where = array();
        $ary_chose = array();

        $ary_where ['m_id'] = $_SESSION ['Members'] ['m_id'];
        $orders = M('orders', C('DB_PREFIX'), 'DB_CUSTOM');
        $ary_chose ['o_id'] = $this->_get('oid');
        $ary_chose ['o_status'] = $this->_get('status');
        $ary_chose ['o_receiver_name'] = $this->_get('o_receiver_name');
        $ary_chose ['from_time'] = $this->_get('from');
        $ary_chose ['end_time'] = $this->_get('end');
        if(!empty($ary_chose ['end_time']) && !empty($ary_chose ['from_time'])){
        	if($ary_chose ['end_time']<$ary_chose ['from_time']){
        		$this->error('下单时间开始时间不能大于结束时间');
        	}
        }
        // 订单的状态条件搜索处理
        switch ($ary_chose ['o_status']) {
            case '1' :
                $str_orders_status = '未发货';
                $ary_where ['fx_orders_items.oi_ship_status'] = 0;
                break;
            case '2' :
                $str_orders_status = '已发货';
                $ary_where ['fx_orders_items.oi_ship_status'] = 2;
                break;
            case '3' :
                $str_orders_status = '未付款';
                $ary_where ['fx_orders.o_pay_status'] = 0;
                break;
            case '4' :
                $str_orders_status = '退款/退货';
                $ary_where ['fx_orders_items.oi_refund_status'] != 1;
                break;
            default :
                $str_orders_status = '所有订单';
        }
        // 订单号
        if (isset($ary_chose ['o_id']) && $ary_chose ['o_id'] != '') {
            $ary_where ['fx_orders.o_id'] = array(
                'LIKE',
                '%' . $ary_chose ['o_id'] . '%'
            );
        }
        // 过滤掉子订单
        $ary_where ['fx_orders.initial_o_id'] = 0;
        // 收货人名字
        if (isset($ary_chose ['o_receiver_name']) && $ary_chose ['o_receiver_name'] != '') {
            $ary_where ['fx_orders.o_receiver_name'] = array(
                'LIKE',
                '%' . $ary_chose ['o_receiver_name'] . '%'
            );
        }
        // 下单开始时间
        if (isset($ary_chose ['from_time']) && !isset($ary_chose ['end_time'])) {
            $ary_where ['fx_orders.o_create_time'] = array(
                'EGT',
                $ary_chose ['from_time']
            );
        } else if (!isset($ary_chose ['from_time']) && isset($ary_chose ['end_time'])) {
            $ary_where ['fx_orders.o_create_time'] = array(
                'ELT',
                $ary_chose ['end_time']
            );
        } else if ((isset($ary_chose ['from_time']) && $ary_chose ['from_time'] != '') && (isset($ary_chose ['end_time']) && $ary_chose ['end_time'] != '')) {
            $ary_where ['fx_orders.o_create_time'] = array(
                array(
                    'ELT',
                    $ary_chose ['end_time']
                ),
                array(
                    'EGT',
                    $ary_chose ['from_time']
                )
            );
        }
        $count = $orders->join('fx_orders_items on fx_orders.o_id=fx_orders_items.o_id')->group('fx_orders.o_id')->where($ary_where)->count();
        $obj_page = new Page($count, 10);
        $page = $obj_page->show();
        $ary_orders_info = $orders->join('fx_orders_items on fx_orders.o_id=fx_orders_items.o_id')->where($ary_where)->order(array(
                    'o_create_time' => 'desc'
                ))->group('fx_orders.o_id')->limit($obj_page->firstRow . ',' . $obj_page->listRows)->select();
				//echo $orders->getLastSql();die;
        if (!empty($ary_orders_info) && is_array($ary_orders_info)) {
            foreach ($ary_orders_info as $k => $v) {

                // 订单状态
                $ary_orders_status = $this->orders->getOrdersStatus($v ['o_id']);
                $ary_afersale = M('orders_refunds', C('DB_PREFIX'), 'DB_CUSTOM')->where(array(
                            'o_id' => $v ['o_id']
                        ))->order('or_create_time desc')->select();
                if (!empty($ary_afersale) && is_array($ary_afersale)) {
                    foreach ($ary_afersale as $keyaf => $valaf) {
                        if ($valaf ['or_service_verify'] == '1' && $valaf ['or_finance_verify'] == '1') {
                            M('orders_refunds', C('DB_PREFIX'), 'DB_CUSTOM')->where(array(
                                'o_id' => $v ['o_id'],
                                'or_id'=>$valaf['or_id']
                            ))->save(array(
                                'or_processing_status' => 1
                            ));
                        }
                        // 退款
                        if ($valaf ['or_refund_type'] == 1) {
                            switch ($valaf ['or_processing_status']) {
                                case 0 :
                                    $ary_orders_info [$k] ['refund_status'] = '退款中';
                                    break;
                                case 1 :
                                    $ary_orders_info [$k] ['refund_status'] = '退款成功';
                                    break;
                                case 2 :
                                    $ary_orders_info [$k] ['refund_status'] = '退款驳回';
                                    break;
                                default :
                                    $ary_orders_info [$k] ['refund_status'] = ''; // 没有退款
                            }
                        } elseif ($valaf ['or_refund_type'] == 2) { // 退货
                            switch ($valaf ['or_processing_status']) {
                                case 0 :
                                    $ary_orders_info [$k] ['refund_goods_status'] = '退货中';
                                    break;
                                case 1 :
                                    $ary_orders_info [$k] ['refund_goods_status'] = '退货成功';
                                    break;
                                case 2 :
                                    $ary_orders_info [$k] ['refund_goods_status'] = '退货驳回';
                                    break;
                                default :
                                    $ary_orders_info [$k] ['refund_goods_status'] = ''; // 没有退款
                            }
                        }
                    }
                }
                // 付款状态
                if ($ary_orders_info [$k] ['refund_status'] == '') {
                    $ary_orders_info [$k] ['str_pay_status'] = $this->orders->getOrderItmesStauts('o_pay_status', $v ['o_pay_status']);
                }

                $ary_orders_info [$k] ['str_status'] = $this->orders->getOrderItmesStauts('o_status', $v ['o_status']);
                if ($ary_orders_info [$k] ['refund_goods_status'] == '') {
                    $ary_orders_info [$k] ['deliver_status'] = $ary_orders_status ['deliver_status'];
                }
                // 发货
            }
        } // echo "<pre>";print_r($ary_orders_info);exit;
        // 订单状态
        $this->assign('chose', $ary_chose);
        // echo "<pre>";print_r($ary_orders_info);exit;
        $this->assign('orders_info', $ary_orders_info);
        $this->assign('page', $page); // 赋值分页输出
        $this->display();
    }

    // 作废订单
    public function ajaxInvalidOrder() {
        $int_oid = $this->_post('oid');
        $cacel_type = $this->_post('cacel_type');
        if (isset($int_oid) && isset($cacel_type)) {
            //断订单是满足作废条件,只有未支付的订单才能作废
            $ary_where = array('o_id' => $int_oid, 'o_pay_status' => 1, 'o_status' => 1);
            $orders = M('orders', C('DB_PREFIX'), 'DB_CUSTOM');
            $ary_orders = $orders->where($ary_where)->find();
//            echo "<pre>";print_r($ary_orders);exit;
            if (count($ary_orders) > 0 && !empty($ary_orders)) {
                $this->error('此订单不能作废', array('确定' => U('Ucenter/Orders/pageShow/', array('oid' => $int_oid))));
                exit;
            } else {
                $return_orders = $orders->where(array(
                            'o_id' => $int_oid
                        ))->save(array(
                    'o_status' => 2
                        ));
                // 订单日志记录
                if ($return_orders) {
                    $ary_orders_log = array(
                        'o_id' => $int_oid,
                        'ol_behavior' => '作废',
                        'ol_uname' => $_SESSION ['Members'] ['m_name'],
                        'ol_create' => date('Y-m-d H:i:s')
                    );
                    $res_orders_log = D('OrdersLog')->add($ary_orders_log);
                }
                if ($return_orders > 0) {
                    // 冻结积分释放掉
                    $res_status = $this->orders->releasePoint($int_oid);
                    if (!$res_status)
                        $this->error('作废订单释放冻结积分失败', array(
                            '确定' => U('Ucenter/Orders/pageShow/', array(
                                'oid' => $int_oid
                            ))
                        ));

                    $ary_coupon = M('coupon', C('DB_PREFIX'), 'DB_CUSTOM')->where(array(
                                'c_order_id' => $int_oid
                            ))->find();
                    if (!empty($ary_coupon) && is_array($ary_coupon)) {
                        $res_coupon = M('coupon', C('DB_PREFIX'), 'DB_CUSTOM')->where(array(
                                    'c_order_id' => $int_oid
                                ))->save(array(
                            'c_used_id' => 0,
                            'c_order_id' => 0,
                            'c_is_use' => 0
                                ));
                        if (!$res_coupon) {
                            $this->error('优惠券还原失败', array(
                                '确定' => U('Ucenter/Orders/pageShow/', array(
                                    'oid' => $int_oid
                                ))
                            ));
                            exit();
                        }
                    }
                    
                    M('thd_orders', C('DB_PREFIX'), 'DB_CUSTOM')->where(array('o_source_id'=>$ary_orders['o_source_id']))->data(array('to_tt_status'=>'0'))->save();

                    $this->success('作废成功', array(
                        '确定' => U('Ucenter/Orders/pageList/')
                    ));
                    exit();
                } else {
                    $this->error('此订单不能作废', array(
                        '确定' => U('Ucenter/Orders/pageShow/', array(
                            'oid' => $int_oid
                        ))
                    ));
                    exit();
                }
            }
        }
    }

    /**
     * 订单支付
     * 
     * @param int $order_id
     *        	订单ID
     * @param ary $oreder
     *        	更新订单表数组
     * @return boolean
     */
    public function paymentPage() {
        $int_id = $this->_post('oid');
        $payment_id = $this->_post('new_payment_id');
        $pay_stat = $this->_post('typeStat');
        $where = array();
        $where ['fx_orders.o_id'] = $int_id;
        if ($pay_stat == 2) { // 如果当前是尾款支付
            $where ['fx_orders.o_pay_status'] = 3;
        } else {
            $where ['fx_orders.o_pay_status'] = 0;
        }
        $where ['fx_orders.o_status'] = array(array('eq','1'),array('eq','3'),'or');
        $search_field = array(
            'fx_orders.o_all_price',
            'fx_orders.o_payment',
            'fx_orders.o_pay',
            'fx_members.m_id',
            'fx_orders.o_pay_status',
            'fx_orders.o_reward_point',
            'fx_orders.o_freeze_point',
            'fx_orders_items.pdt_id',
            'fx_orders_items.oi_nums',
            'fx_orders_items.oi_type',
            'fx_orders_items.fc_id',
            'fx_orders_items.g_id'
        );

        if (isset($int_id)) {
            $ary_orders_data = D('Orders')->getOrdersData($where, $search_field, $group);
            if (empty($ary_orders_data) && count($ary_orders_data) <= 0) {
                $this->error('订单不存在或已支付'); // XXXXXXXXXXXXXXXXXXXXX
            }
            $ary_orders = $ary_orders_data [0];
        }
        M('', '', 'DB_CUSTOM')->startTrans();
        
        // 支付流程改造【团购】
        if ($ary_orders ['oi_type'] == '5') { // 团购订单
       
            $groupbuy = M('groupbuy', C('DB_PREFIX'), 'DB_CUSTOM')->where(array(
                        'g_id' => $ary_orders ['g_id'],'deleted'=>0
                    ))->find();

            if ($pay_stat == 0) {
                // 团购全额支付
                //验证团购商品是否可以支付
                $is_pay = D('Groupbuy')->checkBulkIsBuy($ary_orders['m_id'],$groupbuy['gp_id']);
                if($is_pay['status'] == false){
                    M('', '', 'DB_CUSTOM')->rollback();
                    $this->error($is_pay['msg'], U('Ucenter/Orders/pageShow/', array('oid' => $int_id)));
                }
                $o_pay = $ary_orders ['o_all_price'];
                $gp_now_number = M('groupbuy', C('DB_PREFIX'), 'DB_CUSTOM')->where(array(
                            'gp_id' => $groupbuy ['gp_id']
                        ))->getField('gp_now_number');
                M('groupbuy', C('DB_PREFIX'), 'DB_CUSTOM')->where(array(
                    'gp_id' => $groupbuy ['gp_id']
                ))->save(array(
                    'gp_now_number' => $gp_now_number + $ary_orders ['oi_nums']
                ));
            } elseif ($pay_stat == 1) {
                // 团购定金支付,获取定金
                $is_pay = D('Groupbuy')->checkBulkIsBuy($ary_orders['m_id'],$groupbuy['gp_id']);
                if($is_pay['status'] == false){
                    M('', '', 'DB_CUSTOM')->rollback();
                    $this->error($is_pay['msg'], U('Ucenter/Orders/pageShow/', array('oid' => $int_id)));
                }
                $o_pay = sprintf("%0.3f", $groupbuy ['gp_deposit_price'] * $ary_orders ['oi_nums']);
                $gp_now_number = M('groupbuy', C('DB_PREFIX'), 'DB_CUSTOM')->where(array(
                            'gp_id' => $groupbuy ['gp_id']
                        ))->getField('gp_now_number');
                M('groupbuy', C('DB_PREFIX'), 'DB_CUSTOM')->where(array(
                    'gp_id' => $groupbuy ['gp_id']
                ))->save(array(
                    'gp_now_number' => $gp_now_number + $ary_orders ['oi_nums']
                ));
            } elseif ($pay_stat == 2) {
                // 尾款支付。检测当前时间是否在指定支付尾款时间内
                $gp_overdue_start_time = strtotime($groupbuy ['gp_overdue_start_time']);
                $gp_overdue_end_time = strtotime($groupbuy ['gp_overdue_end_time']);
                if ($gp_overdue_start_time > mktime()) {
                    // 还未到支付尾款时间
                    $this->error('请于' . date('Y年m月d日 H:i:s', $gp_overdue_start_time) . '后补交尾款');
                } elseif (($gp_overdue_start_time < mktime()) && ($gp_overdue_end_time < mktime())) {
                    // 支付尾款时间已过
                    $this->error('补交尾款时间已过，请联系客服人员');
                }
                $o_pay = sprintf("%0.3f", $ary_orders ['o_all_price'] - $ary_orders ['o_pay']);
            }
        }elseif ($ary_orders['oi_type'] == '8') {   //预售商品
            $presale = M('presale', C('DB_PREFIX'), 'DB_CUSTOM')->where(array(
                        'g_id' => $ary_orders ['g_id']
                    ))->find();
            if ($pay_stat == 0) {
                // 预售全额支付
                $o_pay = $ary_orders ['o_all_price'];
                $p_now_number = M('presale', C('DB_PREFIX'), 'DB_CUSTOM')->where(array(
                            'p_id' => $presale ['p_id']
                        ))->getField('p_now_number');
                M('presale', C('DB_PREFIX'), 'DB_CUSTOM')->where(array(
                    'p_id' => $presale ['p_id']
                ))->save(array(
                    'p_now_number' => $p_now_number + $ary_orders ['oi_nums']
                ));
            } elseif ($pay_stat == 1) {
                // 预售定金支付,获取定金
                $o_pay = sprintf("%0.3f", $presale ['p_deposit_price'] * $ary_orders ['oi_nums']);
                $p_now_number = M('presale', C('DB_PREFIX'), 'DB_CUSTOM')->where(array(
                            'p_id' => $presale ['p_id']
                        ))->getField('p_now_number');
                M('presale', C('DB_PREFIX'), 'DB_CUSTOM')->where(array(
                    'p_id' => $presale ['p_id']
                ))->save(array(
                    'p_now_number' => $p_now_number + $ary_orders ['oi_nums']
                ));
            } elseif ($pay_stat == 2) {
                // 尾款支付。检测当前时间是否在指定支付尾款时间内
                $p_overdue_start_time = strtotime($presale ['p_overdue_start_time']);
                $p_overdue_end_time = strtotime($presale ['p_overdue_end_time']);
                if ($p_overdue_start_time > mktime()) {
                    // 还未到支付尾款时间
                    $this->error('请于' . date('Y年m月d日 H:i:s', $p_overdue_start_time) . '后补交尾款');
                } elseif (($p_overdue_start_time < mktime()) && ($p_overdue_end_time < mktime())) {
                    // 支付尾款时间已过
                    $this->error('补交尾款时间已过，请联系客服人员');
                }
                $o_pay = sprintf("%0.3f", $ary_orders ['o_all_price'] - $ary_orders ['o_pay']);
            }
        }else {
            $o_pay = sprintf("%0.3f", $ary_orders ['o_all_price'] - $ary_orders ['o_pay']);
        }

        // # 使用支付模型 支付订单 ###############################################
        $Payment = D('PaymentCfg');
        if ($ary_orders ['o_payment'] != $payment_id && !empty($payment_id)) {
            $ary_orders ['o_payment'] = $payment_id;
            $update_payment_res = $this->orders->UpdateOrdersPayment($int_id, $payment_id);
            if ($update_payment_res == false) {
                M('', '', 'DB_CUSTOM')->rollback();
                exit();
            }
        }
        
        $info = $Payment->where(array(
                    'pc_id' => $ary_orders ['o_payment']
                ))->find();
        
        if (false == $info) {
            // 支付方式不存在 XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
            M('', '', 'DB_CUSTOM')->rollback();
            $this->error('支付方式不存在，或不可用');
            exit();
        }
        
        // 线下支付进erp
        if ($info ['pc_abbreviation'] != 'OFFLINE' && $info ['pc_abbreviation'] != 'DELIVERY' && $ary_orders ['pc_abbreviation'] != 'DELIVERY') {
            $Pay = $Payment::factory($info ['pc_abbreviation'], json_decode($info ['pc_config'], true));
            $result = $Pay->pay($int_id, $ary_orders ['oi_type'], $o_pay, $pay_stat);
            writeLog($result, "order_pay.log");
            if (!$result ['result']) {
                // 支付失败了 XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                M('', '', 'DB_CUSTOM')->rollback();
                $this->error($result ['message']);
            }
            // 支付成功了
            // die('@tudo 支付成功继续完成：1）流水账 2）更新订单状态 3）进入ERP');
            $ary_orders ['o_pay'] = $o_pay;
            if ($pay_stat == 1) {
                // 如果是定金支付，支付状态为部分支付
                $ary_orders ['o_pay_status'] = 3;
            } else {
                $ary_orders ['o_pay_status'] = 1;
            } // print_r($ary_orders);exit;
            //查询库存,如果库存数为负数则不再扣除库存
            $int_pdt_stock = M('orders_items',C('DB_PREFIX'),'DB_CUSTOM')
                                           ->field('pdt_stock')
                                           ->where(array('o_id'=>$int_id))
                                           ->join(C('DB_PREFIX').'goods_products as gp on gp.pdt_id = '.C('DB_PREFIX').'orders_items.pdt_id')
                                           ->find();
            if($ary_orders['oi_type'] ==5 || $ary_orders['oi_type'] ==8){
                //没有结果
            }else{
                if(0 >= $int_pdt_stock['pdt_stock']){
                    $this->error('该货品已售完！');
                }
            }
            
            $result_order = $this->orders->orderPayment($int_id, $ary_orders);
            
            if (!$result_order ['result']) {
                // 后续工作失败 XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                M('', '', 'DB_CUSTOM')->rollback();
                $this->error($result_order ['message']);
                exit();
            }else{
                if($ary_orders ['oi_type'] == '7'){
                    $result_spike = D("Spike")->where(array('sp_id'=>$ary_orders['fc_id']))->data(array('sp_now_number'=>array('exp', 'sp_now_number + 1')))->save();
                    if (!$result_spike) {
                        // 后续工作失败 XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                        M('', '', 'DB_CUSTOM')->rollback();
                        $this->error("111");
                            exit();

                    }
                }
            }

            $ary_member = session("Members");
            $ary_balance_info = array(
                'bt_id' => '1',
                'bi_sn' => time(),
                'm_id' => $ary_member ['m_id'],
                'bi_money' => $o_pay,
                'bi_type' => '1',
                'bi_payment_time' => date("Y-m-d H:i:s"),
                'o_id' => $int_id,
                'bi_desc' => '订单支付',
                'single_type' => '2',
                'bi_verify_status' => '1',
                'bi_service_verify' => '1',
                'bi_finance_verify' => '1',
                'bi_create_time' => date("Y-m-d H:i:s")
            );
            $arr_res = M('BalanceInfo', C('DB_PREFIX'), 'DB_CUSTOM')->add($ary_balance_info);
            // echo "<pre>";print_r($ary_balance_info);exit;
            if (!$arr_res) {
                M('', '', 'DB_CUSTOM')->rollback();
                $this->error('生成支付明细失败，请重试...');
                exit();
            } else {
                $arr_data = array();
                $str_sn = str_pad($arr_res, 6, "0", STR_PAD_LEFT);
                $arr_data ['bi_sn'] = time() . $str_sn;
                $arr_result = M('BalanceInfo', C('DB_PREFIX'), 'DB_CUSTOM')->where(array(
                            'bi_id' => $arr_res
                        ))->data($arr_data)->save();
                if (!$arr_result) {
                    M('', '', 'DB_CUSTOM')->rollback();
                    $this->error('更新支付明细失败，请重试...');
                    exit();
                }
                // 结余款调整单日志
                $add_balance_log ['u_id'] = 0;
                $add_balance_log ['bi_sn'] = $arr_data ['bi_sn'];
                $add_balance_log ['bvl_desc'] = '审核成功';
                $add_balance_log ['bvl_type'] = '2';
                $add_balance_log ['bvl_status'] = '2';
                $add_balance_log ['bvl_create_time'] = date('Y-m-d H:i:s');
                if (false === M('balance_verify_log', C('DB_PREFIX'), 'DB_CUSTOM')->add($add_balance_log)) {
                    M('', '', 'DB_CUSTOM')->rollback();
                    $this->error('生成结余款调整单日志失败，请重试...');
                    exit();
                }
                $add_balance_log ['bvl_type'] = '3';
                if (false === M('balance_verify_log', C('DB_PREFIX'), 'DB_CUSTOM')->add($add_balance_log)) {
                    M('', '', 'DB_CUSTOM')->rollback();
                    $this->error('生成结余款调整单日志失败，请重试...');
                    exit();
                }
            }
            if ($info ['pc_abbreviation'] == 'DEPOSIT') {
                $add_payment_serial ['m_id'] = $_SESSION ['Members'] ['m_id'];
                $add_payment_serial ['pc_code'] = 'DEPOSIT';
                $add_payment_serial ['ps_money'] = $o_pay;
                $add_payment_serial ['ps_type'] = 0;
                $add_payment_serial ['o_id'] = $int_id;
                $add_payment_serial ['ps_status'] = 1;
                $add_payment_serial ['pay_type'] = $pay_stat;
                $add_payment_serial ['ps_create_time'] = date('Y-m-d H:i:s');
                $ary_result = M('payment_serial', C('DB_PREFIX'), 'DB_CUSTOM')->add($add_payment_serial);
                if (false === $ary_result) {
                    M('', '', 'DB_CUSTOM')->rollback();
                    $this->error('生成支付明细失败，请重试...');
                    exit();
                }
            }
        } else {
            //查询库存,如果库存数为负数则不再扣除库存
            $int_pdt_stock = M('orders_items',C('DB_PREFIX'),'DB_CUSTOM')
                                           ->field('pdt_stock')
                                           ->where(array('o_id'=>$int_id))
                                           ->join(C('DB_PREFIX').'goods_products as gp on gp.pdt_id = '.C('DB_PREFIX').'orders_items.pdt_id')
                                           ->find();
            if(0 >= $int_pdt_stock['pdt_stock']){
                $this->error('该货品已售完！');
            }
            $ary_orders ['o_pay_status'] = 0;
            $result_order = $this->orders->orderPayment($int_id, $ary_orders);
            
            if (!$result_order ['result']) {
                M('', '', 'DB_CUSTOM')->rollback();
                $this->error($result_order ['message']);
                exit();
            }else{
                
                if($ary_orders ['oi_type'] == '7'){
                    $result_spike = D("Spike")->where(array('sp_id'=>$ary_orders['fc_id']))->data(array('sp_now_number'=>array('exp', 'sp_now_number + 1')))->save();
                    if (!$result_spike) {
                        // 后续工作失败 XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                        M('', '', 'DB_CUSTOM')->rollback();
                        $this->error($result_order ['message']);
                            exit();

                    }
                }
            }
        }
        M('', '', 'DB_CUSTOM')->commit();
        $url = U("Ucenter/Orders/PaymentSuccess", array(
            'oid' => $int_id
                ));
        redirect($url);
        exit();
    }

    /**
     * 支付成功显示页面
     * 
     * @author zhangjiasuo <zhangjiasuo@guanyisoft.com>
     * @date 2013-04-24
     */
    public function PaymentSuccess() {
        $this->getSubNav(1, 0, 30);
        $ary_member = session("Members");
        $int_o_id = $this->_get('oid');
        $where = array(
            'fx_orders.o_id' => $int_o_id,
            'fx_orders.m_id' => $ary_member ['m_id']
        );
        $ary_field = array(
            'fx_orders.o_pay',
            'fx_orders.o_all_price',
            'fx_orders.coupon_sn',
            'fx_orders_items.pdt_id',
            'fx_orders_items.oi_nums',
            'fx_orders_items.oi_type'
        );
        $ary_orders = D('Orders')->getOrdersData($where, $ary_field);
        // 本次消费金额=支付单最后一次消费记录
        $payment_serial = M('payment_serial')->where(array('o_id' => $int_o_id))->order('ps_create_time desc')->select();
        // echo "<pre>"; print_r($payment_serial);exit;
        $payment_price = $payment_serial [0] ['ps_money'];
        $all_price = $ary_orders[0]['o_all_price'];
        $coupon_sn = $ary_orders[0]['coupon_sn'];
        //获取优惠券节点
        $coupon_config = D('SysConfig')->getCfgByModule('GET_COUPON');
        //送优惠券
        if ($coupon_sn == "" && $coupon_config['GET_COUPON_SET'] == '0') {
            D('Coupon')->setPoinGetCoupon($ary_orders, $ary_member['m_id']);
        }
        // 账户余额
        $ary_member_balance = D('Members')->GetBalance(array(
            'm_id' => $_SESSION ['Members'] ['m_id']
                ), array(
            'm_balance'
                ));
        $this->assign('o_id', $int_o_id);
        $this->assign('balance', $ary_member_balance ['m_balance']);
        $this->assign('payment_price', $payment_price);
        $this->display();
    }

    /**
     * 查看我的优惠券
     * 
     * @author listen
     * @date 2013-02-27
     */
    public function myCouponPage() {
        $mid = $_SESSION ['Members'] ['m_id'];
        $ary_where = array(
            'c_user_id' => $mid,
            'c_is_use' => 0
        );
        $ary_where ['c_end_time'] = array(
            'EGT',
            date('Y-m-d H:i:s')
        );
        $ary_coupon = M('coupon', C('DB_PREFIX'), 'DB_CUSTOM')->where($ary_where)->select();
        $ary_cart = D('Cart')->GetData();
        if (isset($ary_cart ['gifts'])) {
            unset($ary_cart ['gifts']);
        }
        $cart_data = $this->cart->getProductInfo($ary_cart);
        // 判断商品是否允许使用优惠券
        // dump($ary_coupon);
        foreach ($ary_coupon as $key => $coupon) {
            $group_data = M('related_coupon_goods_group',C('DB_PREFIX'),'DB_CUSTOM')
            ->where(array('c_id'=>$ary_coupon['c_id']))
            ->field('group_concat(gg_id) as group_id')->group('gg_id')->select();
            if(!empty($group_data)){
                $is_true = 0;
                //查询团购管理商品
                foreach ($group_data as $gd){
                    $item_data = M('related_goods_group',C('DB_PREFIX'),'DB_CUSTOM')
                    ->where(array('gg_id'=>array('in',$gd['group_id'])))->field('g_id')->group('g_id')->select();
                    foreach($item_data as $item){
                        foreach($cart_data as $cart){
                            if($cart['g_id'] == $item['g_id']){
                                $is_true = 1;
                                break;
                            }
                        }
                    }
                }
                if ($is_true == '0') {
                    unset($ary_coupon [$key]);
                }
                
            }
            
        }
        $this->assign('ary_coupon', $ary_coupon);
        $this->display();
    }

    /**
     * 使用优惠券
     * 
     * @author listen
     * @date 2013-02-27
     */
    public function doCoupon() {
        $str_csn = $this->_post('csn');
        $lt_id = $this->_post('lt_id');
        $data = $this->_post();
        $ary_tmp_cart = D('Cart')->GetData();
        if($data['pids']){
            $ary_pid = explode(',',$data['pids']);
            foreach ($ary_tmp_cart as $key=>$cd){
                foreach ($ary_pid as $pid){
                    if($pid == $key){
                        $ary_cart[$pid] = $ary_tmp_cart[$key];
                    }
                }
            }
        }else{
            $ary_cart = $ary_tmp_cart;
        }
        $ary_tmp_cart = $ary_cart;
        $ary_member = session("Members");
        $pro_datas = D('Promotion')->calShopCartPro($ary_member ['m_id'], $ary_cart);
        $logistic_price = D('Logistic')->getLogisticPrice($lt_id, $ary_cart);
        
        $subtotal = $pro_datas ['subtotal'];
        unset($pro_datas ['subtotal']);
        $ary_data ['ary_product_data'] = $this->cart->getProductInfo($ary_cart);
        // 商品总重
        $ary_price_data ['all_weight'] = sprintf("%0.2f", D('Orders')->getGoodsAllWeight($ary_cart));
        $ary_promotion = array();
        $promotion_total_price = '0';
        $promotion_price = '0';
        
        foreach ($pro_datas as $keys => $vals) {
            foreach ($vals['products'] as $key => $val) {
                $arr_products = $this->cart->getProductInfo(array($key => $val));
                if ($arr_products[0][0]['type'] == '4') {
                    foreach ($arr_products[0] as &$provals) {
                        $provals['authorize'] = D('AuthorizeLine')->isAuthorize($ary_member['m_id'], $provals['g_id']);
                    }
                }
                $pro_datas[$keys]['products'][$key] = $arr_products[0];
                $pro_data[$key] = $val;
                $pro_data[$key]['pmn_name'] = $vals['pmn_name'];
            }
            //赠品数组
            if(!empty($vals['gifts'])){
                foreach($vals['gifts'] as $gifts){
                    //随机取一个pdt_id
                    $pdt_id = D("GoodsProducts")->Search(array('g_id'=>$gifts['g_id'],'pdt_stock'=>array('GT', 0)),'pdt_id');
                    $cart_gifts[$pdt_id['pdt_id']]=array('pdt_id'=>$pdt_id['pdt_id'],'num'=>1,'type'=>2);
                }
            }
            $promotion_total_price += $vals['goods_total_price'];     //商品总价
            if ($keys != '0') {
                $promotion_price += $vals['pro_goods_discount'];
            }
        }
        //获取赠品信息
        if(!empty($cart_gifts)){
            $ary_tmp_cart = array_merge($ary_tmp_cart,$cart_gifts);
            foreach($ary_tmp_cart as $atck=>$atcv){
                $ary_tmp_cart[$atcv['pdt_id']] = $atcv;
                unset($ary_tmp_cart[$atck]);
            }
        }
        $ary_res ['all_price'] = sprintf("%0.2f", $promotion_total_price - $promotion_price);
        
        $logistic_price = D('Logistic')->getLogisticPrice($lt_id, $ary_tmp_cart);
        // 满足满包邮条件
        foreach ($pro_datas as $pro_data) {
            if ($pro_data ['pmn_class'] == 'MBAOYOU') {
                $logistic_price = 0;
            }
        }
        if (isset($str_csn)) {
            $ary_coupon = D('Coupon')->CheckCoupon($str_csn, $ary_data ['ary_product_data']);
            $date = date('Y-m-d H:i:s');
            if (empty($ary_coupon) || !is_array($ary_coupon)) {
                $ary_res ['errMsg'] = '优惠券编号错误或已使用或不满足使用条件';
                $ary_res ['success'] = 0;
            } else {
                if ($ary_coupon ['c_condition_money'] > 0 && $ary_res ['all_price'] < $ary_coupon ['c_condition_money']) {
                    $ary_res ['errMsg'] = '优惠券不满足使用条件';
                    $ary_res ['success'] = 0;
                } elseif ($ary_coupon ['c_is_use'] == 1 || $ary_coupon ['c_used_id'] != 0) {
                    $ary_res ['errMsg'] = '优惠券被使用';
                    $ary_res ['success'] = 0;
                } elseif ($ary_coupon ['c_start_time'] > $date) {
                    $ary_res ['errMsg'] = '优惠券不能使用';
                    $ary_res ['success'] = 0;
                } elseif ($date > $ary_coupon ['c_end_time']) {
                    $ary_res ['errMsg'] = '活动已经结束';
                    $ary_res ['success'] = 0;
                } else {
                    $ary_res ['sucMsg'] = '可以使用';
                    $ary_res ['success'] = 1;
                    $ary_res ['coupon_price'] = $ary_coupon ['c_money'];
                }
            }
        } else {
            $ary_res ['errMsg'] = '优惠券编号错误';
            $ary_res ['success'] = 0;
        }
        $ary_res ['logistic_price'] = $logistic_price;
        $ary_res ['promotion_price'] = sprintf("%0.2f", $promotion_price);
        echo json_encode($ary_res);
        exit();
        // 判断优惠券金额是否大于订单金额
    }

    /**
     * 添加发票收藏设置
     * 
     * @author Zhangjiasuo <Zhangjiasuo@guanyisoft.com>
     * @date 2013-04-26
     */
    public function AddInvoice() {
        $data ['invoice_type'] = $this->_get('type');
        $data ['invoice_head'] = $this->_get('head');
        $data ['invoice_name'] = $this->_get('name');
        $content = $this->_get('content');
        $people = $this->_get('invoice_people');
        $data ['invoice_content'] = empty($content) ? $people : $content;
        $data ['invoice_people'] = $this->_get('invoice_people');
        $data ['m_id'] = $_SESSION ['Members'] ['m_id'];
        $data ['create_time'] = date("Y-m-d H:i:s");
        $data ['modify_time'] = date("Y-m-d H:i:s");
        $data ['is_default'] = 1;
        M('InvoiceCollect', C('DB_PREFIX'), 'DB_CUSTOM')->add($data);
//                echo "<pre>";echo M ( 'InvoiceCollect', C ( 'DB_PREFIX' ), 'DB_CUSTOM' )->getLastSql();exit;
    }

    /**
     */
    public function AddAppInvoice() {
        $data = $this->_post();
        $data ['m_id'] = $_SESSION ['Members'] ['m_id'];
        $data ['create_time'] = date("Y-m-d H:i:s");
        $data ['modify_time'] = date("Y-m-d H:i:s");
        $data ['is_default'] = 1;
        // 是否开启增值税发票自动审核，开启的话增值税发票自动审核
        $p_invoice = D('Invoice')->get();
        $is_auto_verify = $p_invoice ['is_auto_verify'];
        if ($is_auto_verify == 1)
            $data ['is_verify'] = 1;

        $ary_res = M('InvoiceCollect', C('DB_PREFIX'), 'DB_CUSTOM')->add($data);
        if (FALSE !== $ary_res) {
            $this->ajaxReturn(array(
                'status' => 1,
                'info' => '添加增值税发票成功',
                "data" => $ary_res
            ));
        } else {
            $this->ajaxReturn(array(
                'status' => 0,
                'info' => '添加增值税发票失败'
            ));
        }
    }

    /**
     * 改变收藏设置
     * 
     * @author Zhangjiasuo <Zhangjiasuo@guanyisoft.com>
     * @date 2013-04-26
     */
    public function ChangeInvoice() {
        $data ['id'] = $this->_get('id');
        $data ['m_id'] = $_SESSION ['Members'] ['m_id'];
        D('InvoiceCollect')->change($data);
    }

    /**
     * 设置ajax打开页面
     * 
     * @author wangguibin<wangguibin@guanyisoft.com>
     *  @date 2013-06-09
     */
    public function setPage() {
        $int_o_id = $this->_post('o_id');
        $this->assign('o_id', $int_o_id);
        $this->display();
    }

    /**
     * 添加销货收款单
     * 
     * @author wangguibin<wangguibin@guanyisoft.com>
     *  @date 2013-06-09
     */
    public function addVoucher() {
        $data = $this->_post();
        $data ['o_id'] = trim($data ['o_id']);
        $data ['sr_bank_sn'] = trim($data ['sr_bank_sn']);
        if (!is_float($data ['to_post_balance']) && !is_numeric($data ['to_post_balance']) && ($data ['to_post_balance'] <= 0)) {
            $this->ajaxReturn(array(
                'status' => 0,
                'info' => '金额格式必须正确且大于0！'
            ));
            exit();
        }
        if (!($data ['o_id']) || !($data ['to_post_balance']) || !($data ['sr_bank_sn'])) {
            $this->ajaxReturn(array(
                'status' => 0,
                'info' => '金额和流水号必填！'
            ));
            exit();
        }
        $ary_data = M('Orders', C('DB_PREFIX'), 'DB_CUSTOM')->field('fx_orders.o_all_price,fx_orders.m_id,fx_orders.o_pay_status,fx_orders.o_id,p.pc_pay_type,p.pc_id,fx_orders.o_status')->join("fx_payment_cfg as p on(p.pc_id=fx_orders.o_payment) ")->where(array(
                    'o_id' => $data ['o_id']
                ))->find();
        if (floatval($ary_data ['o_all_price']) > floatval($data ['to_post_balance'])) {
            $this->ajaxReturn(array(
                'status' => 0,
                'info' => '输入的金额小于订单应付金额，不能生成销货单！'
            ));
            exit();
        }
        // 流水帐号在有效的单据中不可重复
        $ary_count = M('sales_receipts', C('DB_PREFIX'), 'DB_CUSTOM')->where(array(
                    'sr_bank_sn' => $data ['sr_bank_sn'],
                    'sr_status' => '1'
                ))->count();
        if ($ary_count > 0) {
            $this->ajaxReturn(array(
                'status' => 0,
                'info' => '流水帐号已存在,不可重复！'
            ));
            exit();
        }
        $r = M('Orders', C('DB_PREFIX'), 'DB_CUSTOM')->where(array(
                    'o_id' => $data ['o_id']
                ))->save(array(
            'o_payment' => '3',
            'o_update_time' => date('Y-m-d H:i:s')
                ));
        if ($r) {
            $ary_data ['pc_pay_type'] = 'offline';
        }
        // 线下支付订单新增销货收款单
        if (($ary_data ['o_pay_status'] == 0) && ($ary_data ['o_status'] == '1') && ($ary_data ['pc_pay_type'] == 'offline')) {
            $ary_data1 = M('sales_receipts', C('DB_PREFIX'), 'DB_CUSTOM')->where(array(
                        'o_id' => $data ['o_id'],
                        'sr_status' => '1'
                    ))->count();
            if ($ary_data1 == 0) {
                $data ['sr_create_type'] = '0';
                $data ['sr_create_time'] = date("Y-m-d H:i:s");
                $data ['sr_update_time'] = date("Y-m-d H:i:s");
                $data ['sr_verify_status'] = '0';
                $data ['sr_type'] = '0';
                $data ['m_id'] = $ary_data ['m_id'];
                $res = M('sales_receipts', C('DB_PREFIX'), 'DB_CUSTOM')->add($data);
                if ($res) {
                    $this->writeVoucherLog(array(
                        'sr_id' => $res,
                        'srml_type' => '0',
                        'srml_uid' => '0',
                        'srml_change' => json_encode($data),
                        'srml_create_time' => date("Y-m-d H:i:s")
                    ));
                    $this->ajaxReturn(array(
                        'status' => 1,
                        'info' => '添加收款单成功,请等待管理员审核！'
                    ));
                    exit();
                } else {
                    $this->ajaxReturn(array(
                        'status' => 0,
                        'info' => '添加收款单报错！'
                    ));
                    exit();
                }
            } else {
                $this->ajaxReturn(array(
                    'status' => 0,
                    'info' => '此订单已存在销货收款单，无需再次添加！'
                ));
                exit();
            }
        } else {
            $this->ajaxReturn(array(
                'status' => 0,
                'info' => '添加收款单报错！'
            ));
            exit();
        }
    }

    /**
     * 记录审核日志
     * 
     * @author Wangguibin<wangguibin@guanyisoft.com>
     * @date 2013-06-09
     */
    public function writeVoucherLog($params) {
        M('sales_receipts_modify_log', C('DB_PREFIX'), 'DB_CUSTOM')->add($params);
    }

    /**
     * 选择物流公司
     * 
     * @author zhangjiasuo<zhangjiasuo@guanyisoft.com>
     * @date 2013-06-30
     */
    public function ChangeLogistic() {
        $promotion_price = 0;
        $combo_all_price = 0;
        $free_all_price = 0;
        $data = $this->_post();
        $ary_tmp_cart = D('Cart')->GetData();
        if($data['pids']){
            $ary_pid = explode(',',$data['pids']);
            foreach ($ary_tmp_cart as $key=>$cd){
                foreach ($ary_pid as $pid){
                    if($pid == $key){
                        $ary_cart[$pid] = $ary_tmp_cart[$key];
                    }
                }
            }
        }else{
            $ary_cart = $ary_tmp_cart;
        }
        
        $ary_member = session("Members");
        if (!empty($ary_cart) && is_array($ary_cart)) {
            foreach ($ary_cart as &$val) {
                if ($val ['type'] == 0) {
                    $ary_gid = M("goods_products", C('DB_PREFIX'), 'DB_CUSTOM')->field('g_id')->where(array(
                                'pdt_id' => $val ['pdt_id']
                            ))->find();
                    $val ['g_id'] = $ary_gid ['g_id'];
                }
            }
        }
        $ary_tmp_cart = $ary_cart;
        $pro_datas = D('Promotion')->calShopCartPro($ary_member ['m_id'], $ary_cart);
        
        $subtotal = $pro_datas ['subtotal'];
        unset($pro_datas ['subtotal']);
        
        $promotion_total_price = '0';
        $promotion_price = '0';
        //赠品数组
        $cart_gifts = array();
        foreach ($pro_datas as $keys => $vals) {
            foreach ($vals['products'] as $key => $val) {
                $arr_products = $this->cart->getProductInfo(array($key => $val));
                if ($arr_products[0][0]['type'] == '4') {
                    foreach ($arr_products[0] as &$provals) {
                        $provals['authorize'] = D('AuthorizeLine')->isAuthorize($ary_member['m_id'], $provals['g_id']);
                    }
                }
                $pro_datas[$keys]['products'][$key] = $arr_products[0];
                $pro_data[$key] = $val;
                $pro_data[$key]['pmn_name'] = $vals['pmn_name'];
            }
            //赠品数组
            if(!empty($vals['gifts'])){
                foreach($vals['gifts'] as $gifts){
                    //随机取一个pdt_id
                    $pdt_id = D("GoodsProducts")->Search(array('g_id'=>$gifts['g_id'],'pdt_stock'=>array('GT', 0)),'pdt_id');
                    $cart_gifts[$pdt_id['pdt_id']]=array('pdt_id'=>$pdt_id['pdt_id'],'num'=>1,'type'=>2);
                }
            }
            $promotion_total_price += $vals['goods_total_price'];     //商品总价
            if ($keys != '0') {
                $promotion_price += $vals['pro_goods_discount'];
            }
        }
        //获取赠品信息
        if(!empty($cart_gifts)){
            $ary_tmp_cart = array_merge($ary_tmp_cart,$cart_gifts);
            foreach($ary_tmp_cart as $atck=>$atcv){
                $ary_tmp_cart[$atcv['pdt_id']] = $atcv;
                unset($ary_tmp_cart[$atck]);
            }
        }
        // 满足满包邮条件
        foreach ($pro_datas as $pro_data) {
            if ($pro_data ['pmn_class'] == 'MBAOYOU') {
                foreach($pro_data['products'] as $proDatK=>$proDatV){
                    unset($ary_tmp_cart[$proDatK]);
                }
            }
        }
        // 购买货品的总价
        $logistic_price = D('Logistic')->getLogisticPrice($data ['lt_id'], $ary_tmp_cart);
        $logistic_info = D('LogisticCorp')->getLogisticInfo(array('fx_logistic_type.lt_id' => $data ['lt_id']), array('fx_logistic_corp.lc_cash_on_delivery'));
        $ary_return ['status'] = 1;
        $ary_return ['all_price'] = sprintf("%0.2f", $promotion_total_price - $promotion_price);
        $ary_return ['goods_total_sale_price'] = $promotion_total_price;
        $ary_return ['logistic_price'] = $logistic_price;
        $ary_return ['promotion_price'] = sprintf("%0.2f", $promotion_price);
        $ary_return ['logistic_delivery'] = $logistic_info ['lc_cash_on_delivery'];
        $this->ajaxReturn($ary_return);
    }

    /**
     * 计算团购物流费用
     * @author Joe <qianyijun@guanyisoft.com>
     * @date 2013-12-25
     */
    public function checkBulkLogistic() {
        $bulk_cart = $_SESSION['bulk_cart'];
        $groupbuy = M('groupbuy', C('DB_PREFIX'), 'DB_CUSTOM');
        $gp_price = M('related_groupbuy_price', C('DB_PREFIX'), 'DB_CUSTOM');
        $array_where = array('is_active' => 1, 'gp_id' => $bulk_cart ['gp_id']);
        $data = $groupbuy->where($array_where)->find();
        if (empty($data)) {
            $this->error('团购商品不存在！');
        }
        $data['cust_price'] = sprintf("%0.2f", M('goods_info')->where(array('g_id' => $data['g_id']))->getField('g_price') * $bulk_cart['num']);
        // 取出价格阶级
        $rel_bulk_price = $gp_price->where(array('gp_id' => $data['gp_id']))->select();
        $buy_nums = $data ['gp_pre_number'] + $data ['gp_now_number'];
        $data['gp_now_number'] = $buy_nums;
        $array_f = array();
        foreach ($rel_bulk_price as $rbp_k => $rbp_v) {
            if ($buy_nums >= $rbp_v ['rgp_num']) {
                $array_f[$rbp_v['related_price_id']] = $rbp_v['rgp_num'];
            }
        }
        if (!empty($array_f)) {
            $array_max = new ArrayMax($array_f);
            $rgp_num = $array_max->arrayMax();
            $data['gp_price'] = sprintf("%0.2f", $gp_price->where(array('gp_id' => $data['gp_id'], 'rgp_num' => $rgp_num))->getField('rgp_price') * $bulk_cart['num']);
        } else {
            $data['gp_price'] = sprintf("%0.2f", $data['gp_price'] * $bulk_cart['num']);
        }
        $ary_cart[$bulk_cart['pdt_id']] = array('pdt_id' => $bulk_cart['pdt_id'], 'num' => $bulk_cart['num'], 'type' => 5);
        $logistic_price = D('Logistic')->getLogisticPrice($_POST ['lt_id'], $ary_cart);
        $logistic_info = D('LogisticCorp')->getLogisticInfo(array('fx_logistic_type.lt_id' => $_POST['lt_id']), array('fx_logistic_corp.lc_cash_on_delivery'));
        $ary_return['status'] = 1;
        $ary_return['all_price'] = $data['cust_price'];
        $ary_return['logistic_price'] = $logistic_price;
        $ary_return['promotion_price'] = $data['cust_price'] - $data['gp_price'];
        $ary_return['logistic_delivery'] = $logistic_info['lc_cash_on_delivery'];
        $this->ajaxReturn($ary_return);
    }
    
    /**
     * 计算秒杀物流费用
     * @author Joe <qianyijun@guanyisoft.com>
     * @date 2013-12-25
     */
    public function checkSpikeLogistic() {
        $param_spike = $_SESSION ['spike_cart'];
        $spike = M('spike', C('DB_PREFIX'), 'DB_CUSTOM');
        
        $array_where = array(
            'sp_status' => 1,
            'sp_id' => $param_spike ['sp_id']
        );
        $data = $spike->where($array_where)->find();
        if (empty($data)) {
            $this->error('秒杀商品不存在！');
        }
        $data ['cust_price'] = sprintf("%0.2f",M('goods_info')->where(array('g_id' => $data ['g_id']))->getField('g_price')*$param_spike['num']);
        $buy_nums = $data ['sp_now_number'];
        $data ['sp_now_number'] = $buy_nums;
        
        
        $ary_cart[$param_spike['pdt_id']] = array('pdt_id' => $param_spike['pdt_id'], 'num' => $param_spike['num'], 'type' => 7);
        $logistic_price = D('Logistic')->getLogisticPrice($_POST ['lt_id'], $ary_cart);
        $logistic_info = D('LogisticCorp')->getLogisticInfo(array('fx_logistic_type.lt_id' => $_POST['lt_id']), array('fx_logistic_corp.lc_cash_on_delivery'));
        $ary_return['status'] = 1;
        $ary_return['all_price'] = $data['cust_price'];
        $ary_return['logistic_price'] = $logistic_price;
        $ary_return['promotion_price'] = $data['cust_price'] - $data['sp_price'];
        $ary_return['logistic_delivery'] = $logistic_info['lc_cash_on_delivery'];
		$ary_return['sp_price'] = $data['sp_price']; 
        $this->ajaxReturn($ary_return);
    }
    
    /**
     * 计算预售物流费用
     * @author Joe <qianyijun@guanyisoft.com>
     * @date 2013-12-25
     */
    public function checkPresaleLogistic() {
        $param_presale = $_SESSION ['presale_cart'];
        $presale = M('presale', C('DB_PREFIX'), 'DB_CUSTOM');
        $gp_price = M('related_presale_price', C('DB_PREFIX'), 'DB_CUSTOM');
        $gp_city = M('related_presale_area', C('DB_PREFIX'), 'DB_CUSTOM');
        $array_where = array(
            'is_active' => 1,
            'p_id' => $param_presale ['p_id']
        );
        $data = $presale->where($array_where)->find();
        //echo "";print_r($data);die;
        $data ['cust_price'] = M('goods_info')->where(array(
                    'g_id' => $data ['g_id']
                ))->getField('g_price');
        // 取出价格阶级
        $rel_bulk_price = $gp_price->where(array(
                    'p_id' => $data ['p_id']
                ))->select();
        $buy_nums = $data ['p_pre_number'] + $data ['p_now_number'];
        $data ['p_now_number'] = $buy_nums;
        $array_f = array();
        foreach ($rel_bulk_price as $rbp_k => $rbp_v) {
            if ($buy_nums > $rbp_v ['rgp_num']) {
                $array_f [$rbp_v ['related_price_id']] = $rbp_v ['rgp_num'];
            }
        }
        if (!empty($array_f)) {
            $array_max = new ArrayMax($array_f);
            $rgp_num = $array_max->arrayMax();
            $data ['p_price'] = $gp_price->where(array(
                        'p_id' => $data ['p_id'],
                        'rgp_num' => $rgp_num
                    ))->getField('rgp_price');
        }
        
        
        $ary_cart[$param_presale['pdt_id']] = array('pdt_id' => $param_presale['pdt_id'], 'num' => $param_presale['num'], 'type' => 8);
        $logistic_price = D('Logistic')->getLogisticPrice($_POST ['lt_id'], $ary_cart);

        $logistic_info = D('LogisticCorp')->getLogisticInfo(array('fx_logistic_type.lt_id' => $_POST['lt_id']), array('fx_logistic_corp.lc_cash_on_delivery'));
        $ary_return['status'] = 1;
        $ary_return['all_price'] = $data['cust_price'];
        $ary_return['logistic_price'] = $logistic_price;
        $ary_return['promotion_price'] = $data['cust_price'] - $data['p_price'];
        $ary_return['logistic_delivery'] = $logistic_info['lc_cash_on_delivery'];
        $this->ajaxReturn($ary_return);
    }
    
    public function getBulkLogisticType(){
        $bulk_cart = $_SESSION['bulk_cart'];
        $ary_cart[$bulk_cart['pdt_id']] = array('pdt_id' => $bulk_cart['pdt_id'], 'num' => $bulk_cart['num'], 'type' => 5);
        $ra_id = $this->_post('ra_id');
        $cr_id = $this->_post('cr_id');
        $ary_logistic = $this->logistic->getLogistic($cr_id,$ary_cart);
        if (!empty($ary_logistic) && is_array($ary_logistic)) {
            foreach ($ary_logistic as $k1 => $v1) {
                $ary_logistic [$k1] ['logistic_price'] = $v1 ['logistic_price'] - $p_logistic;
                if ($ary_logistic [$k1] ['logistic_price'] < 0) {
                    $ary_logistic [$k1] ['logistic_price'] = 0;
                }
            }
        }
        $this->assign('ary_logistic', $ary_logistic);
        $this->display();
    }
    
    public function getPresaleLogisticType(){
        $param_presale = $_SESSION ['presale_cart'];
        $ra_id = $this->_post('ra_id');
        $cr_id = $this->_post('cr_id');
        $ary_cart[$param_presale['pdt_id']] = array('pdt_id' => $param_presale['pdt_id'], 'num' => $param_presale['num'], 'type' => 8);
        $ary_logistic = $this->logistic->getLogistic($cr_id,$ary_cart);
        if (!empty($ary_logistic) && is_array($ary_logistic)) {
            foreach ($ary_logistic as $k1 => $v1) {
                $ary_logistic [$k1] ['logistic_price'] = $v1 ['logistic_price'] - $p_logistic;
                if ($ary_logistic [$k1] ['logistic_price'] < 0) {
                    $ary_logistic [$k1] ['logistic_price'] = 0;
                }
            }
        }
        $this->assign('ary_logistic', $ary_logistic);
        $this->display();
    }
    
    public function getSpikeLogisticType(){
        $param_spike = $_SESSION ['spike_cart'];
        $ra_id = $this->_post('ra_id');
        $cr_id = $this->_post('cr_id');
        $ary_cart[$param_spike['pdt_id']] = array('pdt_id' => $param_spike['pdt_id'], 'num' => $param_spike['num'], 'type' => 7);
        $ary_logistic = $this->logistic->getLogistic($cr_id,$ary_cart);
        
        if (!empty($ary_logistic) && is_array($ary_logistic)) {
            foreach ($ary_logistic as $k1 => $v1) {
                $ary_logistic [$k1] ['logistic_price'] = $v1 ['logistic_price'] - $p_logistic;
                if ($ary_logistic [$k1] ['logistic_price'] < 0) {
                    $ary_logistic [$k1] ['logistic_price'] = 0;
                }
            }
        }
        $this->assign('ary_logistic', $ary_logistic);
        $this->display();
    }

    /**
     * 订单确认完成操作
     * 
     * @author zhangjiasuo <zhangjiasuo@guanyisoft.com>
     * @date 2013-07-30
     */
    public function OrderFinish() {
        $this->getSubNav(1, 1, 40);
        $ary_data = $this->_param();
        $status = 4;
        D(Orders)->UpdateOrderStatus($ary_data ['oid'], $status);
        $this->redirect(U('Ucenter/Orders/pageShow', array(
            'oid' => $ary_data ['oid']
        )));
    }

    /**
     * 查询物流跟踪信息
     */
    public function getOrdersPostTrack() {
        if (!isset($_POST ["od_id"]) || "" == $_POST ["od_id"]) {
            echo "系统集成出错：非法的发货单ID参数传入。";
            exit();
        }

        // 获取订单的物流单信息
        $array_info = D("OrdersDelivery")->where(array(
                    "od_id" => $_POST ["od_id"]
                ))->find();
        if (!is_array($array_info) || empty($array_info)) {
            echo "发货单ID错误或者发货单不存在。";
            exit();
        }

        // 根据物流公司ID获取物流公司对应的快递100的物流公司代码
        $kuaidi100_code = D("LogisticCorp")->where(array(
                    "lc_id" => $array_info ["od_logi_id"]
                ))->getField("lc_kuaidi100_name");
        if (false === $kuaidi100_code || "" == $kuaidi100_code) {
            echo "快递100物流公司代码未设置。";
            exit();
        }

        // 调用快递100接口获取物流跟踪数据
        $kuaidi100_obj = new Kuaidi100 ();
        $result = $kuaidi100_obj->queryDeliveryTrack($kuaidi100_code, $array_info ["od_logi_no"]);
        if (true == $result ["status"] && !isset($result ["data"] ["data"])) {
            $result ["data"] ["data"] = array();
        }

        krsort($result ["data"] ["data"]);
        $this->assign("post_track_info", $result ["data"] ["data"]);
        $this->assign("delivery_info", $array_info);
        $this->display("post_track");
    }

    /**
     * 确认收货
     * 
     * @author Terry<wanghui@guanyisoft.com>
     * @date 2013-08-09
     */
    public function Receive() {
        $ary_get = $this->_get();
        $ary_order = D("Orders")->join(" " . C('DB_PREFIX') . "payment_cfg ON " . C('DB_PREFIX') . "payment_cfg.pc_id=" . C('DB_PREFIX') . "orders.o_payment")->where(array(
                    "o_id" => $ary_get ['oid']
                ))->find();

        if (!empty($ary_order ['pc_abbreviation']) && $ary_order ['pc_abbreviation'] == 'ALIPAY') {

            $ary_gateway = M('payment_serial', C('DB_PREFIX'), 'DB_CUSTOM')->where(array(
                        'pc_code' => $ary_order ['pc_abbreviation'],
                        'o_id' => $ary_order ['o_id'],
                        'ps_status_sn' => 'WAIT_SELLER_SEND_GOODS'
                    ))->find();

            if (!empty($ary_gateway) && is_array($ary_gateway)) {
                Header("Location: https://lab.alipay.com/consume/queryDetailFromPay.htm?trade_no=" . $ary_gateway ['ps_gateway_sn']);
                exit();
            } else {
                $this->error("无需确认收货……", 3, U("Ucenter/Orders/pageList"));
            }
        }
    }

    /**
     * 订单立即评价
     * 
     * @author Terry<wanghui@guanyisoft.com>
     * @date 2013-08-09
     */
    public function addMemberEvaluate() {
        $int_o_id = $this->_get('oid');
        $field = array(
            'fx_orders.o_id',
            'fx_orders_items.oi_id',
            'fx_orders.o_status',
            'fx_orders.o_all_price',
            'fx_orders.o_create_time',
            'fx_orders.o_goods_all_price',
            'fx_orders.o_pay_status',
            'fx_orders.o_receiver_name',
            'fx_orders.o_receiver_state',
            'fx_orders.o_receiver_city',
            'fx_orders.o_receiver_county',
            'fx_orders.o_discount',
            'fx_orders.o_receiver_address',
            'fx_orders.o_receiver_telphone',
            'fx_orders.o_receiver_mobile',
            'fx_orders.o_receiver_email',
            'fx_orders.o_coupon_menoy',
            'fx_orders.o_buyer_comments',
            'fx_orders.o_payment',
            'fx_orders.lt_id',
            'fx_orders.ra_id',
            'fx_orders.o_reward_point',
            'fx_orders.o_freeze_point',
            'fx_orders.o_cost_freight',
            'fx_orders.o_receiver_time',
            'fx_orders_items.pdt_id',
            'fx_orders_items.g_id',
            'fx_orders_items.g_sn',
            'fx_orders_items.oi_g_name',
            'fx_orders_items.oi_score',
            'fx_orders_items.oi_nums',
            'fx_orders_items.oi_type',
            'fx_orders_items.oi_price',
            'fx_orders_items.pdt_sale_price',
            'fx_orders_items.pdt_sn',
            'fx_members.m_balance'
        );
        $where = array(
            'fx_orders.o_id' => $int_o_id,
            'fx_members.m_id' => $_SESSION ['Members'] ['m_id']
        );
        $ary_orders_info = D('Orders')->getOrdersData($where, $field);
        // echo "<pre>";print_r(D('Orders')->getLastSql());exit;
        // 订单详情商品
        if (!empty($ary_orders_info) && is_array($ary_orders_info)) {
            $combo_price_total = 0;
            foreach ($ary_orders_info as $k => $v) {
                $ary_orders_info [$k] ['pdt_spec'] = D("GoodsSpec")->getProductsSpec($v ['pdt_id']);

                $ary_goods_pic = M('goods_info', C('DB_PREFIX'), 'DB_CUSTOM')->where(array(
                            'g_id' => $v ['g_id']
                        ))->field('g_picture')->find();

                $ary_orders_info [$k] ['g_picture'] = getFullPictureWebPath($ary_goods_pic ['g_picture']);
                // 订单商品退款、退货状态
                $ary_orders_info [$k] ['str_refund_status'] = $this->orders->getOrderItmesStauts('oi_refund_status', $v);
                // 订单商品发货

                $ary_orders_info [$k] ['str_ship_status'] = $this->orders->getOrderItmesStauts('oi_ship_status', $v);
                if ($v ['oi_type'] == 3) {
                    $combo_sn = $v ['pdt_sn'];
                    $tmp_ary = array(
                        'g_sn' => $ary_orders_info [$k] ['g_sn'],
                        'pdt_spec' => $ary_orders_info [$k] ['pdt_spec'],
                        'g_picture' => $ary_orders_info [$k] ['g_picture'],
                        'oi_g_name' => $ary_orders_info [$k] ['oi_g_name'],
                        'pdt_id' => $ary_orders_info [$k] ['pdt_id']
                    );

                    $combo_pdt_gid = D('GoodsProducts')->Search(array(
                        'pdt_sn' => $v ['pdt_sn']
                            ), array(
                        'g_id'
                            ));
                    $combo_where = array(
                        'g_id' => $combo_pdt_gid ['g_id'],
                        'releted_pdt_id' => $ary_orders_info [$k] ['pdt_id']
                    );
                    $combo_field = array(
                        'com_nums',
                        'com_price'
                    );
                    $combo_res = D('ReletedCombinationGoods')->getComboReletedList($combo_where, $combo_field);
                    $combo_num = $combo_res [0] ['com_nums'];
                    $combo_price_total += sprintf("%0.3f", $combo_res [0] ['com_nums'] * $combo_res [0] ['com_price']);

                    $ary_combo [$combo_sn] ['item'] [$k] = $tmp_ary;
                    $ary_combo [$combo_sn] ['num'] = $ary_orders_info [$k] ['oi_nums'] / $combo_num;
                    $ary_combo [$combo_sn] ['pdt_sale_price'] = $ary_orders_info [$k] ['pdt_sale_price'];
                    $ary_combo [$combo_sn] ['o_all_price'] = sprintf("%0.3f", $combo_price_total * $ary_combo [$combo_sn] ['num']);
                    $ary_combo [$combo_sn] ['str_ship_status'] = $ary_orders_info [$k] ['str_ship_status'];
                    $ary_combo [$combo_sn] ['str_refund_status'] = $ary_orders_info [$k] ['str_refund_status'];
                    unset($ary_orders_info [$k]);
                }
            }
        }
        $this->assign('orders_goods_info', $ary_orders_info);
        $this->assign("oid", $int_o_id);
        $this->display();
    }

    /**
     * 添加会员评论
     * 
     * @author Terry<wanghui@guanyisoft.com>
     * @date 2013-08-09
     */
    public function addComment() {
        $ary_post = $this->_post();
        // echo "<pre>";print_r($ary_post);exit;
        if (!empty($ary_post ['anony']) && $ary_post ['anony'] == '1') {
            $anony = '0';
            $gcom_contacts = '暂无';
			$gcom_mbname = '匿名';
        } else {
            $anony = $_SESSION ['Members'] ['m_id'];
            $gcom_contacts = $_SESSION ['Members'] ['m_email'];
            $gcom_mbname = $_SESSION['Members']['m_name'];
        }
        $module = M('goods_comments', C('DB_PREFIX'), 'DB_CUSTOM');
        $module->startTrans();
        if (!empty($ary_post ['goods']) && is_array($ary_post ['goods'])) {
            $msg_comments = true;
            $res = true;
            foreach ($ary_post ['goods'] as $keygoods => $valgoods) {
                if (!empty($valgoods ['comment'])) {
                    $data = array(
                        'm_id' => $anony,
                        'g_id' => $keygoods,
                        'gcom_title' => $valgoods ['g_name'],
                        'gcom_content' => $valgoods ['comment'],
                        'gcom_mbname'=>$gcom_mbname,
                        'gcom_email' => $gcom_contacts,
                        'gcom_star_score' => $valgoods ['gcom_star_score'],
                        'gcom_create_time'=>date('Y-m-d H:i:s'),
                        'gcom_ip_address' => $_SERVER['SERVER_ADDR']
                    );
                    
                    $arr_res = $module->add($data);
                    if (!$arr_res) {
                        $res = false;
                        $module->rollback();
                        $this->error('评论失败，请重试...');
                        exit();
                    }
                } else {
                    $msg_comments = false;
                }
            }
            if (FALSE === $msg_comments) {
                $this->error("评论内容显示为空，请重新输入...");
            }
            if ($res) {
                $ary_result = M('Orders', C('DB_PREFIX'), 'DB_CUSTOM')->where(array(
                            'o_id' => $ary_post ['oid']
                        ))->data(array(
                            'is_evaluate' => '1'
                        ))->save();
                if (!$ary_result) {
                    $module->rollback();
                    $this->error("更新订单信息失败，请重试...");
                    exit();
                }
            }
            $module->commit();
            $this->success("评论成功", U("Ucenter/Orders/pageList", 3));
        } else {
            $this->error("评论内容不能为空");
        }
    }

    /**
     * 订单确认收货
     * 
     * @author Terry<wanghui@guanyisoft.com>
     * @date 2013-08-12
     */
    public function OrderConfirmation() {
        $ary_get = $this->_get();
        $ary_orders_status = $this->orders->getOrdersStatus($ary_get['oid']);
        if ($ary_orders_status['deliver_status'] != '已发货') {
            $this->error("订单" . $ary_get['oid'] . "未发货");
        }
        $ary_order = M('Orders', C('DB_PREFIX'), 'DB_CUSTOM')->where(array('o_id' => $ary_get ['oid']))->find();
        if (!empty($ary_order) && is_array($ary_order)) {
            M('', '', 'DB_CUSTOM')->startTrans();
            $ary_result = M('Orders', C('DB_PREFIX'), 'DB_CUSTOM')->where(array(
                        'o_id' => $ary_order ['o_id']
                    ))->data(array(
                        'o_status' => '5'
                    ))->save();
            if (FALSE !== $ary_result) {
                /*                 * ** 处理订单积分****start****By Joe***** */
                $array_point_config = D('PointConfig')->getConfigs();
                if ($array_point_config ['is_consumed'] == '1' && $array_point_config['cinsumed_channel'] == '1') {
                    // 确认收货后处理赠送积分
                    if ($ary_order['o_reward_point'] > 0) {
                        $ary_reward_result = D('PointConfig')->setMemberRewardPoint($ary_order['o_reward_point'], $ary_order ['m_id']);
                        if (!$ary_reward_result ['result']) {
                            M('', '', 'DB_CUSTOM')->rollback();
                            $this->error($ary_reward_result['message']);
                            exit();
                        }
                    }

                    // 确认收货后处理消费积分
                    if ($ary_order ['o_freeze_point'] > 0) {
                        $ary_freeze_result = D('PointConfig')->setMemberFreezePoint($ary_order['o_reward_point'], $ary_order ['m_id']);
                        if (!$ary_freeze_result['result']) {
                            M('', '', 'DB_CUSTOM')->rollback();
                            $this->error($ary_freeze_result['message']);
                            exit();
                        }
                    }
                }
                /*                 * ** 处理订单积分****end********* */

                /*                 * * 订单发货后获取订单优惠券**star by Joe* */
                //获取优惠券节点
                $coupon_config = D('SysConfig')->getCfgByModule('GET_COUPON');
                $where = array('fx_orders.o_id' => $ary_get['oid']);
                $ary_field = array('fx_orders.o_pay', 'fx_orders.o_all_price', 'fx_orders.coupon_sn', 'fx_orders_items.pdt_id', 'fx_orders_items.oi_nums', 'fx_orders_items.oi_type');
                $ary_orders = D('Orders')->getOrdersData($where, $ary_field);
                // 本次消费金额=支付单最后一次消费记录
                $payment_serial = M('payment_serial')->where(array('o_id' => $ary_get['oid']))->order('ps_create_time desc')->select();
                $payment_price = $payment_serial[0]['ps_money'];
                $all_price = $ary_orders[0]['o_all_price'];
                $coupon_sn = $ary_orders[0]['coupon_sn'];
                if ($coupon_sn == "" && $coupon_config['GET_COUPON_SET'] == '2') {
                    D('Coupon')->setPoinGetCoupon($ary_orders, $ary_order['m_id']);
                }
                /*                 * * 订单发货后获取订单优惠券****end********* */

                M('', '', 'DB_CUSTOM')->commit();
                $this->success("确认收货成功,请对商品进行评价");
            } else {
                M('', '', 'DB_CUSTOM')->rollback();
                $this->error("订单 " . $ary_get ['oid'] . " 确认收货失败，请重试...");
            }
        } else {
            $this->error("订单 " . $ary_get ['oid'] . " 不存在");
        }
    }
    
     /**
     * 预售订单确认页面
     */
    public function pagePresaleAdd() {
        $param_presale = $_SESSION ['presale_cart'];
        if (empty($param_presale)) {
            $this->error('请选择预售商品！');
        }
        $presale = M('presale', C('DB_PREFIX'), 'DB_CUSTOM');
        $gp_price = M('related_presale_price', C('DB_PREFIX'), 'DB_CUSTOM');
        $gp_city = M('related_presale_area', C('DB_PREFIX'), 'DB_CUSTOM');
        $ary_data = array();
        // 获取常用收货地址
        $ary_addr = $this->cityRegion->getReceivingAddress($_SESSION ['Members'] ['m_id']);
        if (count($ary_addr) > 0) {
            $ary_data ['default_addr'] = $ary_addr [0];
            unset($ary_addr [0]);
        }
        $ary_data ['ary_addr'] = $ary_addr;
        // 获取支付方式
        $payment = D('PaymentCfg');
        $payment_cfg = $payment->getPayCfg();
        $ary_data ['payment_cfg'] = $payment_cfg;
        // 发票信息
        $p_invoice = D('Invoice')->get();

        $invoice_type = explode(",", $p_invoice ['invoice_type']);
        $invoice_head = explode(",", $p_invoice ['invoice_head']);
        $invoice_content = explode(",", $p_invoice ['invoice_content']);

        $invoice_info ['invoice_comom'] = $invoice_type [0];
        $invoice_info ['invoice_special'] = $invoice_type [1];

        $invoice_info ['invoice_personal'] = $invoice_head [0];
        $invoice_info ['invoice_unit'] = $invoice_head [1];
        $invoice_info ['is_invoice'] = $p_invoice ['is_invoice'];
        $invoice_info ['is_auto_verify'] = $p_invoice ['is_auto_verify'];
        // 发票收藏列表
        $invoice_list = D('InvoiceCollect')->get($_SESSION ['Members'] ['m_id']);
        
        $array_where = array(
            'is_active' => 1,
            'p_id' => $param_presale ['p_id']
        );
        $data = $presale->where($array_where)->find();
        //echo "<pre>";print_r($invoice_info);die;
        if (empty($data)) {
            $this->error('预售商品不存在！');
        }
        $data ['cust_price'] = M('goods_info')->where(array(
                    'g_id' => $data ['g_id']
                ))->getField('g_price');
        // 取出价格阶级
        $rel_bulk_price = $gp_price->where(array(
                    'p_id' => $data ['p_id']
                ))->select();
        $buy_nums = $data ['p_pre_number'] + $data ['p_now_number'];
        $data ['p_now_number'] = $buy_nums;
        $array_f = array();
        foreach ($rel_bulk_price as $rbp_k => $rbp_v) {
            if ($buy_nums > $rbp_v ['rgp_num']) {
                $array_f [$rbp_v ['related_price_id']] = $rbp_v ['rgp_num'];
            }
        }
        if (!empty($array_f)) {
            $array_max = new ArrayMax($array_f);
            $rgp_num = $array_max->arrayMax();
            $data ['p_price'] = $gp_price->where(array(
                        'p_id' => $data ['p_id'],
                        'rgp_num' => $rgp_num
                    ))->getField('rgp_price');
        }
        // 获取商品基本信息
        $field = 'g_id as gid,g_name as gname,g_price as gprice,g_stock as gstock,g_picture as gpic';
        $goods_info = D('GoodsInfo')->field($field)->where(array(
                    'g_id' => $data ['g_id']
                ))->find();
        $goods_info ['gpic'] = '/' . ltrim($goods_info ['gpic'], '/');
        $goods_info ['save_price'] = $goods_info ['gprice'] - $data ['p_price'];
        // 授权线判断是否允许购买
        $goods_info ['authorize'] = true;
        if (!empty($goods_info) && is_array($goods_info)) {
            $ary_product_feild = array(
                'pdt_sn',
                'pdt_weight',
                'pdt_stock',
                'pdt_memo',
                'pdt_id',
                'pdt_sale_price',
                'pdt_market_price',
                'pdt_on_way_stock'
            );
            $where = array();
            $where ['g_id'] = $data ['g_id'];
            $where ['pdt_status'] = '1';
            $ary_pdt = M('goods_products ', C('DB_PREFIX'), 'DB_CUSTOM')->field($ary_product_feild)->where($where)->limit()->select();
            if (!empty($ary_pdt) && is_array($ary_pdt)) {
                $skus = array();
                $ary_zhgoods = array();
                foreach ($ary_pdt as $kypdt => $valpdt) {
                    $specInfo = D('GoodsSpec')->getProductsSpecs($valpdt ['pdt_id']);

                    $ary_pdt [$kypdt] ['specName'] = $specInfo ['spec_name'];

                    $ary_pdt [$kypdt] ['pdt_sale_price'] = sprintf('%.2f', $valpdt ['pdt_sale_price']);
                    $ary_pdt [$kypdt] ['pdt_market_price'] = sprintf('%.2f', $valpdt ['pdt_market_price']);
                    if ($param_presale ['pdt_id'] == $valpdt ['pdt_id']) {
                        $data ['sku'] = $ary_pdt [$kypdt];
                    }
                }
            }
        }
        $goods_info ['skus'] = $ary_pdt;
        $data ['sku'] ['num'] = $param_presale ['num'];
        $data ['sku'] ['coupon_price'] = $data ['sku'] ['pdt_sale_price'] - $data ['p_price'];
        $data ['sku'] ['all_cprice'] = $data ['sku'] ['coupon_price'] * $param_presale ['num'];
        $data ['sku'] ['all_price'] = $data ['p_price'] * $param_presale ['num'];
        $data ['sku'] ['all_sale_price'] = $data ['sku'] ['pdt_sale_price'] * $param_presale ['num'];
        $data ['sku'] ['all_weight'] = $data ['sku'] ['pdt_weight'] * $param_presale ['num'];
        //是否启用定金
        if ($data ['is_deposit'] == 1) {
            $data ['p_deposit_price'] = sprintf('%.2f', $data ['p_deposit_price'] * $data ['sku'] ['num']);
        }
        $ary_cart [$data ['sku'] ['pdt_id']] = array(
                    'pdt_id' => $data ['sku'] ['pdt_id'],
                    'num' => $data ['sku'] ['num'],
                    'type' => 0,
                    'g_id'=>$data['g_id'],
                );
        // 获取配送公司表
        if (!empty($ary_data ['default_addr']) && is_array($ary_data ['default_addr'])) {
            $ra_is_default = $ary_data ['default_addr'] ['ra_is_default'];
            if ($ra_is_default == 1) {
                $cr_id = $ary_data ['default_addr'] ['cr_id'];
                $ary_logistic = $this->logistic->getLogistic($cr_id,$ary_cart);
            }
        }

        $data ['sku'] ['presale_price'] = $data ['sku'] ['all_price'];
        $data ['sku'] ['all_price'] += $logistic_price;
         //echo "<pre>";print_r($data);exit;
        $this->assign('product_data', $data);
        $this->assign('ary_addr', $ary_data ['ary_addr']);
        $this->assign('default_addr', $ary_data ['default_addr']);
        // 支付方式
        $this->assign('ary_paymentcfg', $ary_data ['payment_cfg']);
        // 配送公司
        $this->assign('ary_logistic', $ary_logistic);
        // 发票收藏列表
        $this->assign('invoice_list', $invoice_list);
        // 发票信息
        $this->assign('invoice_info', $invoice_info);
        $this->assign('invoice_content', $invoice_content);
        $this->display();
    }
    
    
    public function pageSpikeAdd() {
        $param_spike = $_SESSION ['spike_cart'];
        $ary_member = $_SESSION['Members'];
        if (empty($param_spike)) {
            $this->error('请选择秒杀商品！');
        }
        $spike = M('spike', C('DB_PREFIX'), 'DB_CUSTOM');
        $gp_price = M('related_groupbuy_price', C('DB_PREFIX'), 'DB_CUSTOM');
        $gp_city = M('related_groupbuy_area', C('DB_PREFIX'), 'DB_CUSTOM');
        $ary_data = array();
        // 获取常用收货地址
        $ary_addr = $this->cityRegion->getReceivingAddress($_SESSION ['Members'] ['m_id']);
        if (count($ary_addr) > 0) {
            $ary_data ['default_addr'] = $ary_addr [0];
            unset($ary_addr [0]);
        }
        $ary_data ['ary_addr'] = $ary_addr;
        // 获取支付方式
        $payment = D('PaymentCfg');
        $payment_cfg = $payment->getPayCfg();
        $ary_data ['payment_cfg'] = $payment_cfg;
        // 发票信息
        $p_invoice = D('Invoice')->get();
        $invoice_type = explode(",", $p_invoice ['invoice_type']);
        $invoice_head = explode(",", $p_invoice ['invoice_head']);
        $invoice_content = explode(",", $p_invoice ['invoice_content']);

        $invoice_info ['invoice_comom'] = $invoice_type [0];
        $invoice_info ['invoice_special'] = $invoice_type [1];

        $invoice_info ['invoice_personal'] = $invoice_head [0];
        $invoice_info ['invoice_unit'] = $invoice_head [1];
        $invoice_info ['is_invoice'] = $p_invoice ['is_invoice'];
        $invoice_info ['is_auto_verify'] = $p_invoice ['is_auto_verify'];
        // 发票收藏列表
        $invoice_list = D('InvoiceCollect')->get($ary_member ['m_id']);
        $array_where = array(
            'sp_status' => 1,
            'sp_id' => $param_spike ['sp_id']
        );
        $data = $spike->where($array_where)->find();
        if (empty($data)) {
            $this->error('秒杀商品不存在！');
        }
        $data ['cust_price'] = M('goods_info')->where(array(
                    'g_id' => $data ['g_id']
                ))->getField('g_price');
        $buy_nums = $data ['sp_now_number'];
        $data ['sp_now_number'] = $buy_nums;
        $array_f = array();
        foreach ($rel_bulk_price as $rbp_k => $rbp_v) {
            if ($buy_nums > $rbp_v ['rgp_num']) {
                $array_f [$rbp_v ['related_price_id']] = $rbp_v ['rgp_num'];
            }
        }
        if (!empty($array_f)) {
            $array_max = new ArrayMax($array_f);
            $rgp_num = $array_max->arrayMax();
            $data ['gp_price'] = $gp_price->where(array(
                        'gp_id' => $data ['gp_id'],
                        'rgp_num' => $rgp_num
                    ))->getField('rgp_price');
        }
        // 获取商品基本信息
        $field = 'g_id as gid,g_name as gname,g_price as gprice,g_stock as gstock,g_picture as gpic';
        $goods_info = D('GoodsInfo')->field($field)->where(array(
                    'g_id' => $data ['g_id']
                ))->find();
        $goods_info ['gpic'] = '/' . ltrim($goods_info ['gpic'], '/');
        $goods_info ['save_price'] = $goods_info ['gprice'] - $data ['gp_price'];
        // 授权线判断是否允许购买
        $goods_info ['authorize'] = true;
        if (!empty($goods_info) && is_array($goods_info)) {
            $ary_product_feild = array(
                'pdt_sn',
                'pdt_weight',
                'pdt_stock',
                'pdt_memo',
                'pdt_id',
                'pdt_sale_price',
                'pdt_market_price',
                'pdt_on_way_stock'
            );
            $where = array();
            $where ['g_id'] = $data ['g_id'];
            $where ['pdt_status'] = '1';
            $ary_pdt = M('goods_products ', C('DB_PREFIX'), 'DB_CUSTOM')->field($ary_product_feild)->where($where)->limit()->select();
            if (!empty($ary_pdt) && is_array($ary_pdt)) {
                $skus = array();
                $ary_zhgoods = array();
                foreach ($ary_pdt as $kypdt => $valpdt) {
                    $specInfo = D('GoodsSpec')->getProductsSpecs($valpdt ['pdt_id']);

                    $ary_pdt [$kypdt] ['specName'] = $specInfo ['spec_name'];

                    $ary_pdt [$kypdt] ['pdt_sale_price'] = sprintf('%.2f', $valpdt ['pdt_sale_price']);
                    $ary_pdt [$kypdt] ['pdt_market_price'] = sprintf('%.2f', $valpdt ['pdt_market_price']);
                    if ($param_spike ['pdt_id'] == $valpdt ['pdt_id']) {
                        $data ['sku'] = $ary_pdt [$kypdt];
                    }
                }
                foreach ($skus as $key => &$sku) {
                    $skus [$key] = array_unique($sku);
                }
            }
            if (!empty($skus)) {
                $goods_info ['skuNames'] = $skus;
            } else {
                $goods_info ['pdt_id'] = $ary_pdt [0] ['pdt_id'];
            }
        }
        $goods_info ['skus'] = $ary_pdt;

        $data ['sku'] ['num'] = $param_spike ['num'];
        $data ['sku'] ['coupon_price'] = $data ['sku'] ['pdt_sale_price'] - $data ['sp_price'];
        $data ['sku'] ['all_cprice'] = $data ['sku'] ['coupon_price'] * $param_spike ['num'];
        $data ['sku'] ['all_price'] = $data ['sp_price'] * $param_spike ['num'];
        $data ['sku'] ['all_sale_price'] = $data ['sku'] ['pdt_sale_price'] * $param_spike ['num'];

        $data ['sku'] ['all_weight'] = $data ['sku'] ['pdt_weight'] * $param_spike ['num'];

        $data ['good_info'] = $goods_info;

        $i = 0;
        foreach ($ary_logistic as $logustic_key => $logustic_val) {
            if ($i == 0) {
                $ary_cart [$data ['sku'] ['pdt_id']] = array(
                    'pdt_id' => $data ['sku'] ['pdt_id'],
                    'num' => $data ['sku'] ['num'],
                    'type' => 0
                );
                $logistic_price = D('Logistic')->getLogisticPrice($logustic_val ['lt_id'], $ary_cart);
            }
            $i ++;
        }
        $ary_cart [$data ['sku'] ['pdt_id']] = array(
                    'pdt_id' => $data ['sku'] ['pdt_id'],
                    'num' => $data ['sku'] ['num'],
                    'type' => 0,
                    'g_id'=>$data['g_id'],
                );
        // 获取配送公司表
        if (!empty($ary_data ['default_addr']) && is_array($ary_data ['default_addr'])) {
            $ra_is_default = $ary_data ['default_addr'] ['ra_is_default'];
            if ($ra_is_default == 1) {
                $cr_id = $ary_data ['default_addr'] ['cr_id'];
                $ary_logistic = $this->logistic->getLogistic($cr_id,$ary_cart);
            }
        }
        $data ['sku'] ['bulk_price'] = $data ['sku'] ['all_price'];
        $data ['sku'] ['all_price'] += $logistic_price;
//		 echo "<pre>";print_r($data);exit;
        $this->assign('product_data', $data);
        $this->assign('ary_addr', $ary_data ['ary_addr']);
        $this->assign('default_addr', $ary_data ['default_addr']);
        // 支付方式
        $this->assign('ary_paymentcfg', $ary_data ['payment_cfg']);
        // 配送公司
        $this->assign('ary_logistic', $ary_logistic);
        // 发票收藏列表
        $this->assign('invoice_list', $invoice_list);
        // 发票信息
        $this->assign('invoice_info', $invoice_info);
        $this->assign('invoice_content', $invoice_content);
        /*标明这个是秒杀确认页*/
        $this->assign ( 'web_type', 'Spike' );
        $this->display();
    }


}