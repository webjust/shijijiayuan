<script type="text/javascript" charset="utf-8">
    window.UEDITOR_HOME_URL = "__PUBLIC__/Lib/ueditor/";
</script>
<script type="text/javascript" charset="utf-8" src="__PUBLIC__/Lib/ueditor/editor_config.js"></script>
<script type="text/javascript" charset="utf-8" src="__PUBLIC__/Lib/ueditor/editor_all.js"></script>
<div class="rightInner">
    <form id="coupon_add" enctype="multipart/form-data" name="coupon_add" method="post" action="{:U('Admin/Try/doEdit')}" onsubmit="return save();">
        <table class="tbForm" width="100%" id="wrap">
            <thead>
                <tr class="title">
                    <th colspan="99">修改试用活动</th>
                </tr>
            </thead>
            <tbody>
            	<tr>
					<td  colspan="3" style="text-align:left;padding-left:100px;">
						分类：
						<select name="search_cats" class="related_goods_form_info medium" >
							<option value="0"> -请选择- </option>
							<volist name="array_category" id="cat">
							<option value="{$cat.gc_id}"><php>for($j=0;$j<$cat['gc_level'];$j++){echo '--';}</php>{$cat.gc_name}</option>
							</volist>
						</select>
						品牌：
						<select name="search_brand" class="related_goods_form_info medium">
							<option value="0"> -请选择- </option>
							<volist name="array_brand" id="vo">
								<option value="{$vo.gb_id}">{$vo.gb_name}</option>
							</volist>
						</select>
						关键词：
						<input type="text" name="keywords" class="related_goods_form_info medium" id="search_keywords" value="" />
						<button type="button" id="related_goods_form_search_info" class="btnA">搜索</button>
					</td>
				</tr>
                <tr>
                    <td class="first">* 试用标题</td>
                    <td>
                    	<textarea  name="try_title" id="try_title"  maxlength="250" style="width:300px;height:100px;text-align:left;vertical-align:top;" validate="{ required:true}">{$info['try_title']}</textarea>
                    </td>
                    <td class="last">限制250个字符</td>
                </tr>
                <tr>
                    <td class="first">* 试用商品</td>
                    <td>
                    <input type="hidden" value="1" id="good_type"/>
                    <input type="hidden" value="" id="item_price" /> 
                        <select name="g_id" id="g_related_goods_ids_selected_info" onchange="showPic()" validate="{ required:true}">
                        	<option value="{$info.g_id}" selected >{$info.g_name}</option>	
                        </select>
                    </td>
                    <td class="last">必填</td>
                </tr>
                <tr style="height:50px;">
                    <td class="first">商品图片</td>
                    <td>
                        <a href="javascript:upImage();" class="btnG ico_upload">上传图片</a>
                        <img width="50px" height="50px" src="{$info.try_picture}" id="show_pic">
                        &nbsp;
                        <input type="hidden" id="gp_pic" name="gp_pic" value="{$info.try_picture}"/>
                        <if condition="$info.try_picture neq ''">
                        <a id="delPic" url="{:U('Admin/Home/delLogoPic')}"  style="display:none;" title="暂时隐藏">删除</a>
                        </if>
                    </td>
                    <td class="last">不上传图片按商品主图,建议您图片大小为500*500</td>
                </tr>
				<tr>
					<td class="first">* 试用数量</td>
					<td><input type="text" name="try_num" id="try_num"
						class="medium" validate="{ required:true}" value="{$info.try_num}"/></td>
					<td class="last"></td>
				</tr>
                <tr>
                    <td class="first">* 活动开始时间</td>
                    <td>
                        <input type="text" value="{$info.try_start_time}" name="try_start_time" id="try_start_time" class="medium timer" validate="{ required:true}"/>
                    </td>
                    <td class="last"></td>
                </tr>
                <tr>
                    <td class="first">* 活动结束时间</td>
                    <td>
                        <input type="text" value="{$info.try_end_time}" name="try_end_time" id="try_end_time" class="medium timer" validate="{ required:true}"/>
                    </td>
                    <td class="last"></td>
                </tr>
	
				<tr>
					<td class="first">显示次序</td>
					<td><input type="text" name="try_order" id="try_order"
						class="medium" value="{$info.try_order}"/></td>
					<td class="last"></td>
				</tr>	
	            <tr>
                    <td class="first">是否显示商品详情</td>
                    <td>
                        <input type="checkbox" <if condition="$info.try_is_show_detail eq '1'">checked</if> name="try_is_show_detail" id="try_is_show_detail" value="1" />
                    </td>
                    <td class="last"></td>
                </tr>				
	            <tr>
                    <td class="first">是否启用</td>
                    <td>
                        <input type="checkbox" name="try_status" id="try_status" <if condition="$info.try_status eq '1'">checked</if> value="1" />
                    </td>
                    <td class="last">不勾选代表停用</td>
                </tr>	
				<tr>
                    <td class="first">* 试用报告类型</td>
                    <td>
						<select name="property_typeid">
	                       <option value="0"> -请选择- </option>
							<volist name="ary_type" id="vo">
								<option <if condition="$info['property_typeid'] eq $vo['gt_id']">selected</if> value="{$vo.gt_id}">{$vo.gt_name}</option>
							</volist>					
						</select>

                    </td>
                    <td class="last">填试用报告时的问卷题</td>				
				</tr>
                <tr>
                    <td class="first">试用报告申请类型</td>
                    <td>
                        <select name="property_typeid_front">
                           <option value="0"> -请选择- </option>
                            <volist name="ary_type" id="vo">
                                <option <if condition="$info['property_typeid_front'] eq $vo['gt_id']">selected</if> value="{$vo.gt_id}">{$vo.gt_name}</option>
                            </volist>
                        </select>
                    </td>
                    <td class="last">申请时填的问卷题</td>
                </tr>
 				<tr>
					<td class="first">试用描述</td>
					<td>
					<textarea name="try_desc" id="editor"  style="width:600px;">{$info.try_desc}</textarea>
					</td>
					<td class="last"></td>
				</tr>	 				
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="99">
						<input type="hidden" value="{$info.try_id}" name="try_id" />
                        <input type="submit" value="提 交" class="btnA">
                    </td>
                </tr>
            </tfoot>
        </table>
    </form>
    <div class="clear"></div>
</div>
<script type="text/javascript">
	window.UEDITOR_HOME_URL = "__PUBLIC__/Lib/ueditor/";
</script>
<script type="text/javascript">
	//实例化编辑器
	UE.getEditor('editor');
        window.onload=function(){
        window.UEDITOR_CONFIG.imageUrl = '__APP__/Upload/Image/imageUp';
        window.UEDITOR_CONFIG.fileUrl = '__APP__/Upload/Image/fileUp';
        window.UEDITOR_CONFIG.imagePath = '';
        window.UEDITOR_CONFIG.filePath = ''; 
        UE.getEditor('editor');
    }
    var dialog;
    var editor = new UE.ui.Editor({
        imageRealPath:"editor"
    });
    editor.render("myEditor");
    editor.ready(function(){
        editor.hide()
        dialog = editor.getDialog("insertimage");
        editor.addListener('beforeInsertImage',function(t, arg){
            for(index in arg){
                var image_path = arg[index]['src'];
                $("#gp_pic").val(image_path);
                $("#show_pic").attr({src:image_path});
                
            }
        });
        
    });
    function upImage() {
        dialog.open();
    }
    $("document").ready(function(){

    	$("#related_goods_form_search_info").click(function(){
    		var request_url = "{:U('Admin/Goods/adminSearchGoods')}?";
    		$(".related_goods_form_info").each(function(){
    			request_url += $(this).attr('name') + '=' + encodeURIComponent($(this).val()) + '&';
    		});
    		$.ajax({
    			url:request_url,
    			data:{},
    			success:function(htmlObj){
    				var htmls_options = "<option value='0'>请先下拉选择参与试用活动的商品</option>";
    				for (var x in htmlObj){
    					var goods = htmlObj[x];
    					htmls_options += '<option pic="' + goods.g_picture+ '" ' + 'price="' + goods.g_price+ '" value="' +  goods.g_id + '">' + goods.g_name+',价格：'+ goods.g_price+ '</option>';
    				}
    				$("#g_related_goods_ids_selected_info").html(htmls_options);
    			},
    			type:'GET',
    			timeout:30000,
    			dataType:'json'
    		});
    	});
        
        $('#coupon_add').validate();
        $("#delPic").click(function(){
            var url = $(this).attr("url");
           $.ajax({
               url:url,
               cache:false,
               dataType:'json',
               type:'POST',
               success:function(msgObj){
        		$("#show_pic").css("display","none");	
        		$("#gp_pic").val('');			
               },
               error:function(msgObj){
           		alert('删除失败');		
               }
               });
        });
    });
    
    /**提交表单
     * @author wangguibin <wangguibin@guanyisoft.com>
     * @date 2013-08-26
     */
    function save(){
    	var try_title = $('#try_title').val();
    	if(try_title.length>250 || try_title.length<=0){
			showAlert(false,'试用标题必须输入且不能大与250个字符');
			return false;
    	}
 		var type = $('#good_type').val();
		if(type == '1'){
			var g_id = $('#g_related_goods_ids_selected_info').val();
			if(g_id == '0'){
				showAlert(false,'请先选择商品信息');
				return false;
			}
		}
        var startTime=$("#try_start_time").val(); 
        var endTime=$("#try_end_time").val(); 
        var start=new Date(startTime.replace("-", "/").replace("-", "/"));  
        var end=new Date(endTime.replace("-", "/").replace("-", "/")); 
        if(start > end){
            showAlert(false,'出错了','活动开始时间大于活动实效时间时间！');
            return false;
        }

    	var try_num = parseInt($('#try_num').val());
    	if(isNaN(try_num) || try_num<0){
			showAlert(false,'数量必须输入');
			return false;
    	} 
        var res = $('#coupon_add').valid();
    }

    //显示图片
    function showPic(){
        var pic = $("#g_related_goods_ids_selected_info").find("option:selected").attr('pic');
        $("#item_price").val($("#g_related_goods_ids_selected_info").find("option:selected").attr('price'));
        $("#gp_pic").val(pic); 
    	$("#show_pic").attr("src",pic); 
    }
     
</script>